---
title: "Chronic infections reduce mortality following unrelated secondary infections in Drosophila melanogaster"
author: "Abigail Wukitch, Moria Chambers and Owais Gilani"
date: "6/17/2022"
editor_options:
  chunk_output_type: console
output:
  html_document:
    toc: TRUE
    toc_float: TRUE
    toc_depth: 4
    theme: cerulean
    code_folding: hide
---

# Goal: To determine how chronic infection alters the ability to survive secondary infections of unrelated bacteria

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Ready the workspace
Load all necessary libraries, packages, and data files
```{r ready the workspace, message=FALSE}
library(survival)
library(RColorBrewer)
library(ggplot2)
library(rlang)
library(agricolae)
library(coxme)
library(survminer)
library(olsrr)
library(tidyr)
library(dplyr)
library(Hmisc)
library(qqplotr)
library(ggthemes)
library(fabricatr)
library(gridExtra)
library(grid)
library(kableExtra)
library(sjPlot)
library(cowplot)
library(ggpubr)
library(patchwork)
library(SciViews)

rm(list=ls()) #removes all old variables

#setwd("/Volumes/GoogleDrive/My Drive/Research/Moria Chambers Fruit Flies/061322/Manuscript/")

Sm_Pr = read.csv("Sm_Pr_Figure1.csv")
Ef_Pr = read.csv("Ef_Pr_Figure2.csv")
Ef_bacterial_load = read.csv("Ef bacterial load_Figure3.csv")
Sm_bacterial_load = read.csv("Sm bacterial load_Figure3.csv")

Sm_Ps = read.csv("Sm_Ps_Figure4.csv")
Pr_varied_primary = read.csv("Varied primary Sm_Pr_Figure5.csv")
Ps_varied_primary = read.csv("Varied primary Sm_Ps_Figure5.csv")

```

# Q1 Does the protection conferred by primary infection with *S. marcescens* or *E. faecalis* depend on the infectious dose of the secondary infection with *P. rettgeri*? {.tabset}

**Study design:**
![](./Figure1_2Scheme.png)

  + **Previous work**: It has been previously published that chronic infection with *S. marcescens* and *E. faecalis* provide significant protection against secondary infection with *P. rettgeri* initiated by an infection dose of 23nL of 0.1 Abs600nm (~8000 CFU/fly) (Chambers et al. 2019)
  + We used infectious doses at least 10 fold above and below this dose, to assess how sensitive this protection is to dose.
  + Flies were first infected with *S. marcescens* or *E. faecalis* and then a week later were given *P. rettgeri* infections with a range of doses (0.001-5.0 Abs600nm) and survival monitored for at least three days.
  + Initially analyzed using Cox Proportional Hazards mixed effects model with date of injection, primary injection and secondary dose as fixed effects and random effect terms accounting for experimental structure (e.g. date of injection, housing of groups of flies in vials). However, this model violated the assumptions of Cox Proportional Hazards. 
  + Therefore we switched to using log-rank pairwise comparisons to determine whether chronic infection significantly impacted survival of secondary infection at an individual dose.
    + LogRank comparisons were done on data from each date individually
    + If experiments on all dates showed higher survival in conditions with chronic infection, p-values were combined using Fisher's test and only the final p-value is reported in the text.
    + If there was a variable effect of chronic infection, the number of individual experiments with significant effects is reported. 
  + **Conclusions** 
    + *S. marcescens* chronic infection provided significant protection during secondary infection with *P. rettgeri* at all infectious doses (p<0.001)
    + *E. faecalis* chronic infection with  offered significant protection against three out of the four doses (P < 0.05). However, the one dose that did not show significant protection (Abs600nm = 0.1) had a borderline p-value = 0.06


## Figure 1 - *S. marcescens* Chronic Infection {.tabset}
 + Mortality over 7 days following secondary infection with *P. rettgeri* in flies chronically infected with *S. marcescens* versus control flies not given a chronic infection. 
  
### Total Graph
```{r, S.m-P.rett survival data}
#Sm_Pr$primary <- ordered(Sm_Pr$primary, levels = c("PBS", "S.m"))
table(Sm_Pr$primary, Sm_Pr$secondary_dose)

#Sm_bacterial_load$primary <- ordered(Sm_bacterial_load$primary, levels = c("PBS", "S.m"))
#table(Sm_bacterial_load$primary, Sm_bacterial_load$secondary_dose)

#THE GRAPH
#png(file="Sm_Pr.png",width=1200,height=900,res=130)
par(mar=c(4,5,1,1)) #sets the margins around the graph so there is room for the labels
plot(survfit(Surv(Sm_Pr$day, Sm_Pr$status) ~ Sm_Pr$primary + Sm_Pr$secondary_dose), col=c("gray", "#D7EEF7", "#B5E8FC",  "#09B6FC", "#055df5", "#003694", "black"), lty=c(3,3,3,3, 3, 3, 3, 1,1,1,1, 1, 1, 1), lwd=5,yaxt='n', xaxt='n', ylab="proportion alive", xlab="days post-secondary infection", cex.lab=2.5, xlim=c(0,7), xaxs='i') 
axis(2, las=2, cex.axis=1.5, lwd=5)
axis(1, cex.axis=1.5, lwd=5)
box(lwd=5)

#THE LEGEND
legend("topright",inset=0, bty="n" , c("PBS-PBS","PBS-P.rett 0.01", "PBS-P.rett 0.1", "PBS-P.rett 1.0", "PBS-P.rett 2.0","PBS-P.rett 3.0","PBS-P.rett 5.0","S.m-PBS", "S.m-P.rett 0.01", "S.m-P.rett 0.1", "S.m-P.rett 1.0", "S.m-P.rett 2.0", "S.m-P.rett 3.0", "S.m-P.rett 5.0"),col=c("gray", "#D7EEF7", "#B5E8FC",  "#09B6FC", "#055df5", "#003694", "black"),lty=c(3, 3, 3, 3, 1, 1, 1, 1),lwd=5, cex=1)
```

### Appendix Figure 1A - Controls
```{r}
Sm_Pr_PBS<-subset(Sm_Pr,secondary_dose=="0")
#table(Sm_Pr_PBS$primary)

#THE GRAPH
#png(file="AFigure1A.png",width=1200,height=900,res=130)
par(mar=c(4,5,1,1)) #sets the margins around the graph so there is room for the labels
plot(survfit(Surv(day, status) ~ primary + secondary_dose, data=Sm_Pr_PBS), col=c("gray"), lty=c(3, 1), lwd=5,yaxt='n', xaxt='n', ylab="proportion alive", xlab="days post-secondary infection", cex.lab=2.5, xlim=c(0,7), xaxs='i') 
axis(2, las=2, cex.axis=1.5, lwd=5)
axis(1, cex.axis=1.5, lwd=5)
box(lwd=5)

#THE LEGEND
legend("bottomleft",inset=0, bty="n" , c("double injection control (n=115)", "chronic infection only (n=114)"),col=c("gray"),lty=c(3, 1),lwd=5, cex=1)
#dev.off()
```

### Figure 1 Panels {.tabset}
#### Figure 1A - 0.01
```{r}
Sm_Pr_0.01<-subset(Sm_Pr,secondary_dose=="0.01")
#table(Sm_Pr_0.01$primary)

#THE GRAPH
#png(file="Figure1A.png",width=1200,height=900,res=130)
par(mar=c(4,5,1,1)) #sets the margins around the graph so there is room for the labels
plot(survfit(Surv(day, status) ~ primary + secondary_dose, data=Sm_Pr_0.01), col=c("#003694"), lty=c(3, 1), lwd=5,yaxt='n', xaxt='n', ylab="proportion alive", xlab="days post-secondary infection", cex.lab=2.5, xlim=c(0,7), xaxs='i') 
axis(2, las=2, cex.axis=1.5, lwd=5)
axis(1, cex.axis=1.5, lwd=5)
box(lwd=5)

#THE LEGEND
legend("topright",inset=0, bty="n" , c("secondary infection only (n=118)", "chronic & secondary infection (n=119)"),col=c("#003694"),lty=c(3, 1),lwd=5, cex=1.7)
#dev.off()
```

#### Figure 1B - 0.1
```{r}
Sm_Pr_0.1<-subset(Sm_Pr,secondary_dose=="0.1")
#table(Sm_Pr_0.1$primary)
#THE GRAPH
#png(file="Figure1B.png",width=1200,height=900,res=130)
par(mar=c(4,5,1,1)) #sets the margins around the graph so there is room for the labels
plot(survfit(Surv(day, status) ~ primary + secondary_dose, data=Sm_Pr_0.1), col=c("#003694"), lty=c(3, 1), lwd=5,yaxt='n', xaxt='n', ylab="proportion alive", xlab="days post-secondary infection", cex.lab=2.5, xlim=c(0,7), xaxs='i') 
axis(2, las=2, cex.axis=1.5, lwd=5)
axis(1, cex.axis=1.5, lwd=5)
box(lwd=5)

#THE LEGEND
legend("topright",inset=0, bty="n" , c("secondary infection only (n=206)", "chronic & secondary infection (n=196)"),col=c("#003694"),lty=c(3, 1),lwd=5, cex=1.7)
#dev.off()
```

#### Figure 1c - 1.0
```{r}
Sm_Pr_1.0<-subset(Sm_Pr,secondary_dose=="1")
#table(Sm_Pr_1.0$primary)
#THE GRAPH
#png(file="Figure1C.png",width=1200,height=900,res=130)
par(mar=c(4,5,1,1)) #sets the margins around the graph so there is room for the labels
plot(survfit(Surv(day, status) ~ primary + secondary_dose, data=Sm_Pr_1.0), col=c("#003694"), lty=c(3, 1), lwd=5,yaxt='n', xaxt='n', ylab="proportion alive", xlab="days post-secondary infection", cex.lab=2.5, xlim=c(0,7), xaxs='i') 
axis(2, las=2, cex.axis=1.5, lwd=5)
axis(1, cex.axis=1.5, lwd=5)
box(lwd=5)

#THE LEGEND
legend("topright",inset=0, bty="n" , c("secondary infection only (n=283)", "chronic & secondary infection (n=275)"),col=c("#003694"),lty=c(3, 1),lwd=5, cex=1.7)
#dev.off()
```

#### Figure 1D - 2.0
```{r}
Sm_Pr_2.0<-subset(Sm_Pr,secondary_dose=="2")
#table(Sm_Pr_2.0$primary)
#THE GRAPH
#png(file="Figure1D.png",width=1200,height=900,res=130)
par(mar=c(4,5,1,1)) #sets the margins around the graph so there is room for the labels
plot(survfit(Surv(day, status) ~ primary + secondary_dose, data=Sm_Pr_2.0), col=c("#003694"), lty=c(3, 1), lwd=5,yaxt='n', xaxt='n', ylab="proportion alive", xlab="days post-secondary infection", cex.lab=2.5, xlim=c(0,7), xaxs='i') 
axis(2, las=2, cex.axis=1.5, lwd=5)
axis(1, cex.axis=1.5, lwd=5)
box(lwd=5)

#THE LEGEND
legend("topright",inset=0, bty="n" , c("secondary infection only (n=263)", "chronic & secondary infection (n=238)"),col=c("#003694"),lty=c(3, 1),lwd=5, cex=1.7)
#dev.off()
```

#### Figure 1E - 3.0
```{r}
Sm_Pr_3.0<-subset(Sm_Pr,secondary_dose=="3")
#table(Sm_Pr_3.0$primary)
#THE GRAPH
#png(file="Figure1E.png",width=1200,height=900,res=130)
par(mar=c(4,5,1,1)) #sets the margins around the graph so there is room for the labels
plot(survfit(Surv(day, status) ~ primary + secondary_dose, data=Sm_Pr_3.0), col=c("#003694"), lty=c(3, 1), lwd=5,yaxt='n', xaxt='n', ylab="proportion alive", xlab="days post-secondary infection", cex.lab=2.5, xlim=c(0,7), xaxs='i') 
axis(2, las=2, cex.axis=1.5, lwd=5)
axis(1, cex.axis=1.5, lwd=5)
box(lwd=5)

#THE LEGEND
legend("topright",inset=0, bty="n" , c("secondary infection only (n=80)", "chronic & secondary infection (n=81)"),col=c("#003694"),lty=c(3, 1),lwd=5, cex=1.7)
#dev.off()
```

#### Figure 1F - 5.0
```{r}
Sm_Pr_5.0<-subset(Sm_Pr,secondary_dose=="5")
#table(Sm_Pr_5.0$primary)
#THE GRAPH
#png(file="Figure1F.png",width=1200,height=900,res=130)
par(mar=c(4,5,1,1)) #sets the margins around the graph so there is room for the labels
plot(survfit(Surv(day, status) ~ primary + secondary_dose, data=Sm_Pr_5.0), col=c("#003694"), lty=c(3, 1), lwd=5,yaxt='n', xaxt='n', ylab="proportion alive", xlab="days post-secondary infection", cex.lab=2.5, xlim=c(0,7), xaxs='i') 
axis(2, las=2, cex.axis=1.5, lwd=5)
axis(1, cex.axis=1.5, lwd=5)
box(lwd=5)

#THE LEGEND
legend("topright",inset=0, bty="n" , c("secondary infection only (n=165)", "chronic & secondary infection (n=159)"),col=c("#003694"),lty=c(3, 1),lwd=5, cex=1.7)
#dev.off()
```

### Figure 1
```{r Figure 1, message = FALSE}
a <- ggdraw() +
  draw_image("Figure1A.png")

b <- ggdraw() +
  draw_image("Figure1B.png")

c <- ggdraw() +
  draw_image("Figure1C.png")

d <- ggdraw() +
  draw_image("Figure1D.png")

e <- ggdraw() +
  draw_image("Figure1E.png")

f <- ggdraw() +
  draw_image("Figure1F.png")

multiplot <- a + b + c + d + e + f
z <- multiplot + 
  plot_annotation(tag_levels = 'A')
ggsave("Fig.1.ChronicSm_Pr.pdf", z, device = "pdf")
z


```

### Individual Blocks {.tabset}
#### Block 1
```{r}
Sm_Pr_block1 <- subset(Sm_Pr, date == "8/2/2018")
table(Sm_Pr_block1$primary, Sm_Pr_block1$secondary_dose)

Sm_Pr_0.01_1<-subset(Sm_Pr_block1, secondary_dose=="0.01")
#table(Sm_Pr_0.01_1$primary)
Sm_Pr_0.1_1<-subset(Sm_Pr_block1, secondary_dose=="0.1")
#table(Sm_Pr_0.1_1$primary)
Sm_Pr_1.0_1<-subset(Sm_Pr_block1, secondary_dose=="1")
#table(Sm_Pr_1.0_1$primary)
#Sm_Pr_2.0_1<-subset(Sm_Pr_block1, secondary_dose=="2")
#table(Sm_Pr_2.0_1$primary)
#Sm_Pr_3.0_1<-subset(Sm_Pr_block1, secondary_dose=="3")
#table(Sm_Pr_2.0_1$primary)
#Sm_Pr_5.0_1<-subset(Sm_Pr_block1, secondary_dose=="5")
#table(Sm_Pr_5.0_1$primary)

surv_Sm_Pr_0.01_1<-survdiff(Surv(day, status) ~ primary, data=Sm_Pr_0.01_1)
surv_Sm_Pr_0.01_1

surv_Sm_Pr_0.1_1<-survdiff(Surv(day, status) ~ primary, data=Sm_Pr_0.1_1)
surv_Sm_Pr_0.1_1


surv_Sm_Pr_1.0_1<-survdiff(Surv(day, status) ~ primary, data=Sm_Pr_1.0_1)
surv_Sm_Pr_1.0_1

#THE GRAPH
par(mar=c(4,5,1,1))
plot(survfit(Surv(Sm_Pr_block1$day, Sm_Pr_block1$status) ~ Sm_Pr_block1$primary + Sm_Pr_block1$secondary_dose), col=c("#B5E8FC",  "#09B6FC", "#055df5"), lty=c(3, 3, 3, 1, 1, 1), lwd=5,yaxt='n', xaxt='n', ylab="proportion alive", xlab="days post-secondary infection", cex.lab=2.5, xlim=c(0,7), xaxs='i') 
axis(2, las=2, cex.axis=1.5, lwd=5)
axis(1, cex.axis=1.5, lwd=5)
box(lwd=5)

#THE LEGEND
legend("topright",inset=0, bty="n" , c("PBS-P.rett 0.01", "PBS-P.rett 0.1", "PBS-P.rett 1.0", "S.m-P.rett 0.01", "S.m-P.rett 0.1", "S.m-P.rett 1.0"),col=c("#B5E8FC", "#09B6FC", "#055df5"),lty=c(3, 3, 3, 1, 1, 1),lwd=5, cex=1)
```

#### Block 2
```{r}
Sm_Pr_block2 <- subset(Sm_Pr, date == "8/6/2018")
table(Sm_Pr_block2$primary, Sm_Pr_block2$secondary_dose)

Sm_Pr_0.01_2<-subset(Sm_Pr_block2, secondary_dose=="0.01")
#table(Sm_Pr_0.01_2$primary)
Sm_Pr_0.1_2<-subset(Sm_Pr_block2, secondary_dose=="0.1")
#table(Sm_Pr_0.1_2$primary)
Sm_Pr_1.0_2<-subset(Sm_Pr_block2, secondary_dose=="1")
#table(Sm_Pr_1.0_2$primary)
#Sm_Pr_2.0_1<-subset(Sm_Pr_block1, secondary_dose=="2")
#table(Sm_Pr_2.0_1$primary)

surv_Sm_Pr_0.01_2<-survdiff(Surv(day, status) ~ primary, data=Sm_Pr_0.01_2)
surv_Sm_Pr_0.01_2

surv_Sm_Pr_0.1_2<-survdiff(Surv(day, status) ~ primary, data=Sm_Pr_0.1_2)
surv_Sm_Pr_0.1_2


surv_Sm_Pr_1.0_2<-survdiff(Surv(day, status) ~ primary, data=Sm_Pr_1.0_2)
surv_Sm_Pr_1.0_2


#THE GRAPH
par(mar=c(4,5,1,1))
plot(survfit(Surv(Sm_Pr_block2$day, Sm_Pr_block2$status) ~ Sm_Pr_block2$primary + Sm_Pr_block2$secondary_dose), col=c("#B5E8FC",  "#09B6FC", "#055df5"), lty=c(3, 3, 3, 1, 1, 1), lwd=5,yaxt='n', xaxt='n', ylab="proportion alive", xlab="days post-secondary infection", cex.lab=2.5, xlim=c(0,7), xaxs='i') 
axis(2, las=2, cex.axis=1.5, lwd=5)
axis(1, cex.axis=1.5, lwd=5)
box(lwd=5)

#THE LEGEND
legend("topright",inset=0, bty="n" , c("PBS-P.rett 0.01", "PBS-P.rett 0.1", "PBS-P.rett 1.0", "S.m-P.rett 0.01", "S.m-P.rett 0.1", "S.m-P.rett 1.0"),col=c("#B5E8FC", "#09B6FC", "#055df5"),lty=c(3, 3, 3, 1, 1, 1),lwd=5, cex=1)
```

#### Block 3
```{r}
Sm_Pr_block3 <- subset(Sm_Pr, date == "6/14/2019")
table(Sm_Pr_block3$primary, Sm_Pr_block3$secondary_dose)

Sm_Pr_0.01_3<-subset(Sm_Pr_block3, secondary_dose=="0.01")
#table(Sm_Pr_0.01_3$primary)
Sm_Pr_0.1_3<-subset(Sm_Pr_block3, secondary_dose=="0.1")
#table(Sm_Pr_0.1_3$primary)
Sm_Pr_1.0_3<-subset(Sm_Pr_block3, secondary_dose=="1")
#table(Sm_Pr_1.0_3$primary)
Sm_Pr_2.0_3<-subset(Sm_Pr_block3, secondary_dose=="2")
#table(Sm_Pr_2.0_3$primary)

surv_Sm_Pr_0.01_3<-survdiff(Surv(day, status) ~ primary, data=Sm_Pr_0.01_3)
surv_Sm_Pr_0.01_3

surv_Sm_Pr_0.1_3<-survdiff(Surv(day, status) ~ primary, data=Sm_Pr_0.1_3)
surv_Sm_Pr_0.1_3


surv_Sm_Pr_1.0_3<-survdiff(Surv(day, status) ~ primary, data=Sm_Pr_1.0_3)
surv_Sm_Pr_1.0_3

surv_Sm_Pr_2.0_3<-survdiff(Surv(day, status) ~ primary, data=Sm_Pr_2.0_3)
surv_Sm_Pr_2.0_3




#THE GRAPH
par(mar=c(4,5,1,1))
plot(survfit(Surv(Sm_Pr_block3$day, Sm_Pr_block3$status) ~ Sm_Pr_block3$primary + Sm_Pr_block3$secondary_dose), col=c("#B5E8FC",  "#09B6FC", "#055df5", "#003694"), lty=c(3, 3, 3, 3, 1, 1, 1, 1), lwd=5,yaxt='n', xaxt='n', ylab="proportion alive", xlab="days post-secondary infection", cex.lab=2.5, xlim=c(0,7), xaxs='i') 
axis(2, las=2, cex.axis=1.5, lwd=5)
axis(1, cex.axis=1.5, lwd=5)
box(lwd=5)

#THE LEGEND
legend("topright",inset=0, bty="n" , c("PBS-P.rett 0.01", "PBS-P.rett 0.1", "PBS-P.rett 1.0", "PBS-P.rett 2.0", "S.m-P.rett 0.01", "S.m-P.rett 0.1", "S.m-P.rett 1.0", "S.m-P.rett 2.0"),col=c("#B5E8FC", "#09B6FC", "#055df5", "#003694"),lty=c(3, 3, 3, 3, 1, 1, 1, 1),lwd=5, cex=1)
```


#### Block 4
```{r}
Sm_Pr_block4 <- subset(Sm_Pr, date == "6/17/2019")
table(Sm_Pr_block4$primary, Sm_Pr_block4$secondary_dose)

Sm_Pr_0.01_4<-subset(Sm_Pr_block4, secondary_dose=="0.01")
#table(Sm_Pr_0.01_4$primary)
Sm_Pr_0.1_4<-subset(Sm_Pr_block4, secondary_dose=="0.1")
#table(Sm_Pr_0.1_4$primary)
Sm_Pr_1.0_4<-subset(Sm_Pr_block4, secondary_dose=="1")
#table(Sm_Pr_1.0_4$primary)
Sm_Pr_2.0_4<-subset(Sm_Pr_block4, secondary_dose=="2")
#table(Sm_Pr_2.0_4$primary)

surv_Sm_Pr_0.01_4<-survdiff(Surv(day, status) ~ primary, data=Sm_Pr_0.01_4)
surv_Sm_Pr_0.01_4

surv_Sm_Pr_0.1_4<-survdiff(Surv(day, status) ~ primary, data=Sm_Pr_0.1_4)
surv_Sm_Pr_0.1_4


surv_Sm_Pr_1.0_4<-survdiff(Surv(day, status) ~ primary, data=Sm_Pr_1.0_4)
surv_Sm_Pr_1.0_4

surv_Sm_Pr_2.0_4<-survdiff(Surv(day, status) ~ primary, data=Sm_Pr_2.0_4)
surv_Sm_Pr_2.0_4

#surv_Sm_Pr_3.0_1<-survdiff(Surv(day, status) ~ primary, data=Sm_Pr_3.0_1)
#surv_Sm_Pr_3.0_1

#surv_Sm_Pr_5.0_1<-survdiff(Surv(day, status) ~ primary, data=Sm_Pr_5.0_1)
#surv_Sm_Pr_5.0_1

#THE GRAPH
par(mar=c(4,5,1,1))
plot(survfit(Surv(Sm_Pr_block4$day, Sm_Pr_block4$status) ~ Sm_Pr_block4$primary + Sm_Pr_block4$secondary_dose), col=c("#B5E8FC",  "#09B6FC", "#055df5", "#003694"), lty=c(3, 3, 3, 3, 1, 1, 1, 1), lwd=5,yaxt='n', xaxt='n', ylab="proportion alive", xlab="days post-secondary infection", cex.lab=2.5, xlim=c(0,7), xaxs='i') 
axis(2, las=2, cex.axis=1.5, lwd=5)
axis(1, cex.axis=1.5, lwd=5)
box(lwd=5)

#THE LEGEND
legend("topright",inset=0, bty="n" , c("PBS-P.rett 0.01", "PBS-P.rett 0.1", "PBS-P.rett 1.0", "PBS-P.rett 2.0", "S.m-P.rett 0.01", "S.m-P.rett 0.1", "S.m-P.rett 1.0", "S.m-P.rett 2.0"),col=c("#B5E8FC", "#09B6FC", "#055df5", "#003694"),lty=c(3, 3, 3, 3, 1, 1, 1, 1),lwd=5, cex=1)
```

#### Block 5
```{r}
Sm_Pr_block5 <- subset(Sm_Pr, date == "6/19/2019")
table(Sm_Pr_block5$primary, Sm_Pr_block5$secondary_dose)

Sm_Pr_0.01_5<-subset(Sm_Pr_block5, secondary_dose=="0.01")
#table(Sm_Pr_0.01_5$primary)
Sm_Pr_0.1_5<-subset(Sm_Pr_block5, secondary_dose=="0.1")
#table(Sm_Pr_0.1_5$primary)
Sm_Pr_1.0_5<-subset(Sm_Pr_block5, secondary_dose=="1")
#table(Sm_Pr_1.0_5$primary)
Sm_Pr_2.0_5<-subset(Sm_Pr_block5, secondary_dose=="2")
#table(Sm_Pr_2.0_5$primary)

surv_Sm_Pr_0.01_5<-survdiff(Surv(day, status) ~ primary, data=Sm_Pr_0.01_5)
surv_Sm_Pr_0.01_5

surv_Sm_Pr_0.1_5<-survdiff(Surv(day, status) ~ primary, data=Sm_Pr_0.1_5)
surv_Sm_Pr_0.1_5


surv_Sm_Pr_1.0_5<-survdiff(Surv(day, status) ~ primary, data=Sm_Pr_1.0_5)
surv_Sm_Pr_1.0_5

surv_Sm_Pr_2.0_5<-survdiff(Surv(day, status) ~ primary, data=Sm_Pr_2.0_5)
surv_Sm_Pr_2.0_5

#surv_Sm_Pr_3.0_1<-survdiff(Surv(day, status) ~ primary, data=Sm_Pr_3.0_1)
#surv_Sm_Pr_3.0_1

#surv_Sm_Pr_5.0_1<-survdiff(Surv(day, status) ~ primary, data=Sm_Pr_5.0_1)
#surv_Sm_Pr_5.0_1

#THE GRAPH
par(mar=c(4,5,1,1))
plot(survfit(Surv(Sm_Pr_block5$day, Sm_Pr_block5$status) ~ Sm_Pr_block5$primary + Sm_Pr_block5$secondary_dose), col=c("#B5E8FC",  "#09B6FC", "#055df5", "#003694"), lty=c(3, 3, 3, 3, 1, 1, 1, 1), lwd=5,yaxt='n', xaxt='n', ylab="proportion alive", xlab="days post-secondary infection", cex.lab=2.5, xlim=c(0,7), xaxs='i') 
axis(2, las=2, cex.axis=1.5, lwd=5)
axis(1, cex.axis=1.5, lwd=5)
box(lwd=5)

#THE LEGEND
legend("topright",inset=0, bty="n" , c("PBS-P.rett 0.01", "PBS-P.rett 0.1", "PBS-P.rett 1.0", "PBS-P.rett 2.0", "S.m-P.rett 0.01", "S.m-P.rett 0.1", "S.m-P.rett 1.0", "S.m-P.rett 2.0"),col=c("#B5E8FC", "#09B6FC", "#055df5", "#003694"),lty=c(3, 3, 3, 3, 1, 1, 1, 1),lwd=5, cex=1)
```

#### Block 6
```{r}
Sm_Pr_block6 <- subset(Sm_Pr, date == "6/25/2019")
table(Sm_Pr_block6$primary, Sm_Pr_block6$secondary_dose)

Sm_Pr_0.01_6<-subset(Sm_Pr_block6, secondary_dose=="0.01")
#table(Sm_Pr_0.01_6$primary)
Sm_Pr_0.1_6<-subset(Sm_Pr_block6, secondary_dose=="0.1")
#table(Sm_Pr_0.1_6$primary)
Sm_Pr_1.0_6<-subset(Sm_Pr_block6, secondary_dose=="1")
#table(Sm_Pr_1.0_6$primary)
Sm_Pr_2.0_6<-subset(Sm_Pr_block6, secondary_dose=="2")
#table(Sm_Pr_2.0_6$primary)

surv_Sm_Pr_0.01_6<-survdiff(Surv(day, status) ~ primary, data=Sm_Pr_0.01_6)
surv_Sm_Pr_0.01_6

surv_Sm_Pr_0.1_6<-survdiff(Surv(day, status) ~ primary, data=Sm_Pr_0.1_6)
surv_Sm_Pr_0.1_6


surv_Sm_Pr_1.0_6<-survdiff(Surv(day, status) ~ primary, data=Sm_Pr_1.0_6)
surv_Sm_Pr_1.0_6

surv_Sm_Pr_2.0_6<-survdiff(Surv(day, status) ~ primary, data=Sm_Pr_2.0_6)
surv_Sm_Pr_2.0_6

#surv_Sm_Pr_3.0_1<-survdiff(Surv(day, status) ~ primary, data=Sm_Pr_3.0_1)
#surv_Sm_Pr_3.0_1

#surv_Sm_Pr_5.0_1<-survdiff(Surv(day, status) ~ primary, data=Sm_Pr_5.0_1)
#surv_Sm_Pr_5.0_1

#THE GRAPH
par(mar=c(4,5,1,1))
plot(survfit(Surv(Sm_Pr_block6$day, Sm_Pr_block6$status) ~ Sm_Pr_block6$primary + Sm_Pr_block6$secondary_dose), col=c("#B5E8FC",  "#09B6FC", "#055df5", "#003694"), lty=c(3, 3, 3, 3, 1, 1, 1, 1), lwd=5,yaxt='n', xaxt='n', ylab="proportion alive", xlab="days post-secondary infection", cex.lab=2.5, xlim=c(0,7), xaxs='i') 
axis(2, las=2, cex.axis=1.5, lwd=5)
axis(1, cex.axis=1.5, lwd=5)
box(lwd=5)

#THE LEGEND
legend("topright",inset=0, bty="n" , c("PBS-P.rett 0.01", "PBS-P.rett 0.1", "PBS-P.rett 1.0", "PBS-P.rett 2.0", "S.m-P.rett 0.01", "S.m-P.rett 0.1", "S.m-P.rett 1.0", "S.m-P.rett 2.0"),col=c("#B5E8FC", "#09B6FC", "#055df5", "#003694"),lty=c(3, 3, 3, 3, 1, 1, 1, 1),lwd=5, cex=1)
```

#### Block 7
```{r}
Sm_Pr_block7 <- subset(Sm_Pr, date == "6/27/2019")
table(Sm_Pr_block7$primary, Sm_Pr_block7$secondary_dose)

Sm_Pr_0.01_7<-subset(Sm_Pr_block7, secondary_dose=="0.01")
#table(Sm_Pr_0.01_7$primary)
Sm_Pr_0.1_7<-subset(Sm_Pr_block7, secondary_dose=="0.1")
#table(Sm_Pr_0.1_7$primary)
Sm_Pr_1.0_7<-subset(Sm_Pr_block7, secondary_dose=="1")
#table(Sm_Pr_1.0_7$primary)
Sm_Pr_2.0_7<-subset(Sm_Pr_block7, secondary_dose=="2")
#table(Sm_Pr_2.0_7$primary)

surv_Sm_Pr_0.01_7<-survdiff(Surv(day, status) ~ primary, data=Sm_Pr_0.01_7)
surv_Sm_Pr_0.01_7

surv_Sm_Pr_0.1_7<-survdiff(Surv(day, status) ~ primary, data=Sm_Pr_0.1_7)
surv_Sm_Pr_0.1_7


surv_Sm_Pr_1.0_7<-survdiff(Surv(day, status) ~ primary, data=Sm_Pr_1.0_7)
surv_Sm_Pr_1.0_7

surv_Sm_Pr_2.0_7<-survdiff(Surv(day, status) ~ primary, data=Sm_Pr_2.0_7)
surv_Sm_Pr_2.0_7

#surv_Sm_Pr_3.0_1<-survdiff(Surv(day, status) ~ primary, data=Sm_Pr_3.0_1)
#surv_Sm_Pr_3.0_1

#surv_Sm_Pr_5.0_1<-survdiff(Surv(day, status) ~ primary, data=Sm_Pr_5.0_1)
#surv_Sm_Pr_5.0_1

#THE GRAPH
par(mar=c(4,5,1,1))
plot(survfit(Surv(Sm_Pr_block7$day, Sm_Pr_block7$status) ~ Sm_Pr_block7$primary + Sm_Pr_block7$secondary_dose), col=c("#B5E8FC",  "#09B6FC", "#055df5", "#003694"), lty=c(3, 3, 3, 3, 1, 1, 1, 1), lwd=5,yaxt='n', xaxt='n', ylab="proportion alive", xlab="days post-secondary infection", cex.lab=2.5, xlim=c(0,7), xaxs='i') 
axis(2, las=2, cex.axis=1.5, lwd=5)
axis(1, cex.axis=1.5, lwd=5)
box(lwd=5)

#THE LEGEND
legend("topright",inset=0, bty="n" , c("PBS-P.rett 0.01", "PBS-P.rett 0.1", "PBS-P.rett 1.0", "PBS-P.rett 2.0", "S.m-P.rett 0.01", "S.m-P.rett 0.1", "S.m-P.rett 1.0", "S.m-P.rett 2.0"),col=c("#B5E8FC", "#09B6FC", "#055df5", "#003694"),lty=c(3, 3, 3, 3, 1, 1, 1, 1),lwd=5, cex=1)
```

#### Block 8
```{r, S.m-P.rett extremes survival data 1/30/2020}
Sm_Pr_block8 <- subset(Sm_Pr, date == "1/30/2020")
table(Sm_Pr_block8$primary, Sm_Pr_block8$secondary_dose)


Sm_Pr_0.1_8<-subset(Sm_Pr_block8, secondary_dose=="0.1")
#table(Sm_Pr_0.1_8$primary)
Sm_Pr_1.0_8<-subset(Sm_Pr_block8, secondary_dose=="1")
#table(Sm_Pr_1.0_8$primary)
Sm_Pr_2.0_8<-subset(Sm_Pr_block8, secondary_dose=="2")
#table(Sm_Pr_2.0_8$primary)
#Sm_Pr_3.0_8<-subset(Sm_Pr_block8, secondary_dose=="3")
#table(Sm_Pr_3.0_8$primary)
Sm_Pr_5.0_8<-subset(Sm_Pr_block8, secondary_dose=="5")
#table(Sm_Pr_5.0_8$primary)


surv_Sm_Pr_0.1_8<-survdiff(Surv(day, status) ~ primary, data=Sm_Pr_0.1_8)
surv_Sm_Pr_0.1_8


surv_Sm_Pr_1.0_8<-survdiff(Surv(day, status) ~ primary, data=Sm_Pr_1.0_8)
surv_Sm_Pr_1.0_8

surv_Sm_Pr_2.0_8<-survdiff(Surv(day, status) ~ primary, data=Sm_Pr_2.0_8)
surv_Sm_Pr_2.0_8

#surv_Sm_Pr_3.0_8<-survdiff(Surv(day, status) ~ primary, data=Sm_Pr_3.0_8)
#surv_Sm_Pr_3.0_8

surv_Sm_Pr_5.0_8<-survdiff(Surv(day, status) ~ primary, data=Sm_Pr_5.0_8)
surv_Sm_Pr_5.0_8


#THE GRAPH
par(mar=c(4,5,1,1))
plot(survfit(Surv(Sm_Pr_block8$day, Sm_Pr_block8$status) ~ Sm_Pr_block8$primary + Sm_Pr_block8$secondary_dose), col=c("gray", "#B5E8FC",  "#09B6FC", "#055df5", "black"), lty=c(3, 3, 3, 3, 3, 1, 1, 1, 1, 1), lwd=5, yaxt='n', xaxt='n', ylab="proportion alive", xlab="days post-secondary infection", cex.lab=2.5, xlim=c(0,7), xaxs='i')
axis(2, las=2, cex.axis=1.5, lwd=5)
axis(1, cex.axis=1.5, lwd=5)
box(lwd=5)

#THE LEGEND
legend("topright",inset=0, bty="n" , c("PBS-PBS", "PBS-P.rett 0.1", "PBS-P.rett 1.0", "PBS-P.rett 2.0", "PBS-P.rett 5.0", "S.m-PBS", "S.m-P.rett 0.1", "S.m-P.rett 1.0", "S.m-P.rett 2.0", "S.m-P.rett 5.0"),col=c("gray", "#B5E8FC",  "#09B6FC", "#055df5", "black"),lty=c(3, 3, 3, 3, 3, 1, 1, 1, 1, 1),lwd=5, cex=1)
```

#### Block 9
```{r, S.m-P.rett extremes survival data 2/13/2020}
Sm_Pr_block9 <- subset(Sm_Pr, date == "2/13/2020")
table(Sm_Pr_block9$primary, Sm_Pr_block9$secondary_dose)

Sm_Pr_0.1_9<-subset(Sm_Pr_block9, secondary_dose=="0.1")
#table(Sm_Pr_0.1_9$primary)
Sm_Pr_1.0_9<-subset(Sm_Pr_block9, secondary_dose=="1")
#table(Sm_Pr_1.0_9$primary)
Sm_Pr_2.0_9<-subset(Sm_Pr_block9, secondary_dose=="2")
#table(Sm_Pr_2.0_9$primary)
#Sm_Pr_3.0_9<-subset(Sm_Pr_block9, secondary_dose=="3")
#table(Sm_Pr_3.0_9$primary)
Sm_Pr_5.0_9<-subset(Sm_Pr_block9, secondary_dose=="5")
#table(Sm_Pr_5.0_9$primary)


surv_Sm_Pr_0.1_9<-survdiff(Surv(day, status) ~ primary, data=Sm_Pr_0.1_9)
surv_Sm_Pr_0.1_9


surv_Sm_Pr_1.0_9<-survdiff(Surv(day, status) ~ primary, data=Sm_Pr_1.0_9)
surv_Sm_Pr_1.0_9

surv_Sm_Pr_2.0_9<-survdiff(Surv(day, status) ~ primary, data=Sm_Pr_2.0_9)
surv_Sm_Pr_2.0_9

#surv_Sm_Pr_3.0_9<-survdiff(Surv(day, status) ~ primary, data=Sm_Pr_3.0_9)
#surv_Sm_Pr_3.0_9

surv_Sm_Pr_5.0_9<-survdiff(Surv(day, status) ~ primary, data=Sm_Pr_5.0_9)
surv_Sm_Pr_5.0_9


#THE GRAPH
par(mar=c(4,5,1,1))
plot(survfit(Surv(Sm_Pr_block9$day, Sm_Pr_block9$status) ~ Sm_Pr_block9$primary + Sm_Pr_block9$secondary_dose), col=c("gray", "#B5E8FC",  "#09B6FC", "#055df5", "black"), lty=c(3, 3, 3, 3, 3, 1, 1, 1, 1, 1), lwd=5, yaxt='n', xaxt='n', ylab="proportion alive", xlab="days post-secondary infection", cex.lab=2.5, xlim=c(0,7), xaxs='i')
axis(2, las=2, cex.axis=1.5, lwd=5)
axis(1, cex.axis=1.5, lwd=5)
box(lwd=5)

#THE LEGEND
legend("topright",inset=0, bty="n" , c("PBS-PBS", "PBS-P.rett 0.1", "PBS-P.rett 1.0", "PBS-P.rett 2.0", "PBS-P.rett 5.0", "S.m-PBS", "S.m-P.rett 0.1", "S.m-P.rett 1.0", "S.m-P.rett 2.0", "S.m-P.rett 5.0"),col=c("gray", "#B5E8FC",  "#09B6FC", "#055df5", "black"),lty=c(3, 3, 3, 3, 3, 1, 1, 1, 1, 1),lwd=5, cex=1)
```

#### Block 10
```{r, S.m-P.rett extremes survival data 9/27/2020}
Sm_Pr_block10 <- subset(Sm_Pr, date == "9/27/2020")
table(Sm_Pr_block10$primary, Sm_Pr_block10$secondary_dose)

#Sm_Pr_0.1_10<-subset(Sm_Pr_block10, secondary_dose=="0.1")
#table(Sm_Pr_0.1_10$primary)
Sm_Pr_1.0_10<-subset(Sm_Pr_block10, secondary_dose=="1")
#table(Sm_Pr_1.0_10$primary)
Sm_Pr_2.0_10<-subset(Sm_Pr_block10, secondary_dose=="2")
#table(Sm_Pr_2.0_10$primary)
Sm_Pr_3.0_10<-subset(Sm_Pr_block10, secondary_dose=="3")
#table(Sm_Pr_3.0_10$primary)
Sm_Pr_5.0_10<-subset(Sm_Pr_block10, secondary_dose=="5")
#table(Sm_Pr_5.0_10$primary)


#surv_Sm_Pr_0.1_10<-survdiff(Surv(day, status) ~ primary, data=Sm_Pr_0.1_10)
#surv_Sm_Pr_0.1_10


surv_Sm_Pr_1.0_10<-survdiff(Surv(day, status) ~ primary, data=Sm_Pr_1.0_10)
surv_Sm_Pr_1.0_10

surv_Sm_Pr_2.0_10<-survdiff(Surv(day, status) ~ primary, data=Sm_Pr_2.0_10)
surv_Sm_Pr_2.0_10

surv_Sm_Pr_3.0_10<-survdiff(Surv(day, status) ~ primary, data=Sm_Pr_3.0_10)
surv_Sm_Pr_3.0_10

surv_Sm_Pr_5.0_10<-survdiff(Surv(day, status) ~ primary, data=Sm_Pr_5.0_10)
surv_Sm_Pr_5.0_10

#THE GRAPH
par(mar=c(4,5,1,1))
plot(survfit(Surv(Sm_Pr_block10$day, Sm_Pr_block10$status) ~ Sm_Pr_block10$primary + Sm_Pr_block10$secondary_dose), col=c("gray", "#09B6FC", "#055df5", "#003694", "black"), lty=c(3, 3, 3, 3, 3, 1, 1, 1, 1, 1), lwd=5, yaxt='n', xaxt='n', ylab="proportion alive", xlab="days post-secondary infection", cex.lab=2.5, xlim=c(0,7), xaxs='i')
axis(2, las=2, cex.axis=1.5, lwd=5)
axis(1, cex.axis=1.5, lwd=5)
box(lwd=5)

#THE LEGEND
legend("topright",inset=0, bty="n" , c("PBS-PBS", "PBS-P.rett 1.0", "PBS-P.rett 2.0", "PBS-P.rett 3.0", "PBS-P.rett 5.0", "S.m-PBS", "S.m-P.rett 1.0", "S.m-P.rett 2.0", "S.m-P.rett 3.0", "S.m-P.rett 5.0"),col=c("gray", "#09B6FC", "#055df5", "#003694", "black"),lty=c(3, 3, 3, 3, 3, 1, 1, 1, 1, 1),lwd=5, cex=1)
```

#### Block 11
```{r, S.m-P.rett extremes survival data 10/6/2020}
Sm_Pr_block11 <- subset(Sm_Pr, date == "10/6/2020")
table(Sm_Pr_block11$primary, Sm_Pr_block11$secondary_dose)

#Sm_Pr_0.1_11<-subset(Sm_Pr_block11, secondary_dose=="0.1")
#table(Sm_Pr_0.1_11$primary)
Sm_Pr_1.0_11<-subset(Sm_Pr_block11, secondary_dose=="1")
#table(Sm_Pr_1.0_11$primary)
Sm_Pr_2.0_11<-subset(Sm_Pr_block11, secondary_dose=="2")
#table(Sm_Pr_2.0_11$primary)
Sm_Pr_3.0_11<-subset(Sm_Pr_block11, secondary_dose=="3")
#table(Sm_Pr_3.0_11$primary)
Sm_Pr_5.0_11<-subset(Sm_Pr_block11, secondary_dose=="5")
#table(Sm_Pr_5.0_11$primary)


#surv_Sm_Pr_0.1_11<-survdiff(Surv(day, status) ~ primary, data=Sm_Pr_0.1_11)
#surv_Sm_Pr_0.1_11


surv_Sm_Pr_1.0_11<-survdiff(Surv(day, status) ~ primary, data=Sm_Pr_1.0_11)
surv_Sm_Pr_1.0_11

surv_Sm_Pr_2.0_11<-survdiff(Surv(day, status) ~ primary, data=Sm_Pr_2.0_11)
surv_Sm_Pr_2.0_11

surv_Sm_Pr_3.0_11<-survdiff(Surv(day, status) ~ primary, data=Sm_Pr_3.0_11)
surv_Sm_Pr_3.0_11

surv_Sm_Pr_5.0_11<-survdiff(Surv(day, status) ~ primary, data=Sm_Pr_5.0_11)
surv_Sm_Pr_5.0_11

#THE GRAPH
par(mar=c(4,5,1,1))
plot(survfit(Surv(Sm_Pr_block11$day, Sm_Pr_block11$status) ~ Sm_Pr_block11$primary + Sm_Pr_block11$secondary_dose), col=c("gray", "#09B6FC", "#055df5", "#003694", "black"), lty=c(3, 3, 3, 3, 3, 1, 1, 1, 1, 1), lwd=5, yaxt='n', xaxt='n', ylab="proportion alive", xlab="days post-secondary infection", cex.lab=2.5, xlim=c(0,7), xaxs='i')
axis(2, las=2, cex.axis=1.5, lwd=5)
axis(1, cex.axis=1.5, lwd=5)
box(lwd=5)

#THE LEGEND
legend("topright",inset=0, bty="n" , c("PBS-PBS", "PBS-P.rett 1.0", "PBS-P.rett 2.0", "PBS-P.rett 3.0", "PBS-P.rett 5.0", "S.m-PBS", "S.m-P.rett 1.0", "S.m-P.rett 2.0", "S.m-P.rett 3.0", "S.m-P.rett 5.0"),col=c("gray", "#09B6FC", "#055df5", "#003694", "black"),lty=c(3, 3, 3, 3, 3, 1, 1, 1, 1, 1),lwd=5, cex=1)
```

#### Block 12
```{r, S.m-P.rett extremes survival data 11/1/2020}
Sm_Pr_block12 <- subset(Sm_Pr, date == "11/1/2020")
table(Sm_Pr_block12$primary, Sm_Pr_block12$secondary_dose)

#Sm_Pr_0.1_12<-subset(Sm_Pr_block12, secondary_dose=="0.1")
#table(Sm_Pr_0.1_12$primary)
Sm_Pr_1.0_12<-subset(Sm_Pr_block12, secondary_dose=="1")
#table(Sm_Pr_1.0_12$primary)
Sm_Pr_2.0_12<-subset(Sm_Pr_block12, secondary_dose=="2")
#table(Sm_Pr_2.0_12$primary)
Sm_Pr_3.0_12<-subset(Sm_Pr_block12, secondary_dose=="3")
#table(Sm_Pr_3.0_12$primary)
Sm_Pr_5.0_12<-subset(Sm_Pr_block12, secondary_dose=="5")
#table(Sm_Pr_5.0_12$primary)


#surv_Sm_Pr_0.1_12<-survdiff(Surv(day, status) ~ primary, data=Sm_Pr_0.1_12)
#surv_Sm_Pr_0.1_12


surv_Sm_Pr_1.0_12<-survdiff(Surv(day, status) ~ primary, data=Sm_Pr_1.0_12)
surv_Sm_Pr_1.0_12

surv_Sm_Pr_2.0_12<-survdiff(Surv(day, status) ~ primary, data=Sm_Pr_2.0_12)
surv_Sm_Pr_2.0_12

surv_Sm_Pr_3.0_12<-survdiff(Surv(day, status) ~ primary, data=Sm_Pr_3.0_12)
surv_Sm_Pr_3.0_12

surv_Sm_Pr_5.0_12<-survdiff(Surv(day, status) ~ primary, data=Sm_Pr_5.0_12)
surv_Sm_Pr_5.0_12

#THE GRAPH
par(mar=c(4,5,1,1))
plot(survfit(Surv(Sm_Pr_block12$day, Sm_Pr_block12$status) ~ Sm_Pr_block12$primary + Sm_Pr_block12$secondary_dose), col=c("gray", "#09B6FC", "#055df5", "#003694", "black"), lty=c(3, 3, 3, 3, 3, 3, 1, 1, 1, 1, 1, 1), lwd=5, yaxt='n', xaxt='n', ylab="proportion alive", xlab="days post-secondary infection", cex.lab=2.5, xlim=c(0,7), xaxs='i')
axis(2, las=2, cex.axis=1.5, lwd=5)
axis(1, cex.axis=1.5, lwd=5)
box(lwd=5)

#THE LEGEND
legend("topright",inset=0, bty="n" , c("PBS-PBS", "PBS-P.rett 1.0", "PBS-P.rett 2.0", "PBS-P.rett 3.0", "PBS-P.rett 5.0", "S.m-PBS", "S.m-P.rett 1.0", "S.m-P.rett 2.0", "S.m-P.rett 3.0", "S.m-P.rett 5.0"),col=c("gray", "#09B6FC", "#055df5", "#003694", "black"),lty=c(3, 3, 3, 3, 3, 1, 1, 1, 1, 1),lwd=5, cex=1)
```

#### Block 13
```{r, S.m-P.rett extremes survival data 6/16/2021}
Sm_Pr_block13 <- subset(Sm_Pr, date == "6/16/2021")
table(Sm_Pr_block13$primary, Sm_Pr_block13$secondary_dose)

Sm_Pr_0.1_13<-subset(Sm_Pr_block13, secondary_dose=="0.1")
#table(Sm_Pr_0.1_13$primary)
Sm_Pr_1.0_13<-subset(Sm_Pr_block13, secondary_dose=="1")
#table(Sm_Pr_1.0_13$primary)
Sm_Pr_2.0_13<-subset(Sm_Pr_block13, secondary_dose=="2")
#table(Sm_Pr_2.0_13$primary)
#Sm_Pr_3.0_13<-subset(Sm_Pr_block13, secondary_dose=="3")
#table(Sm_Pr_2.0_13$primary)
Sm_Pr_5.0_13<-subset(Sm_Pr_block13, secondary_dose=="5")
#table(Sm_Pr_2.0_13$primary)


surv_Sm_Pr_0.1_13<-survdiff(Surv(day, status) ~ primary, data=Sm_Pr_0.1_13)
surv_Sm_Pr_0.1_13


surv_Sm_Pr_1.0_13<-survdiff(Surv(day, status) ~ primary, data=Sm_Pr_1.0_13)
surv_Sm_Pr_1.0_13

surv_Sm_Pr_2.0_13<-survdiff(Surv(day, status) ~ primary, data=Sm_Pr_2.0_13)
surv_Sm_Pr_2.0_13

#surv_Sm_Pr_3.0_13<-survdiff(Surv(day, status) ~ primary, data=Sm_Pr_3.0_13)
#surv_Sm_Pr_3.0_13

surv_Sm_Pr_5.0_13<-survdiff(Surv(day, status) ~ primary, data=Sm_Pr_5.0_13)
surv_Sm_Pr_5.0_13

#THE GRAPH
par(mar=c(4,5,1,1))
plot(survfit(Surv(Sm_Pr_block13$day, Sm_Pr_block13$status) ~ Sm_Pr_block13$primary + Sm_Pr_block13$secondary_dose), col=c("gray", "#09B6FC", "#055df5", "#003694", "black"), lty=c(3, 3, 3, 3, 3, 1, 1, 1, 1, 1), lwd=5, yaxt='n', xaxt='n', ylab="proportion alive", xlab="days post-secondary infection", cex.lab=2.5, xlim=c(0,7), xaxs='i')
axis(2, las=2, cex.axis=1.5, lwd=5)
axis(1, cex.axis=1.5, lwd=5)
box(lwd=5)

#THE LEGEND
legend("topright",inset=0, bty="n" , c("PBS-PBS", "PBS-P.rett 1.0", "PBS-P.rett 2.0", "PBS-P.rett 3.0", "PBS-P.rett 5.0", "S.m-PBS", "S.m-P.rett 1.0", "S.m-P.rett 2.0", "S.m-P.rett 3.0", "S.m-P.rett 5.0"),col=c("gray", "#09B6FC", "#055df5", "#003694", "black"),lty=c(3, 3, 3, 3, 3, 1, 1, 1, 1, 1),lwd=5, cex=1)
```

### Statistical tests


```{r}

# Grab p-values from each individual logrank test (results shown above in each block)
pvalue_0.01_1<-pchisq(surv_Sm_Pr_0.01_1$chisq, df=1, lower.tail=F)
pvalue_0.1_1<-pchisq(surv_Sm_Pr_0.1_1$chisq, df=1, lower.tail=F)
pvalue_1.0_1<-pchisq(surv_Sm_Pr_1.0_1$chisq, df=1, lower.tail=F)

pvalue_0.01_2<-pchisq(surv_Sm_Pr_0.01_2$chisq, df=1, lower.tail=F)
pvalue_0.1_2<-pchisq(surv_Sm_Pr_0.1_2$chisq, df=1, lower.tail=F)
pvalue_1.0_2<-pchisq(surv_Sm_Pr_1.0_2$chisq, df=1, lower.tail=F)

pvalue_0.01_3<-pchisq(surv_Sm_Pr_0.01_3$chisq, df=1, lower.tail=F)
pvalue_0.1_3<-pchisq(surv_Sm_Pr_0.1_3$chisq, df=1, lower.tail=F)
pvalue_1.0_3<-pchisq(surv_Sm_Pr_1.0_3$chisq, df=1, lower.tail=F)
pvalue_2.0_3<-pchisq(surv_Sm_Pr_2.0_3$chisq, df=1, lower.tail=F)

pvalue_0.01_4<-pchisq(surv_Sm_Pr_0.01_4$chisq, df=1, lower.tail=F)
pvalue_0.1_4<-pchisq(surv_Sm_Pr_0.1_4$chisq, df=1, lower.tail=F)
pvalue_1.0_4<-pchisq(surv_Sm_Pr_1.0_4$chisq, df=1, lower.tail=F)
pvalue_2.0_4<-pchisq(surv_Sm_Pr_2.0_4$chisq, df=1, lower.tail=F)

pvalue_0.01_5<-pchisq(surv_Sm_Pr_0.01_5$chisq, df=1, lower.tail=F)
pvalue_0.1_5<-pchisq(surv_Sm_Pr_0.1_5$chisq, df=1, lower.tail=F)
pvalue_1.0_5<-pchisq(surv_Sm_Pr_1.0_5$chisq, df=1, lower.tail=F)
pvalue_2.0_5<-pchisq(surv_Sm_Pr_2.0_5$chisq, df=1, lower.tail=F)

pvalue_0.01_6<-pchisq(surv_Sm_Pr_0.01_6$chisq, df=1, lower.tail=F)
pvalue_0.1_6<-pchisq(surv_Sm_Pr_0.1_6$chisq, df=1, lower.tail=F)
pvalue_1.0_6<-pchisq(surv_Sm_Pr_1.0_6$chisq, df=1, lower.tail=F)
pvalue_2.0_6<-pchisq(surv_Sm_Pr_2.0_6$chisq, df=1, lower.tail=F)

pvalue_0.01_7<-pchisq(surv_Sm_Pr_0.01_7$chisq, df=1, lower.tail=F)
pvalue_0.1_7<-pchisq(surv_Sm_Pr_0.1_7$chisq, df=1, lower.tail=F)
pvalue_1.0_7<-pchisq(surv_Sm_Pr_1.0_7$chisq, df=1, lower.tail=F)
pvalue_2.0_7<-pchisq(surv_Sm_Pr_2.0_7$chisq, df=1, lower.tail=F)


pvalue_0.1_8<-pchisq(surv_Sm_Pr_0.1_8$chisq, df=1, lower.tail=F)
pvalue_1.0_8<-pchisq(surv_Sm_Pr_1.0_8$chisq, df=1, lower.tail=F)
pvalue_2.0_8<-pchisq(surv_Sm_Pr_2.0_8$chisq, df=1, lower.tail=F)
pvalue_5.0_8<-pchisq(surv_Sm_Pr_5.0_8$chisq, df=1, lower.tail=F)


pvalue_0.1_9<-pchisq(surv_Sm_Pr_0.1_9$chisq, df=1, lower.tail=F)
pvalue_1.0_9<-pchisq(surv_Sm_Pr_1.0_9$chisq, df=1, lower.tail=F)
pvalue_2.0_9<-pchisq(surv_Sm_Pr_2.0_9$chisq, df=1, lower.tail=F)
pvalue_5.0_9<-pchisq(surv_Sm_Pr_5.0_9$chisq, df=1, lower.tail=F)

pvalue_1.0_10<-pchisq(surv_Sm_Pr_1.0_10$chisq, df=1, lower.tail=F)
pvalue_2.0_10<-pchisq(surv_Sm_Pr_2.0_10$chisq, df=1, lower.tail=F)
pvalue_3.0_10<-pchisq(surv_Sm_Pr_3.0_10$chisq, df=1, lower.tail=F)
pvalue_5.0_10<-pchisq(surv_Sm_Pr_5.0_10$chisq, df=1, lower.tail=F)

pvalue_1.0_11<-pchisq(surv_Sm_Pr_1.0_11$chisq, df=1, lower.tail=F)
pvalue_2.0_11<-pchisq(surv_Sm_Pr_2.0_11$chisq, df=1, lower.tail=F)
pvalue_3.0_11<-pchisq(surv_Sm_Pr_3.0_11$chisq, df=1, lower.tail=F)
pvalue_5.0_11<-pchisq(surv_Sm_Pr_5.0_11$chisq, df=1, lower.tail=F)

pvalue_1.0_12<-pchisq(surv_Sm_Pr_1.0_12$chisq, df=1, lower.tail=F)
pvalue_2.0_12<-pchisq(surv_Sm_Pr_2.0_12$chisq, df=1, lower.tail=F)
pvalue_3.0_12<-pchisq(surv_Sm_Pr_3.0_12$chisq, df=1, lower.tail=F)
pvalue_5.0_12<-pchisq(surv_Sm_Pr_5.0_12$chisq, df=1, lower.tail=F)

pvalue_0.1_13<-pchisq(surv_Sm_Pr_0.1_13$chisq, df=1, lower.tail=F)
pvalue_1.0_13<-pchisq(surv_Sm_Pr_1.0_13$chisq, df=1, lower.tail=F)
pvalue_2.0_13<-pchisq(surv_Sm_Pr_2.0_13$chisq, df=1, lower.tail=F)
pvalue_5.0_13<-pchisq(surv_Sm_Pr_5.0_13$chisq, df=1, lower.tail=F)
```


```{r}
# Use all p-values from a given condition to get Fisher's combined test p-value
pvalues_0.01 <- c(pvalue_0.01_1,pvalue_0.01_2,pvalue_0.01_3,pvalue_0.01_4,pvalue_0.01_5,pvalue_0.01_6,pvalue_0.01_7)
test.stat_0.01 <- -2*sum(log(pvalues_0.01))
pfinal_0.01<-pchisq(test.stat_0.01, df=2*length(pvalues_0.01), lower.tail=F)

pvalues_0.1 <- c(pvalue_0.1_1,pvalue_0.1_2,pvalue_0.1_3,pvalue_0.1_4,pvalue_0.1_5,pvalue_0.1_6,pvalue_0.1_7, pvalue_0.1_8, pvalue_0.1_9, pvalue_0.1_13)
test.stat_0.1 <- -2*sum(log(pvalues_0.1))
pfinal_0.1<-pchisq(test.stat_0.1, df=2*length(pvalues_0.1), lower.tail=F)

pvalues_1.0 <- c(pvalue_1.0_1,pvalue_1.0_2,pvalue_1.0_3,pvalue_1.0_4,pvalue_1.0_5,pvalue_1.0_6,pvalue_1.0_7, pvalue_1.0_8, pvalue_1.0_9, pvalue_1.0_10, pvalue_1.0_11, pvalue_1.0_12, pvalue_1.0_13)
test.stat_1.0 <- -2*sum(log(pvalues_1.0))
pfinal_1.0<-pchisq(test.stat_1.0, df=2*length(pvalues_1.0), lower.tail=F)

pvalues_2.0 <- c(pvalue_2.0_3,pvalue_2.0_4,pvalue_2.0_5,pvalue_2.0_6,pvalue_2.0_7, pvalue_2.0_8, pvalue_2.0_9, pvalue_2.0_10, pvalue_2.0_11, pvalue_2.0_12, pvalue_2.0_13)
test.stat_2.0 <- -2*sum(log(pvalues_2.0))
pfinal_2.0<-pchisq(test.stat_2.0, df=2*length(pvalues_2.0), lower.tail=F)

pvalues_3.0 <- c(pvalue_3.0_10, pvalue_3.0_11, pvalue_3.0_12)
test.stat_3.0 <- -2*sum(log(pvalues_3.0))
pfinal_3.0<-pchisq(test.stat_3.0, df=2*length(pvalues_3.0), lower.tail=F)

pvalues_5.0 <- c(pvalue_5.0_8, pvalue_5.0_9, pvalue_5.0_10, pvalue_5.0_11, pvalue_5.0_12, pvalue_5.0_13)
test.stat_5.0 <- -2*sum(log(pvalues_5.0))
pfinal_5.0<-pchisq(test.stat_5.0, df=2*length(pvalues_5.0), lower.tail=F)

```


```{r}
# Generate Table of final results
pvalues_0.01_table <- c(pvalue_0.01_1,pvalue_0.01_2,pvalue_0.01_3,pvalue_0.01_4,pvalue_0.01_5,pvalue_0.01_6,pvalue_0.01_7, NA, NA, NA, NA, NA, NA)
p0.01<-scales::pvalue(pvalues_0.01_table)
p0.01 <- p0.01 %>% replace_na("--")

pvalues_0.1_table <- c(pvalue_0.1_1,pvalue_0.1_2,pvalue_0.1_3,pvalue_0.1_4,pvalue_0.1_5,pvalue_0.1_6,pvalue_0.1_7, pvalue_0.1_8, pvalue_0.1_9,NA, NA, NA, pvalue_0.1_13)
p0.1<-scales::pvalue(pvalues_0.1_table)
p0.1<- p0.1 %>% replace_na("--")

pvalues_1.0_table <- c(pvalue_1.0_1,pvalue_1.0_2,pvalue_1.0_3,pvalue_1.0_4,pvalue_1.0_5,pvalue_1.0_6,pvalue_1.0_7, pvalue_1.0_8, pvalue_1.0_9, pvalue_1.0_10, pvalue_1.0_11, pvalue_1.0_12, pvalue_1.0_13)
p1.0<-scales::pvalue(pvalues_1.0_table)

pvalues_2.0_table <- c(NA, NA, pvalue_2.0_3, pvalue_2.0_4, pvalue_2.0_5, pvalue_2.0_6, pvalue_2.0_7, pvalue_2.0_8, pvalue_2.0_9, pvalue_2.0_10, pvalue_2.0_11, pvalue_2.0_12, pvalue_2.0_13)
p2.0<-scales::pvalue(pvalues_2.0_table)
p2.0<-p2.0 %>% replace_na("--")

pvalues_3.0_table <- c(NA, NA, NA, NA, NA, NA, NA, NA, NA, pvalue_3.0_10, pvalue_3.0_11, pvalue_3.0_12, NA)
p3.0<-scales::pvalue(pvalues_3.0_table)
p3.0<-p3.0 %>% replace_na("--")

pvalues_5.0_table <- c(NA, NA, NA, NA, NA, NA, NA, pvalue_5.0_8, pvalue_5.0_9, pvalue_5.0_10, pvalue_5.0_11, pvalue_5.0_12, pvalue_5.0_13)
p5.0<-scales::pvalue(pvalues_5.0_table)
p5.0<-p5.0 %>% replace_na("--")

pvalue_table <- data.frame("0.01" = p0.01, "0.1" = p0.1, "1.0" = p1.0, "2.0" = p2.0, "3.0" = p3.0, "5.0" = p5.0 )
colnames(pvalue_table) <- c(0.01, 0.1, 1.0, 2.0, 3.0, 5.0)

pfisher<- c(pfinal_0.01, pfinal_0.1, pfinal_1.0, pfinal_2.0, pfinal_3.0, pfinal_5.0)
pfisher<-scales::pvalue(pfisher)
pvalue_table[nrow(pvalue_table) + 1,]<-pfisher

row.names(pvalue_table) <- c("Block 1 - August 2nd, 2018", "Block 2 - August 6th, 2018", "Block 3 - June 14, 2019", "Block 4 - June 17, 2019", "Block 5 - June 19, 2019", "Block 6 - June 25, 2019", "Block 7 - June 27, 2019", "Block 8 - January 30, 2020", "Block 9 - February 13th, 2020", "Block 10 - September 27th, 2020", "Block 11 - October 6th, 2020", "Block 12 - November 1st, 2020", "Block 13 - June 16th, 2021", " Final P-value ")

pvalue_table %>%
  kbl(caption = "<center><strong>P-values for log-rank tests on individual doses within each experiment<center><strong>") %>%
   kable_classic(full_width = F, html_font = "Cambria", position = "center")%>%
    add_header_above(c(" "=1, "Infectious Dose (Abs600nm)" = 6)) %>%
    pack_rows("Individual Blocks", 1, 13) %>%
    pack_rows("Fisher's Combined", 14, 14)

```

  + **Conclusion:** There was significant protection at all infectious doses for the secondary infection (p<0.001)
  


## Figure 2 - *E. faecalis* Chronic Infection {.tabset}
   + Mortality over 7 days following secondary infection with *P. rettgeri* in flies chronically infected with *E. faecalis* versus control flies not given a chronic infection. 

### Graph
```{r, E.fae-P.rett survival data}

#KAPLAN MEIER
#table(Ef_Pr$primary, Ef_Pr$secondary_dose) #tells you the number of flies in each condition
#png(file="E.fae-P.rett.png", width=1200, heigh=900, res=130) #determines where the graph will be saved
par(mar=c(4,5,1,1)) #sets the margins around the graph so there is room for the labels
#The graph
plot(survfit(Surv(Ef_Pr$day, Ef_Pr$status) ~ Ef_Pr$primary + Ef_Pr$secondary_dose),
     col=c("#B5E8FC", "#09B6FC", "#055df5", "#0600a8"), #line color, cycles through
     lty=c(3, 3, 3, 3, 1, 1, 1, 1), #line type
     lwd=5, #line width
     yaxt='n', #hide the y axis so I can customize it
     xaxt='n', #hide the x axis so I can customize itS
     ylab="proportion alive", #label for the y-axis
     xlab="days post-secondary infection", #label for the x-axis
     cex.lab=2.5, #font size of axis labels
     xlim=c(0,7), #determines range of the x-axis
     xaxs='i') #makes the data flush with the axis
#Y axis
axis(2, #left side
     las=2, #perpendicular to the axis
     cex.axis=1.5, #font size
     lwd=5) #line width
#X axis
axis(1, #bottom of the graph
     cex.axis=1.5, #font size
     lwd=5) #line width
box(lwd=5)
#The legend
legend("topright", #location
       bty="n", #no box around the legend
       c("PBS-P.rett 0.001", "PBS-P.rett 0.01", "PBS-P.rett 0.1", 'PBS-P.rett 1.0', "E.fae-P.rett 0.001", "E.fae-P.rett 0.01", "E.fae-P.rett 0.1", "E.fae-P.rett 1.0"), #labels in the legend
       col=c("#B5E8FC", "#09B6FC", "#055df5", "#0600a8"), #colors for the legend lines, cycles through
       lty=c(3, 3, 3, 3, 1, 1, 1, 1), #line type for legend lines
       lwd=5, #line width for legend lines
       cex=1) #font size
```

### Figure 2 Panels {.tabset}
#### Figure 2A - 0.001
```{r}
Ef_Pr_0.001<-subset(Ef_Pr,secondary_dose=="0.001")
#table(Ef_Pr_0.001$primary)
#THE GRAPH
#png(file="Figure2A.png",width=1200,height=900,res=130)
par(mar=c(6,5,1,1)) #sets the margins around the graph so there is room for the labels
plot(survfit(Surv(day, status) ~ primary + secondary_dose, data=Ef_Pr_0.001), col=c("#003694"), lty=c(3, 1), lwd=5,yaxt='n', xaxt='n', ylab="proportion alive", xlab="days post-secondary infection", cex.lab=2.5, xlim=c(0,7), xaxs='i') 
axis(2, las=2, cex.axis=1.5, lwd=5)
axis(1, cex.axis=1.5, lwd=5)
box(lwd=5)

#THE LEGEND
legend("topright",inset=0, bty="n" , c("secondary infection only (n=101)", "chronic & secondary infection (n=110)"),col=c("#003694"),lty=c(3, 1),lwd=5, cex=1.8)
#dev.off()
```

#### Figure 2B - 0.01
```{r}
Ef_Pr_0.01<-subset(Ef_Pr,secondary_dose=="0.01")
#table(Ef_Pr_0.01$primary)
#THE GRAPH
#png(file="Figure2B.png",width=1200,height=900,res=130)
par(mar=c(6,5,1,1)) #sets the margins around the graph so there is room for the labels
plot(survfit(Surv(day, status) ~ primary + secondary_dose, data=Ef_Pr_0.01), col=c("#003694"), lty=c(3, 1), lwd=5,yaxt='n', xaxt='n', ylab="proportion alive", xlab="days post-secondary infection", cex.lab=2.5, xlim=c(0,7), xaxs='i') 
axis(2, las=2, cex.axis=1.5, lwd=5)
axis(1, cex.axis=1.5, lwd=5)
box(lwd=5)

#THE LEGEND
legend("topright",inset=0, bty="n" , c("secondary infection only (n=148)", "chronic & secondary infection (n=119)"),col=c("#003694"),lty=c(3, 1),lwd=5, cex=1.8)
#dev.off()
```

#### Figure 2C - 0.1
```{r}
Ef_Pr_0.1<-subset(Ef_Pr,secondary_dose=="0.1")
#table(Ef_Pr_0.1$primary)
#THE GRAPH
#png(file="Figure2C.png",width=1200,height=900,res=130)
par(mar=c(6,5,1,1)) #sets the margins around the graph so there is room for the labels
plot(survfit(Surv(day, status) ~ primary + secondary_dose, data=Ef_Pr_0.1), col=c("#003694"), lty=c(3, 1), lwd=5,yaxt='n', xaxt='n', ylab="proportion alive", xlab="days post-secondary infection", cex.lab=2.5, xlim=c(0,7), xaxs='i') 
axis(2, las=2, cex.axis=1.5, lwd=5)
axis(1, cex.axis=1.5, lwd=5)
box(lwd=5)

#THE LEGEND
legend("topright",inset=0, bty="n" , c("secondary infection only (n=160)", "chronic & secondary infection (n=115)"),col=c("#003694"),lty=c(3, 1),lwd=5, cex=1.8)
#dev.off()
```

#### Figure 2D - 1.0
```{r}
Ef_Pr_1.0<-subset(Ef_Pr,secondary_dose=="1")
#table(Ef_Pr_1.0$primary)
#THE GRAPH
#png(file="Figure2D.png",width=1200,height=900,res=130)
par(mar=c(6,5,1,1)) #sets the margins around the graph so there is room for the labels
plot(survfit(Surv(day, status) ~ primary + secondary_dose, data=Ef_Pr_1.0), col=c("#003694"), lty=c(3, 1), lwd=5,yaxt='n', xaxt='n', ylab="proportion alive", xlab="days post-secondary infection", cex.lab=2.5, xlim=c(0,7), xaxs='i') 
axis(2, las=2, cex.axis=1.5, lwd=5)
axis(1, cex.axis=1.5, lwd=5)
box(lwd=5)

#THE LEGEND
legend("topright",inset=0, bty="n" , c("secondary infection only (n=157)", "chronic & secondary infection (n=125)"),col=c("#003694"),lty=c(3, 1),lwd=5, cex=1.8)
#dev.off()
```

### Figure 2
```{r Figure 2, message = FALSE}
g <- ggdraw() +
  draw_image("Figure2A.png")

h <- ggdraw() +
  draw_image("Figure2B.png")

i <- ggdraw() +
  draw_image("Figure2C.png")

j <- ggdraw() +
  draw_image("Figure2D.png")


multiplot <- g + h + i + j
y <- multiplot + 
  plot_annotation(tag_levels = 'A')
ggsave("Fig.2.ChronicEf_Pr.pdf", y, device = "pdf")
y


```

### Individual Blocks {.tabset}
#### Block 1
```{r}
Ef_Pr_block1 <- subset(Ef_Pr, Date == "6/11/2019")

table(Ef_Pr_block1 $primary, Ef_Pr_block1 $secondary_dose)

#Ef_Pr_0.001_1<-subset(Ef_Pr_block1, secondary_dose=="2")
#table(Ef_Pr_0.001_1$primary)
Ef_Pr_0.01_1<-subset(Ef_Pr_block1, secondary_dose=="0.01")
#table(Ef_Pr_0.01_1$primary)
Ef_Pr_0.1_1<-subset(Ef_Pr_block1, secondary_dose=="0.1")
#table(Ef_Pr_0.1_1$primary)
Ef_Pr_1.0_1<-subset(Ef_Pr_block1, secondary_dose=="1")
#table(Ef_Pr_1.0_1$primary)

surv_Ef_Pr_0.01_1<-survdiff(Surv(day, status) ~ primary, data=Ef_Pr_0.01_1)
surv_Ef_Pr_0.01_1

surv_Ef_Pr_0.1_1<-survdiff(Surv(day, status) ~ primary, data=Ef_Pr_0.1_1)
surv_Ef_Pr_0.1_1

surv_Ef_Pr_1.0_1<-survdiff(Surv(day, status) ~ primary, data=Ef_Pr_1.0_1)
surv_Ef_Pr_1.0_1


par(mar=c(4,5,1,1))
plot(survfit(Surv(Ef_Pr_block1$day, Ef_Pr_block1$status) ~ Ef_Pr_block1$primary + Ef_Pr_block1$secondary_dose), col=c("#09B6FC", "#055df5", "#003694"), lty=c(3, 3, 3, 1, 1, 1), lwd=5,yaxt='n', xaxt='n', ylab="proportion alive", xlab="days post-secondary infection", cex.lab=2.5, xlim=c(0,7), xaxs='i')
axis(2, las=2, cex.axis=1.5, lwd=5)
axis(1, cex.axis=1.5, lwd=5)
box(lwd=5)
legend("topright",inset=0, bty="n" , c("PBS-P.rett 0.01", "PBS-P.rett 0.1", 'PBS-P.rett 1.0', "E.fae-P.rett 0.01", "E.fae-P.rett 0.1", "E.fae-P.rett 1.0"),col=c("#09B6FC", "#055df5", "#003694"),lty=c(3, 3, 3, 1, 1, 1),lwd=5, cex=1)
```

#### Block 2
```{r}
Ef_Pr_block2 <- subset(Ef_Pr, Date == "6/22/2018")


table(Ef_Pr_block2 $primary, Ef_Pr_block2 $secondary_dose)

Ef_Pr_0.001_2<-subset(Ef_Pr_block2, secondary_dose=="0.001")
table(Ef_Pr_0.001_2$primary)
Ef_Pr_0.01_2<-subset(Ef_Pr_block2, secondary_dose=="0.01")
#table(Ef_Pr_0.01_2$primary)
Ef_Pr_0.1_2<-subset(Ef_Pr_block2, secondary_dose=="0.1")
#table(Ef_Pr_0.1_2$primary)
Ef_Pr_1.0_2<-subset(Ef_Pr_block2, secondary_dose=="1")
#table(Ef_Pr_1.0_2$primary)

surv_Ef_Pr_0.001_2<-survdiff(Surv(day, status) ~ primary, data=Ef_Pr_0.001_2)
surv_Ef_Pr_0.001_2

surv_Ef_Pr_0.01_2<-survdiff(Surv(day, status) ~ primary, data=Ef_Pr_0.01_2)
surv_Ef_Pr_0.01_2

surv_Ef_Pr_0.1_2<-survdiff(Surv(day, status) ~ primary, data=Ef_Pr_0.1_2)
surv_Ef_Pr_0.1_2

surv_Ef_Pr_1.0_2<-survdiff(Surv(day, status) ~ primary, data=Ef_Pr_1.0_2)
surv_Ef_Pr_1.0_2

par(mar=c(4,5,1,1))
plot(survfit(Surv(Ef_Pr_block2$day, Ef_Pr_block2$status) ~ Ef_Pr_block2$primary + Ef_Pr_block2$secondary_dose), col=c("#B5E8FC",  "#09B6FC", "#055df5", "#003694"), lty=c(3, 3, 3, 3, 1, 1, 1, 1), lwd=5,yaxt='n', xaxt='n', ylab="proportion alive", xlab="days post-secondary infection", cex.lab=2.5, xlim=c(0,7), xaxs='i')
axis(2, las=2, cex.axis=1.5, lwd=5)
axis(1, cex.axis=1.5, lwd=5)
box(lwd=5)
legend("topright",inset=0, bty="n" , c("PBS-P.rett 0.001", "PBS-P.rett 0.01", "PBS-P.rett 0.1", 'PBS-P.rett 1.0', "E.fae-P.rett 0.001", "E.fae-P.rett 0.01", "E.fae-P.rett 0.1", "E.fae-P.rett 1.0"),col=c("#B5E8FC", "#09B6FC", "#055df5", "#003694"),lty=c(3, 3, 3, 3, 1, 1, 1, 1),lwd=5, cex=1)
```

#### Block 3
```{r}
Ef_Pr_block3 <- subset(Ef_Pr, Date == "6/25/2018")

table(Ef_Pr_block3 $primary, Ef_Pr_block3 $secondary_dose)

Ef_Pr_0.001_3<-subset(Ef_Pr_block3, secondary_dose=="0.001")
table(Ef_Pr_0.001_3$primary)
Ef_Pr_0.01_3<-subset(Ef_Pr_block3, secondary_dose=="0.01")
#table(Ef_Pr_0.01_3$primary)
Ef_Pr_0.1_3<-subset(Ef_Pr_block3, secondary_dose=="0.1")
#table(Ef_Pr_0.1_3$primary)
Ef_Pr_1.0_3<-subset(Ef_Pr_block3, secondary_dose=="1")
#table(Ef_Pr_1.0_3$primary)

surv_Ef_Pr_0.001_3<-survdiff(Surv(day, status) ~ primary, data=Ef_Pr_0.001_3)
surv_Ef_Pr_0.001_3

surv_Ef_Pr_0.01_3<-survdiff(Surv(day, status) ~ primary, data=Ef_Pr_0.01_3)
surv_Ef_Pr_0.01_3

surv_Ef_Pr_0.1_3<-survdiff(Surv(day, status) ~ primary, data=Ef_Pr_0.1_3)
surv_Ef_Pr_0.1_3

surv_Ef_Pr_1.0_3<-survdiff(Surv(day, status) ~ primary, data=Ef_Pr_1.0_3)
surv_Ef_Pr_1.0_3


par(mar=c(4,5,1,1))
plot(survfit(Surv(Ef_Pr_block3$day, Ef_Pr_block3$status) ~ Ef_Pr_block3$primary + Ef_Pr_block3$secondary_dose), col=c("#B5E8FC",  "#09B6FC", "#055df5", "#003694"), lty=c(3, 3, 3, 3, 1, 1, 1, 1), lwd=5,yaxt='n', xaxt='n', ylab="proportion alive", xlab="days post-secondary infection", cex.lab=2.5, xlim=c(0,7), xaxs='i')
axis(2, las=2, cex.axis=1.5, lwd=5)
axis(1, cex.axis=1.5, lwd=5)
box(lwd=5)
legend("topright",inset=0, bty="n" , c("PBS-P.rett 0.001", "PBS-P.rett 0.01", "PBS-P.rett 0.1", 'PBS-P.rett 1.0', "E.fae-P.rett 0.001", "E.fae-P.rett 0.01", "E.fae-P.rett 0.1", "E.fae-P.rett 1.0"),col=c("#B5E8FC", "#09B6FC", "#055df5", "#003694"),lty=c(3, 3, 3, 3, 1, 1, 1, 1),lwd=5, cex=1)
```

#### Block 4
Not sure why the data stops after 3 days, Frank did this one
```{r}
Ef_Pr_block4 <- subset(Ef_Pr, Date == "7/19/2018")

table(Ef_Pr_block4 $primary, Ef_Pr_block4 $secondary_dose)

Ef_Pr_0.001_4<-subset(Ef_Pr_block4, secondary_dose=="0.001")
#table(Ef_Pr_0.001_4$primary)
Ef_Pr_0.01_4<-subset(Ef_Pr_block4, secondary_dose=="0.01")
#table(Ef_Pr_0.01_4$primary)
Ef_Pr_0.1_4<-subset(Ef_Pr_block4, secondary_dose=="0.1")
#table(Ef_Pr_0.1_4$primary)
Ef_Pr_1.0_4<-subset(Ef_Pr_block4, secondary_dose=="1")
#table(Ef_Pr_1.0_4$primary)

surv_Ef_Pr_0.001_4<-survdiff(Surv(day, status) ~ primary, data=Ef_Pr_0.001_4)
surv_Ef_Pr_0.001_4

surv_Ef_Pr_0.01_4<-survdiff(Surv(day, status) ~ primary, data=Ef_Pr_0.01_4)
surv_Ef_Pr_0.01_4

surv_Ef_Pr_0.1_4<-survdiff(Surv(day, status) ~ primary, data=Ef_Pr_0.1_4)
surv_Ef_Pr_0.1_4

surv_Ef_Pr_1.0_4<-survdiff(Surv(day, status) ~ primary, data=Ef_Pr_1.0_4)
surv_Ef_Pr_1.0_4

par(mar=c(4,5,1,1))
plot(survfit(Surv(Ef_Pr_block4$day, Ef_Pr_block4$status) ~ Ef_Pr_block4$primary + Ef_Pr_block4$secondary_dose), col=c("#B5E8FC",  "#09B6FC", "#055df5", "#003694"), lty=c(3, 3, 3, 3, 1, 1, 1, 1), lwd=5,yaxt='n', xaxt='n', ylab="proportion alive", xlab="days post-secondary infection", cex.lab=2.5, xlim=c(0,7), xaxs='i')
axis(2, las=2, cex.axis=1.5, lwd=5)
axis(1, cex.axis=1.5, lwd=5)
box(lwd=5)

legend("topright",inset=0, bty="n" , c("PBS-P.rett 0.001", "PBS-P.rett 0.01", "PBS-P.rett 0.1", 'PBS-P.rett 1.0', "E.fae-P.rett 0.001", "E.fae-P.rett 0.01", "E.fae-P.rett 0.1", "E.fae-P.rett 1.0"),col=c("#B5E8FC", "#09B6FC", "#055df5", "#003694"),lty=c(3, 3, 3, 3, 1, 1, 1, 1),lwd=5, cex=1)
```

#### Block 5
```{r}
Ef_Pr_block5 <- subset(Ef_Pr, Date == "6/3/2019")

table(Ef_Pr_block5 $primary, Ef_Pr_block5 $secondary_dose)

Ef_Pr_0.001_5<-subset(Ef_Pr_block5, secondary_dose=="0.001")
table(Ef_Pr_0.001_5$primary)
Ef_Pr_0.01_5<-subset(Ef_Pr_block5, secondary_dose=="0.01")
#table(Ef_Pr_0.01_5$primary)
Ef_Pr_0.1_5<-subset(Ef_Pr_block5, secondary_dose=="0.1")
#table(Ef_Pr_0.1_5$primary)
Ef_Pr_1.0_5<-subset(Ef_Pr_block5, secondary_dose=="1")
#table(Ef_Pr_1.0_5$primary)

surv_Ef_Pr_0.001_5<-survdiff(Surv(day, status) ~ primary, data=Ef_Pr_0.001_5)
surv_Ef_Pr_0.001_5

surv_Ef_Pr_0.01_5<-survdiff(Surv(day, status) ~ primary, data=Ef_Pr_0.01_5)
surv_Ef_Pr_0.01_5

surv_Ef_Pr_0.1_5<-survdiff(Surv(day, status) ~ primary, data=Ef_Pr_0.1_5)
surv_Ef_Pr_0.1_5

surv_Ef_Pr_1.0_5<-survdiff(Surv(day, status) ~ primary, data=Ef_Pr_1.0_5)
surv_Ef_Pr_1.0_5

par(mar=c(4,5,1,1))
plot(survfit(Surv(Ef_Pr_block5$day, Ef_Pr_block5$status) ~ Ef_Pr_block5$primary + Ef_Pr_block5$secondary_dose), col=c("#B5E8FC",  "#09B6FC", "#055df5", "#003694"), lty=c(3, 3, 3, 3, 1, 1, 1, 1), lwd=5,yaxt='n', xaxt='n', ylab="proportion alive", xlab="days post-secondary infection", cex.lab=2.5, xlim=c(0,7), xaxs='i')
axis(2, las=2, cex.axis=1.5, lwd=5)
axis(1, cex.axis=1.5, lwd=5)
box(lwd=5)
legend("topright",inset=0, bty="n" , c("PBS-P.rett 0.001", "PBS-P.rett 0.01", "PBS-P.rett 0.1", 'PBS-P.rett 1.0', "E.fae-P.rett 0.001", "E.fae-P.rett 0.01", "E.fae-P.rett 0.1", "E.fae-P.rett 1.0"),col=c("#B5E8FC", "#09B6FC", "#055df5", "#003694"),lty=c(3, 3, 3, 3, 1, 1, 1, 1),lwd=5, cex=1)
```

#### Block 6
```{r}
Ef_Pr_block6 <- subset(Ef_Pr, Date == "6/5/2019")

table(Ef_Pr_block6 $primary, Ef_Pr_block6 $secondary_dose)

Ef_Pr_0.001_6<-subset(Ef_Pr_block6, secondary_dose=="0.001")
table(Ef_Pr_0.001_6$primary)
Ef_Pr_0.01_6<-subset(Ef_Pr_block6, secondary_dose=="0.01")
#table(Ef_Pr_0.01_6$primary)
Ef_Pr_0.1_6<-subset(Ef_Pr_block6, secondary_dose=="0.1")
#table(Ef_Pr_0.1_6$primary)
Ef_Pr_1.0_6<-subset(Ef_Pr_block6, secondary_dose=="1")
#table(Ef_Pr_1.0_6$primary)

surv_Ef_Pr_0.001_6<-survdiff(Surv(day, status) ~ primary, data=Ef_Pr_0.001_6)
surv_Ef_Pr_0.001_6

surv_Ef_Pr_0.01_6<-survdiff(Surv(day, status) ~ primary, data=Ef_Pr_0.01_6)
surv_Ef_Pr_0.01_6

surv_Ef_Pr_0.1_6<-survdiff(Surv(day, status) ~ primary, data=Ef_Pr_0.1_6)
surv_Ef_Pr_0.1_6

surv_Ef_Pr_1.0_6<-survdiff(Surv(day, status) ~ primary, data=Ef_Pr_1.0_6)
surv_Ef_Pr_1.0_6

par(mar=c(4,5,1,1))
plot(survfit(Surv(Ef_Pr_block6$day, Ef_Pr_block6$status) ~ Ef_Pr_block6$primary + Ef_Pr_block6$secondary_dose), col=c("#B5E8FC",  "#09B6FC", "#055df5", "#003694"), lty=c(3, 3, 3, 3, 1, 1, 1, 1), lwd=5,yaxt='n', xaxt='n', ylab="proportion alive", xlab="days post-secondary infection", cex.lab=2.5, xlim=c(0,7), xaxs='i')
axis(2, las=2, cex.axis=1.5, lwd=5)
axis(1, cex.axis=1.5, lwd=5)
box(lwd=5)
legend("topright",inset=0, bty="n" , c("PBS-P.rett 0.001", "PBS-P.rett 0.01", "PBS-P.rett 0.1", 'PBS-P.rett 1.0', "E.fae-P.rett 0.001", "E.fae-P.rett 0.01", "E.fae-P.rett 0.1", "E.fae-P.rett 1.0"),col=c("#B5E8FC", "#09B6FC", "#055df5", "#003694"),lty=c(3, 3, 3, 3, 1, 1, 1, 1),lwd=5, cex=1)
```

#### Block 7
```{r}
Ef_Pr_block7 <- subset(Ef_Pr, Date == "7/1/2019")

table(Ef_Pr_block7 $primary, Ef_Pr_block7 $secondary_dose)

#Ef_Pr_0.001_7<-subset(Ef_Pr_block3, secondary_dose=="0.001")
#table(Ef_Pr_0.001_7$primary)
Ef_Pr_0.01_7<-subset(Ef_Pr_block3, secondary_dose=="0.01")
#table(Ef_Pr_0.01_7$primary)
Ef_Pr_0.1_7<-subset(Ef_Pr_block3, secondary_dose=="0.1")
#table(Ef_Pr_0.1_7$primary)
Ef_Pr_1.0_7<-subset(Ef_Pr_block3, secondary_dose=="1")
#table(Ef_Pr_1.0_7$primary)

#surv_Ef_Pr_0.001_7<-survdiff(Surv(day, status) ~ primary, data=Ef_Pr_0.001_7)
#surv_Ef_Pr_0.001_7

surv_Ef_Pr_0.01_7<-survdiff(Surv(day, status) ~ primary, data=Ef_Pr_0.01_7)
surv_Ef_Pr_0.01_7

surv_Ef_Pr_0.1_7<-survdiff(Surv(day, status) ~ primary, data=Ef_Pr_0.1_7)
surv_Ef_Pr_0.1_7

surv_Ef_Pr_1.0_7<-survdiff(Surv(day, status) ~ primary, data=Ef_Pr_1.0_7)
surv_Ef_Pr_1.0_7

par(mar=c(4,5,1,1))
plot(survfit(Surv(Ef_Pr_block7$day, Ef_Pr_block7$status) ~ Ef_Pr_block7$primary + Ef_Pr_block7$secondary_dose), col=c("#09B6FC", "#055df5", "#003694"), lty=c(3, 3, 3, 1, 1, 1), lwd=5,yaxt='n', xaxt='n', ylab="proportion alive", xlab="days post-secondary infection", cex.lab=2.5, xlim=c(0,7), xaxs='i')
axis(2, las=2, cex.axis=1.5, lwd=5)
axis(1, cex.axis=1.5, lwd=5)
box(lwd=5)
legend("topright",inset=0, bty="n" , c("PBS-P.rett 0.01", "PBS-P.rett 0.1", 'PBS-P.rett 1.0', "E.fae-P.rett 0.01", "E.fae-P.rett 0.1", "E.fae-P.rett 1.0"),col=c("#09B6FC", "#055df5", "#003694"),lty=c(3, 3, 3,  1, 1, 1),lwd=5, cex=1)
```

### Statistical Tests

  + In order test whether there was protection provided by chronic infection for each secondary infectious dose, p-values from the log rank test for each date was combined using the Fisher’s test (experiments on all dates showed higher survival in conditions with chronic infection). Final p-value is reported in the text.

```{r}

# Grab p-values from each individual logrank test (results shown above in each block)
pvalue_Ef_Pr_0.01_1<-pchisq(surv_Ef_Pr_0.01_1$chisq, df=1, lower.tail=F)
pvalue_Ef_Pr_0.1_1<-pchisq(surv_Ef_Pr_0.1_1$chisq, df=1, lower.tail=F)
pvalue_Ef_Pr_1.0_1<-pchisq(surv_Ef_Pr_1.0_1$chisq, df=1, lower.tail=F)

pvalue_Ef_Pr_0.001_2<-pchisq(surv_Ef_Pr_0.001_2$chisq, df=1, lower.tail=F)
pvalue_Ef_Pr_0.01_2<-pchisq(surv_Ef_Pr_0.01_2$chisq, df=1, lower.tail=F)
pvalue_Ef_Pr_0.1_2<-pchisq(surv_Ef_Pr_0.1_2$chisq, df=1, lower.tail=F)
pvalue_Ef_Pr_1.0_2<-pchisq(surv_Ef_Pr_1.0_2$chisq, df=1, lower.tail=F)

pvalue_Ef_Pr_0.001_3<-pchisq(surv_Ef_Pr_0.001_3$chisq, df=1, lower.tail=F)
pvalue_Ef_Pr_0.01_3<-pchisq(surv_Ef_Pr_0.01_3$chisq, df=1, lower.tail=F)
pvalue_Ef_Pr_0.1_3<-pchisq(surv_Ef_Pr_0.1_3$chisq, df=1, lower.tail=F)
pvalue_Ef_Pr_1.0_3<-pchisq(surv_Ef_Pr_1.0_3$chisq, df=1, lower.tail=F)

pvalue_Ef_Pr_0.001_4<-pchisq(surv_Ef_Pr_0.001_4$chisq, df=1, lower.tail=F)
pvalue_Ef_Pr_0.01_4<-pchisq(surv_Ef_Pr_0.01_4$chisq, df=1, lower.tail=F)
pvalue_Ef_Pr_0.1_4<-pchisq(surv_Ef_Pr_0.1_4$chisq, df=1, lower.tail=F)
pvalue_Ef_Pr_1.0_4<-pchisq(surv_Ef_Pr_1.0_4$chisq, df=1, lower.tail=F)

pvalue_Ef_Pr_0.001_5<-pchisq(surv_Ef_Pr_0.001_5$chisq, df=1, lower.tail=F)
pvalue_Ef_Pr_0.01_5<-pchisq(surv_Ef_Pr_0.01_5$chisq, df=1, lower.tail=F)
pvalue_Ef_Pr_0.1_5<-pchisq(surv_Ef_Pr_0.1_5$chisq, df=1, lower.tail=F)
pvalue_Ef_Pr_1.0_5<-pchisq(surv_Ef_Pr_1.0_5$chisq, df=1, lower.tail=F)

pvalue_Ef_Pr_0.001_6<-pchisq(surv_Ef_Pr_0.001_6$chisq, df=1, lower.tail=F)
pvalue_Ef_Pr_0.01_6<-pchisq(surv_Ef_Pr_0.01_6$chisq, df=1, lower.tail=F)
pvalue_Ef_Pr_0.1_6<-pchisq(surv_Ef_Pr_0.1_6$chisq, df=1, lower.tail=F)
pvalue_Ef_Pr_1.0_6<-pchisq(surv_Ef_Pr_1.0_6$chisq, df=1, lower.tail=F)

pvalue_Ef_Pr_0.01_7<-pchisq(surv_Ef_Pr_0.01_7$chisq, df=1, lower.tail=F)
pvalue_Ef_Pr_0.1_7<-pchisq(surv_Ef_Pr_0.1_7$chisq, df=1, lower.tail=F)
pvalue_Ef_Pr_1.0_7<-pchisq(surv_Ef_Pr_1.0_7$chisq, df=1, lower.tail=F)

```


```{r}
# Use all p-values from a given condition to get Fisher's combined test p-value# Use all p-values from a given condition to get Fisher's combined test p-value
pvalues_Ef_Pr_0.001 <- c(pvalue_Ef_Pr_0.001_2,pvalue_Ef_Pr_0.001_3,pvalue_Ef_Pr_0.001_4,pvalue_Ef_Pr_0.001_5,pvalue_Ef_Pr_0.001_6)
test.stat_Ef_Pr_0.001 <- -2*sum(log(pvalues_Ef_Pr_0.001))
pfinal_Ef_Pr_0.001<-pchisq(test.stat_Ef_Pr_0.001, df=2*length(pvalues_Ef_Pr_0.001), lower.tail=F)

pvalues_Ef_Pr_0.01 <- c(pvalue_Ef_Pr_0.01_1,pvalue_Ef_Pr_0.01_2,pvalue_Ef_Pr_0.01_3,pvalue_Ef_Pr_0.01_4,pvalue_Ef_Pr_0.01_5,pvalue_Ef_Pr_0.01_6, pvalue_Ef_Pr_0.01_7)
test.stat_Ef_Pr_0.01 <- -2*sum(log(pvalues_Ef_Pr_0.01))
pfinal_Ef_Pr_0.01<-pchisq(test.stat_Ef_Pr_0.01, df=2*length(pvalues_Ef_Pr_0.01), lower.tail=F)


pvalues_Ef_Pr_0.1 <- c(pvalue_Ef_Pr_0.1_1,pvalue_Ef_Pr_0.1_2,pvalue_Ef_Pr_0.1_3,pvalue_Ef_Pr_0.1_4,pvalue_Ef_Pr_0.1_5,pvalue_Ef_Pr_0.1_6,pvalue_Ef_Pr_0.1_7)
test.stat_Ef_Pr_0.1 <- -2*sum(log(pvalues_Ef_Pr_0.1))
pfinal_Ef_Pr_0.1<-pchisq(test.stat_Ef_Pr_0.1, df=2*length(pvalues_Ef_Pr_0.1), lower.tail=F)

pvalues_Ef_Pr_1.0 <- c(pvalue_Ef_Pr_1.0_1,pvalue_Ef_Pr_1.0_2,pvalue_Ef_Pr_1.0_3,pvalue_Ef_Pr_1.0_4,pvalue_Ef_Pr_1.0_5,pvalue_Ef_Pr_1.0_6,pvalue_Ef_Pr_1.0_7)
test.stat_Ef_Pr_1.0 <- -2*sum(log(pvalues_Ef_Pr_1.0))
pfinal_Ef_Pr_1.0<-pchisq(test.stat_Ef_Pr_1.0, df=2*length(pvalues_Ef_Pr_1.0), lower.tail=F)

```


```{r}
####  Generate Table of final results
pvalues_Ef_Pr_0.001_table <- c(NA,pvalue_Ef_Pr_0.001_2,pvalue_Ef_Pr_0.001_3,pvalue_Ef_Pr_0.001_4,pvalue_Ef_Pr_0.001_5,pvalue_Ef_Pr_0.001_6,NA)
p_Ef_Pr_0.001<-scales::pvalue(pvalues_Ef_Pr_0.001_table)
p_Ef_Pr_0.001 <- p_Ef_Pr_0.001 %>% replace_na("--")

pvalues_Ef_Pr_0.01_table <- c(pvalue_Ef_Pr_0.01_1,pvalue_Ef_Pr_0.01_2,pvalue_Ef_Pr_0.01_3,pvalue_Ef_Pr_0.01_4,pvalue_Ef_Pr_0.01_5,pvalue_Ef_Pr_0.01_6,pvalue_Ef_Pr_0.01_7)
p_Ef_Pr_0.01<-scales::pvalue(pvalues_Ef_Pr_0.01_table)

pvalues_Ef_Pr_0.1_table <- c(pvalue_Ef_Pr_0.1_1,pvalue_Ef_Pr_0.1_2,pvalue_Ef_Pr_0.1_3,pvalue_Ef_Pr_0.1_4,pvalue_Ef_Pr_0.1_5,pvalue_Ef_Pr_0.1_6,pvalue_Ef_Pr_0.1_7)
p_Ef_Pr_0.1<-scales::pvalue(pvalues_Ef_Pr_0.1_table)

pvalues_Ef_Pr_1.0_table <- c(pvalue_Ef_Pr_1.0_1,pvalue_Ef_Pr_1.0_2,pvalue_Ef_Pr_1.0_3,pvalue_Ef_Pr_1.0_4,pvalue_Ef_Pr_1.0_5,pvalue_Ef_Pr_1.0_6,pvalue_Ef_Pr_1.0_7)
p_Ef_Pr_1.0<-scales::pvalue(pvalues_Ef_Pr_1.0_table)



pvalue_table_Ef_Pr <- data.frame("0.001" = p_Ef_Pr_0.001, "0.01" = p_Ef_Pr_0.01, "0.1" = p_Ef_Pr_0.1, "1.0" = p_Ef_Pr_1.0)
colnames(pvalue_table_Ef_Pr) <- c(0.001,0.01, 0.1, 1.0)

pfisher_Ef_Pr<- c(pfinal_Ef_Pr_0.001, pfinal_Ef_Pr_0.01, pfinal_Ef_Pr_0.1, pfinal_Ef_Pr_1.0)
pfisher_Ef_Pr<-scales::pvalue(pfisher_Ef_Pr)
pvalue_table_Ef_Pr[nrow(pvalue_table_Ef_Pr) + 1,]<-pfisher_Ef_Pr

row.names(pvalue_table_Ef_Pr) <- c("Block 1 - June 11th, 2018", "Block 2 - June 22nd, 2018", "Block 3 - June 25th, 2018", "Block 4 - July 19th, 2018", "Block 5 - June 3, 2019", "Block 6 - June 5, 2019", "Block 7 - July 1st, 2019", " Final P-value ")

pvalue_table_Ef_Pr %>%
  kbl(caption = "<center><strong>P-values for log-rank tests on individual doses within each experiment<center><strong>") %>%
   kable_classic(full_width = F, html_font = "Cambria", position = "center")%>%
    add_header_above(c(" "=1, "Infectious Dose (Abs600nm)" = 4)) %>%
    pack_rows("Individual Blocks", 1, 7) %>%
    pack_rows("Fisher's Combined", 8, 8)


```

  + **Conclusion:** Chronic infection with *E. faecalis* offered significat protection against three out of the four doses. However, the one dose that did not show significant protection (Abs600nm = 0.1) had a borderline p-value = 0.06
  
# Q2 Does having a primary infection influence resistance to secondary infection with *P. rettgeri*? {.tabset}

**Study design:**
![](./Figure3Scheme.png)

  + Bacterial load of *P. rettgeri* was determined at 10 hours post-secondary infection
  + For *S. marcescens*-*P. rettgeri*, the load was determined by isolating pooled DNA from 5 flies for each condition and using qPCR primer specific for a *P. rettgeri* gene to assess the relative number of bacteria. This was converted to approximate bacterial load by using a conversion factor based on qPCR and CFU results for flies injected with 20nL of 0.1 Abs600nm of *P. rettgeri* and then immediately homogenized.
  + For *E. faecalis* - *P. rettgeri*, the *P. rettgeri* load was determined using a Colony Forming Unit (CFU) assay using antibiotics to select for *P. rettgeri* and kill *E. faecalis*.
  + All analyses are with linear modeling followed by anova, with a shapiro test on residuals to assess normality.
  + **Conclusions**
    + As expected based on previously published results (Chambers et al 2019), **infectious dose of the secondary** *P. rettgeri* **infection** significantly impacted bacterial load 10 hours after infection (p<0.0001)
    + **Chronic infection** with *S. marcescens* and *E. faecalis* both resulted in lowered calculated bacterial load post secondary infection (p<0.0001).
    + There was no significant interaction between **chronic infection** and **secondary infectious dose** for either *S. marcescens* or *E. faecalis* chronic infection (p=0.30 and 0.78 respectively)
    + Residuals pass normality test (Shapiro-Wilk Normality test: p=0.72 and 0.79 respectively)

## *S. marcescens* chronic infection {.tabset}
  + The calculated bacterial load after secondary infection with P. rettgeri for flies chronically infected with S. marcescens versus control flies.
  + As expected based on previously published results (Chambers et al 2019), **infectious dose of the secondary P. rettgeri infection** significantly impacted bacterial load 10 hours after infection (secondary_dose, p<0.0001)
  + **Primary infection** with S. marcescens resulted in lowered calculated bacterial load post secondary infection (primary, p<0.0001).
  + There was no significant interaction between **primary infection** and **secondary infectious dose** (p=0.30)
  + Residuals pass normality test (Shapiro-Wilk Normality test: p=0.72)

### Graph
```{r}
#png(file="Figure3A.png", width=3200, height=1800, res=300)
ggplot(Sm_bacterial_load, aes(x = as.character(secondary_dose), y = log(load_10hr), fill = primary)) +
  scale_fill_manual(values=c("white", "#3399FF"), 
                       name=" ",
                       breaks=c("01_PBS","02_Sm"),
                       labels=c("control", "chronically infected")) +
  geom_boxplot() +
  #ggtitle("S. marcescens chronic infection") +
  theme_classic(base_size = 24) +
  xlab("secondary dose (Abs600nm)") +
  ylab("log(calculated bacterial load)") +
  guides(fill=guide_legend(title=NULL)) +
  geom_point(color = "black", size = 1.3, position=position_jitterdodge(jitter.width=0.2))
#dev.off()
```

### Statistics
```{r}


S.m_resistance <- lm(log(load_10hr) ~ rep + secondary_dose + primary + secondary_dose:primary, data = Sm_bacterial_load)
S.m_resistance_anova <- anova(S.m_resistance)
S.m_resistance_anova

shapiro.test(resid(S.m_resistance))
```

## *E. faecalis* chronic infection {.tabset}
  + The bacterial load after secondary infection with P. rettgeri for flies chronically infected with E. faecalis versus control flies.
  + As expected based on previously published results (Chambers et al 2019), **infectious dose of the secondary** *P. rettgeri* **infection** significantly impacted bacterial load 10 hours after infection (secondary_dose, p<0.0001)
  + **Primary infection** with *E. faecalis* resulted in lowered CFU/fly post secondary infection (*primary*, p = 0.0001).
  + There was no significant interaction between **primary infection** and **secondary infectious dose** (p=0.78)
  + Residuals pass normality test (Shapiro-Wilk Normality test: p=0.79)

### Graph
```{r}
#BACTERIAL LOAD
Ef_bacterial_load_10hr <- subset(Ef_bacterial_load, time == 10)

#png(file="Figure3B.png",width=3200, height=1800, res=300)
ggplot(Ef_bacterial_load_10hr, aes(x = as.character(secondary_dose), y = log(load), fill = primary)) +
  scale_fill_manual(values=c("white", "#3399FF"), 
                       name=" ",
                       breaks=c("01_PBS","02_Efae"),
                       labels=c("control", "chronically infected")) +
  geom_boxplot() +
  #ggtitle("E. faecalis chronic infection") +
  theme_classic(base_size = 24) +
  xlab("secondary dose (Abs600nm)") +
  ylab("log(CFU/fly)") +
  guides(fill=guide_legend(title=NULL)) +
  geom_point(color = "black", size = 1.3, position=position_jitterdodge(jitter.width=0.2))
#dev.off()
```

### Statistics
```{r}
E.fae_resistance <- lm(log(load) ~ replicate + secondary_dose + primary + secondary_dose:primary, data = Ef_bacterial_load_10hr)
E.fae_resistance_anova <- anova(E.fae_resistance)
E.fae_resistance_anova

shapiro.test(resid(E.fae_resistance))
```


## Figure 3
```{r Figure 3, message = FALSE}
k <- ggdraw() +
  ggtitle('P. rettgeri') +
  draw_image("Figure3A.png")

l <- ggdraw() +
  draw_image("Figure3B.png")

m <- ggdraw() +
  draw_image("Figure3C.png")

n <- ggdraw() +
  draw_image("Figure3D.png")

multiplot3 <- k + m + l + n

x<-multiplot3 
 
  #plot_annotation(tag_levels = 'A')
 
ggsave("Fig.3.ResistanceTolerance.pdf", x, device = "pdf")
x
 

```

# Q3 Does the protection conferred by primary infection with *S. marcescens* protect against infections that cause very high mortality? {.tabset}


**Study design:**
![](./Figure4Scheme.png)

  + Since we saw such robust protection with *S. marcescens*, we wanted to determine whether it also protected against a more lethal infection with *P. sneebia*.
   + Initially analyzed using Cox Proportional Hazards mixed effects model with date of injection, primary injection and secondary dose as fixed effects and random effect terms accounting for experimental structure (e.g. date of injection, housing of groups of flies in vials). However, this model violated the assumptions of Cox Proportional Hazards. 
    + Therefore we switched to using log-rank pairwise comparisons to determine whether chronic infection significantly impacted survival of secondary infection at an individual dose.
      + LogRank comparisons were done on data from each date individually
      + If experiments on all dates showed higher survival in conditions with chronic infection, p-values were combined using Fisher's test and only the final p-value is reported in the text.
      + If there was a variable effect of chronic infection, the number of individual experiments with significant effects is reported. 
    + **Conclusions** 
      + *S. marcescens* chronic infection provided significant protection during secondary infection with *P. sneebia* at all infectious doses (p<0.001)


## Total Graph
```{r, Sm_Ps survival data}
#table(Sm_Ps$primary, Sm_Ps$secondary_dose)

#png(file="Sm_Ps.png",  width = 1700, height = 1500, res = 300)
#par(mar=c(4,4,0.1,0.1)) #sets the margins around the graph so there is room for the labels
plot(survfit(Surv(Sm_Ps$hour, Sm_Ps$status) ~ Sm_Ps$primary + Sm_Ps$secondary_dose), col=c("gray", "#B5E8FC", "#75D6FD", "#09B6FC", "#055df5"), lty=c(3, 3, 3, 3, 3, 1, 1, 1, 1, 1), lwd=2.6, yaxt='n', xaxt='n', ylab="Proportion Alive", xlab="Hours Post-Secondary Infection", cex.lab=1.3, xlim=c(10,48), xaxs='i', ylim=c(0, 1.05), yaxs='i')
axis(2, las=2, cex.axis=1, lwd=4.5)
axis(1, cex.axis=1, lwd=4.5)
box(lwd=4.5)

legend("bottomleft", bty="n" , c("PBS-PBS", "PBS-0.001", "PBS-0.01", "PBS-0.1", "PBS-1.0", "S.m-PBS", "S.m-0.001", "S.m-0.01", "S.m-0.1", "S.m-1.0"),col=c("gray", "#B5E8FC", "#75D6FD", "#09B6FC", "#055df5"), lty=c(3, 3, 3, 3, 3, 1, 1, 1, 1, 1),lwd=4, cex=1)
```

## Appendix Figure 1B - Controls
```{r}
Sm_Ps_PBS<-subset(Sm_Ps,secondary_dose=="0")
#table(Sm_Ps_PBS$primary)

#THE GRAPH
#png(file="AFigure1B.png",width=1200,height=900,res=130)
par(mar=c(4,5,1,1)) #sets the margins around the graph so there is room for the labels
plot(survfit(Surv(day, status) ~ primary + secondary_dose, data=Sm_Ps_PBS), col=c("gray"), lty=c(3, 1), lwd=5,yaxt='n', xaxt='n', ylab="proportion alive", xlab="days post-secondary infection", cex.lab=2.5, xlim=c(0,7), xaxs='i') 
axis(2, las=2, cex.axis=1.5, lwd=5)
axis(1, cex.axis=1.5, lwd=5)
box(lwd=5)

#THE LEGEND
legend("bottomleft",inset=0, bty="n" , c("double injection control (n=59)", "chronic infection only (n=59)"),col=c("gray"),lty=c(3, 1),lwd=5, cex=1)
#dev.off()
```

## Individual Figure Panels {.tabset}

### Figure 4A - 0.001
```{r}
Sm_Ps_0.001<-subset(Sm_Ps,secondary_dose=="0.001")
#table(Sm_Ps_0.001$primary)
#THE GRAPH
#png(file="Figure4A.png",width=1200,height=900,res=130)
par(mar=c(6,5,1,1)) #sets the margins around the graph so there is room for the labels
plot(survfit(Surv(hour, status) ~ primary + secondary_dose, data=Sm_Ps_0.001), col=c("#003694"), lty=c(3, 1), lwd=5,yaxt='n', xaxt='n', ylab="proportion alive", xlab="hours post-secondary infection", cex.lab=2, xlim=c(0,72), xaxs='i') 
axis(2, las=2, cex.axis=1.5, lwd=5)
axis(1, cex.axis=1.5, lwd=5)
box(lwd=5)

#THE LEGEND
legend("bottomleft",inset=0, bty="n" , c("secondary infection only (n=82)", "chronic & secondary infection (n=66)"),col=c("#003694"),lty=c(3, 1),lwd=5, cex=1.6)
#dev.off()
```

### Figure 4B - 0.01
```{r}
Sm_Ps_0.01<-subset(Sm_Ps,secondary_dose=="0.01")
#table(Sm_Ps_0.01$primary)
#THE GRAPH
#png(file="Figure4B.png",width=1200,height=900,res=130)
par(mar=c(6,5,1,1)) #sets the margins around the graph so there is room for the labels
plot(survfit(Surv(hour, status) ~ primary + secondary_dose, data=Sm_Ps_0.01), col=c("#003694"), lty=c(3, 1), lwd=5,yaxt='n', xaxt='n', ylab="proportion alive", xlab="hours post-secondary infection", cex.lab=2, xlim=c(0,72), xaxs='i') 
axis(2, las=2, cex.axis=1.5, lwd=5)
axis(1, cex.axis=1.5, lwd=5)
box(lwd=5)

#THE LEGEND
legend("bottomleft",inset=0, bty="n" , c("secondary infection only (n=87)", "chronic & secondary infection (n=80)"),col=c("#003694"),lty=c(3, 1),lwd=5, cex=1.6)
#dev.off()
```

### Figure 4C - 0.1
```{r}
Sm_Ps_0.1<-subset(Sm_Ps,secondary_dose=="0.1")
#table(Sm_Ps_0.1$primary)
#THE GRAPH
#png(file="Figure4C.png",width=1200,height=900,res=130)
par(mar=c(6,5,1,1)) #sets the margins around the graph so there is room for the labels
plot(survfit(Surv(hour, status) ~ primary + secondary_dose, data=Sm_Ps_0.1), col=c("#003694"), lty=c(3, 1), lwd=5,yaxt='n', xaxt='n', ylab="proportion alive", xlab="hours post-secondary infection", cex.lab=2, xlim=c(0,72), xaxs='i') 
axis(2, las=2, cex.axis=1.5, lwd=5)
axis(1, cex.axis=1.5, lwd=5)
box(lwd=5)

#THE LEGEND
legend("topright",inset=0, bty="n" , c("secondary infection only (n=80)", "chronic & secondary infection (n=81)"),col=c("#003694"),lty=c(3, 1),lwd=5, cex=1.6)
#dev.off()
```

### Figure 4D - 1.0
```{r}
Sm_Ps_1.0<-subset(Sm_Ps,secondary_dose=="1")
#table(Sm_Ps_1.0$primary)
#png(file="Figure4D.png",width=1200,height=900,res=130)
par(mar=c(6,5,1,1)) #sets the margins around the graph so there is room for the labels
plot(survfit(Surv(hour, status) ~ primary + secondary_dose, data=Sm_Ps_1.0), col=c("#003694"), lty=c(3, 1), lwd=5,yaxt='n', xaxt='n', ylab="proportion alive", xlab="hours post-secondary infection", cex.lab=2, xlim=c(0,72), xaxs='i') 
axis(2, las=2, cex.axis=1.5, lwd=5)
axis(1, cex.axis=1.5, lwd=5)
box(lwd=5)

#THE LEGEND
legend("topright",inset=0, bty="n" , c("secondary infection only (n=75)", "chronic & secondary infection (n=81)"),col=c("#003694"),lty=c(3, 1),lwd=5, cex=1.6)
#dev.off()
```

## Figure 4
```{r Figure 4, message = FALSE}
m <- ggdraw() +
  draw_image("Figure4A.png")

n <- ggdraw() +
  draw_image("Figure4B.png")

o <- ggdraw() +
  ggtitle('P. rettgeri') +
  draw_image("Figure4C.png")

p <- ggdraw() +
  draw_image("Figure4D.png")


multiplot3 <- m + n + o + p

w<-multiplot3 +
 
  plot_annotation(tag_levels = 'A')
 
ggsave("Fig.4.Psneebia.pdf", w, device = "pdf")
w
 

```

## Individual Blocks {.tabset}
### Block 1
```{r, S.m-P.snee 10/1/2020}
Sm_Ps_block1 <- subset(Sm_Ps, date == "10/1/2020")
table(Sm_Ps_block1$primary, Sm_Ps_block1$secondary_dose)

#subset by secondary dose
Sm_Ps_0.001_1<-subset(Sm_Ps_block1, secondary_dose=="0.001")
Sm_Ps_0.01_1<-subset(Sm_Ps_block1, secondary_dose=="0.01")
Sm_Ps_0.1_1<-subset(Sm_Ps_block1, secondary_dose=="0.1")
Sm_Ps_1.0_1<-subset(Sm_Ps_block1, secondary_dose=="1")

surv_Sm_Ps_0.001_1<-survdiff(Surv(day, status) ~ primary, data=Sm_Ps_0.001_1)
surv_Sm_Ps_0.001_1

surv_Sm_Ps_0.01_1<-survdiff(Surv(day, status) ~ primary, data=Sm_Ps_0.01_1)
surv_Sm_Ps_0.01_1

surv_Sm_Ps_0.1_1<-survdiff(Surv(day, status) ~ primary, data=Sm_Ps_0.1_1)
surv_Sm_Ps_0.1_1

surv_Sm_Ps_1.0_1<-survdiff(Surv(day, status) ~ primary, data=Sm_Ps_1.0_1)
surv_Sm_Ps_1.0_1

plot(survfit(Surv(Sm_Ps_block1$hour, Sm_Ps_block1$status) ~ Sm_Ps_block1$primary + Sm_Ps_block1$secondary_dose), col=c("gray", "#B5E8FC", "#75D6FD", "#09B6FC", "#055df5"), lty=c(3, 3, 3, 3, 3, 1, 1, 1, 1, 1), lwd=2.3, yaxt='n', xaxt='n', ylab="Proportion Alive", xlab="Hours Post-Secondary Infection", cex.lab=1.3, xlim=c(10,48), xaxs='i', ylim=c(0, 1.05), yaxs='i')
axis(2, las=2, cex.axis=1, lwd=4.5)
axis(1, cex.axis=1, lwd=4.5)
box(lwd=4.5)

legend("bottomleft", bty="n" , c("PBS-PBS", "0.001", "PBS-0.01", "PBS-0.1", "PBS-1.0", "S.m-PBS", "S.m-0.001", "S.m-0.01", "S.m-0.1", "S.m-1.0"),col=c("gray", "#B5E8FC", "#75D6FD", "#09B6FC", "#055df5"), lty=c(3, 3, 3, 3, 3, 1, 1, 1, 1, 1),lwd=4, cex=1)
```

### Block 2
```{r, S.m-P.snee 10/10/2020}
Sm_Ps_block2 <- subset(Sm_Ps, date == "10/10/2020")
table(Sm_Ps_block2$primary, Sm_Ps_block2$secondary_dose)

#subset by secondary dose
Sm_Ps_0.001_2<-subset(Sm_Ps_block2, secondary_dose=="0.001")
Sm_Ps_0.01_2<-subset(Sm_Ps_block2, secondary_dose=="0.01")
Sm_Ps_0.1_2<-subset(Sm_Ps_block2, secondary_dose=="0.1")
Sm_Ps_1.0_2<-subset(Sm_Ps_block2, secondary_dose=="1")

surv_Sm_Ps_0.001_2<-survdiff(Surv(day, status) ~ primary, data=Sm_Ps_0.001_2)
surv_Sm_Ps_0.001_2

surv_Sm_Ps_0.01_2<-survdiff(Surv(day, status) ~ primary, data=Sm_Ps_0.01_2)
surv_Sm_Ps_0.01_2

surv_Sm_Ps_0.1_2<-survdiff(Surv(day, status) ~ primary, data=Sm_Ps_0.1_2)
surv_Sm_Ps_0.1_2

surv_Sm_Ps_1.0_2<-survdiff(Surv(day, status) ~ primary, data=Sm_Ps_1.0_2)
surv_Sm_Ps_1.0_2

plot(survfit(Surv(Sm_Ps_block2$hour, Sm_Ps_block2$status) ~ Sm_Ps_block2$primary + Sm_Ps_block2$secondary_dose), col=c("gray", "#B5E8FC", "#75D6FD", "#09B6FC", "#055df5"), lty=c(3, 3, 3, 3, 3, 1, 1, 1, 1, 1), lwd=2.3, yaxt='n', xaxt='n', ylab="Proportion Alive", xlab="Hours Post-Secondary Infection", cex.lab=1.3, xlim=c(10,48), xaxs='i', ylim=c(0, 1.05), yaxs='i')
axis(2, las=2, cex.axis=1, lwd=4.5)
axis(1, cex.axis=1, lwd=4.5)
box(lwd=4.5)

legend("bottomleft", bty="n" , c("PBS-PBS", "0.001", "PBS-0.01", "PBS-0.1", "PBS-1.0", "S.m-PBS", "S.m-0.001", "S.m-0.01", "S.m-0.1", "S.m-1.0"),col=c("gray", "#B5E8FC", "#75D6FD", "#09B6FC", "#055df5"), lty=c(3, 3, 3, 3, 3, 1, 1, 1, 1, 1),lwd=4, cex=1)
```

### Block 3
```{r, S.m-P.snee 10/24/2020}
Sm_Ps_block3 <- subset(Sm_Ps, date == "10/24/2020")
table(Sm_Ps_block3$primary, Sm_Ps_block3$secondary_dose)

#subset by secondary dose
Sm_Ps_0.001_3<-subset(Sm_Ps_block3, secondary_dose=="0.001")
Sm_Ps_0.01_3<-subset(Sm_Ps_block3, secondary_dose=="0.01")
Sm_Ps_0.1_3<-subset(Sm_Ps_block3, secondary_dose=="0.1")
Sm_Ps_1.0_3<-subset(Sm_Ps_block3, secondary_dose=="1")

surv_Sm_Ps_0.001_3<-survdiff(Surv(day, status) ~ primary, data=Sm_Ps_0.001_3)
surv_Sm_Ps_0.001_3

surv_Sm_Ps_0.01_3<-survdiff(Surv(day, status) ~ primary, data=Sm_Ps_0.01_3)
surv_Sm_Ps_0.01_3

surv_Sm_Ps_0.1_3<-survdiff(Surv(day, status) ~ primary, data=Sm_Ps_0.1_3)
surv_Sm_Ps_0.1_3

surv_Sm_Ps_1.0_3<-survdiff(Surv(day, status) ~ primary, data=Sm_Ps_1.0_3)
surv_Sm_Ps_1.0_3

plot(survfit(Surv(Sm_Ps_block3$hour, Sm_Ps_block3$status) ~ Sm_Ps_block3$primary + Sm_Ps_block3$secondary_dose), col=c("gray", "#B5E8FC", "#75D6FD", "#09B6FC", "#055df5"), lty=c(3, 3, 3, 3, 3, 1, 1, 1, 1, 1), lwd=2.3, yaxt='n', xaxt='n', ylab="Proportion Alive", xlab="Hours Post-Secondary Infection", cex.lab=1.3, xlim=c(10,48), xaxs='i', ylim=c(0, 1.05), yaxs='i')
axis(2, las=2, cex.axis=1, lwd=4.5)
axis(1, cex.axis=1, lwd=4.5)
box(lwd=4.5)

legend("bottomleft", bty="n" , c("PBS-PBS", "0.001", "PBS-0.01", "PBS-0.1", "PBS-1.0", "S.m-PBS", "S.m-0.001", "S.m-0.01", "S.m-0.1", "S.m-1.0"),col=c("gray", "#B5E8FC", "#75D6FD", "#09B6FC", "#055df5"), lty=c(3, 3, 3, 3, 3, 1, 1, 1, 1, 1),lwd=4, cex=1)
```

## Statistical Tests

  + In order test whether there was protection provided by chronic infection for each secondary infectious dose, p-values from the log rank test for each date was combined using the Fisher’s test (experiments on all dates showed higher survival in conditions with chronic infection). Final p-value is reported in the text.


```{r}

# Grab p-values from each individual logrank test (results shown above in each block)
pvalue_Sm_Ps_0.001_1<-pchisq(surv_Sm_Ps_0.001_1$chisq, df=1, lower.tail=F)
pvalue_Sm_Ps_0.01_1<-pchisq(surv_Sm_Ps_0.01_1$chisq, df=1, lower.tail=F)
pvalue_Sm_Ps_0.1_1<-pchisq(surv_Sm_Ps_0.1_1$chisq, df=1, lower.tail=F)
pvalue_Sm_Ps_1.0_1<-pchisq(surv_Sm_Ps_1.0_1$chisq, df=1, lower.tail=F)

pvalue_Sm_Ps_0.001_2<-pchisq(surv_Sm_Ps_0.001_2$chisq, df=1, lower.tail=F)
pvalue_Sm_Ps_0.01_2<-pchisq(surv_Sm_Ps_0.01_2$chisq, df=1, lower.tail=F)
pvalue_Sm_Ps_0.1_2<-pchisq(surv_Sm_Ps_0.1_2$chisq, df=1, lower.tail=F)
pvalue_Sm_Ps_1.0_2<-pchisq(surv_Sm_Ps_1.0_2$chisq, df=1, lower.tail=F)

pvalue_Sm_Ps_0.001_3<-pchisq(surv_Sm_Ps_0.001_3$chisq, df=1, lower.tail=F)
pvalue_Sm_Ps_0.01_3<-pchisq(surv_Sm_Ps_0.01_3$chisq, df=1, lower.tail=F)
pvalue_Sm_Ps_0.1_3<-pchisq(surv_Sm_Ps_0.1_3$chisq, df=1, lower.tail=F)
pvalue_Sm_Ps_1.0_3<-pchisq(surv_Sm_Ps_1.0_3$chisq, df=1, lower.tail=F)
```


```{r}
# Use all p-values from a given condition to get Fisher's combined test p-value
pvalues_Sm_Ps_0.001 <- c(pvalue_Sm_Ps_0.001_2,pvalue_Sm_Ps_0.001_3)
test.stat_Sm_Ps_0.001 <- -2*sum(log(pvalues_Sm_Ps_0.001))
pfinal_Sm_Ps_0.001<-pchisq(test.stat_Sm_Ps_0.001, df=2*length(pvalues_Sm_Ps_0.001), lower.tail=F)

pvalues_Sm_Ps_0.01 <- c(pvalue_Sm_Ps_0.01_1,pvalue_Sm_Ps_0.01_2,pvalue_Sm_Ps_0.01_3)
test.stat_Sm_Ps_0.01 <- -2*sum(log(pvalues_Sm_Ps_0.01))
pfinal_Sm_Ps_0.01<-pchisq(test.stat_Sm_Ps_0.01, df=2*length(pvalues_Sm_Ps_0.01), lower.tail=F)


pvalues_Sm_Ps_0.1 <- c(pvalue_Sm_Ps_0.1_1,pvalue_Sm_Ps_0.1_2,pvalue_Sm_Ps_0.1_3)
test.stat_Sm_Ps_0.1 <- -2*sum(log(pvalues_Sm_Ps_0.1))
pfinal_Sm_Ps_0.1<-pchisq(test.stat_Sm_Ps_0.1, df=2*length(pvalues_Sm_Ps_0.1), lower.tail=F)

pvalues_Sm_Ps_1.0 <- c(pvalue_Sm_Ps_1.0_1,pvalue_Sm_Ps_1.0_2,pvalue_Sm_Ps_1.0_3)
test.stat_Sm_Ps_1.0 <- -2*sum(log(pvalues_Sm_Ps_1.0))
pfinal_Sm_Ps_1.0<-pchisq(test.stat_Sm_Ps_1.0, df=2*length(pvalues_Sm_Ps_1.0), lower.tail=F)

```


```{r}
pvalues_Sm_Ps_0.001_table <- c(pvalue_Sm_Ps_0.001_1, pvalue_Sm_Ps_0.001_2, pvalue_Sm_Ps_0.001_3)
p_Sm_Ps_0.001<-scales::pvalue(pvalues_Sm_Ps_0.001_table)

pvalues_Sm_Ps_0.01_table <- c(pvalue_Sm_Ps_0.01_1,pvalue_Sm_Ps_0.01_2,pvalue_Sm_Ps_0.01_3)
p_Sm_Ps_0.01<-scales::pvalue(pvalues_Sm_Ps_0.01_table)

pvalues_Sm_Ps_0.1_table <- c(pvalue_Sm_Ps_0.1_1,pvalue_Sm_Ps_0.1_2,pvalue_Sm_Ps_0.1_3)
p_Sm_Ps_0.1<-scales::pvalue(pvalues_Sm_Ps_0.1_table)

pvalues_Sm_Ps_1.0_table <- c(pvalue_Sm_Ps_1.0_1,pvalue_Sm_Ps_1.0_2,pvalue_Sm_Ps_1.0_3)
p_Sm_Ps_1.0<-scales::pvalue(pvalues_Sm_Ps_1.0_table)



pvalue_table_Sm_Ps <- data.frame("0.001" = p_Sm_Ps_0.001, "0.01" = p_Sm_Ps_0.01, "0.1" = p_Sm_Ps_0.1, "1.0" = p_Sm_Ps_1.0)
colnames(pvalue_table_Sm_Ps) <- c(0.001,0.01, 0.1, 1.0)

pfisher_Sm_Ps<- c(pfinal_Sm_Ps_0.001, pfinal_Sm_Ps_0.01, pfinal_Sm_Ps_0.1, pfinal_Sm_Ps_1.0)
pfisher_Sm_Ps<-scales::pvalue(pfisher_Sm_Ps)
pvalue_table_Sm_Ps[nrow(pvalue_table_Sm_Ps) + 1,]<-pfisher_Sm_Ps

row.names(pvalue_table_Sm_Ps) <- c("Block 1 - October 1st, 2021", "Block 2 - October 10th, 2021", "Block 3 - October 24th, 2021", " Final P-value ")

pvalue_table_Sm_Ps %>%
  kbl(caption = "<center><strong>P-values for log-rank tests on individual doses within each experiment<center><strong>") %>%
   kable_classic(full_width = F, html_font = "Cambria", position = "center")%>%
    add_header_above(c(" "=1, "Infectious Dose (Abs600nm)" = 4)) %>%
    pack_rows("Individual Blocks", 1, 3) %>%
    pack_rows("Fisher's Combined", 4, 4)

```

 + **Conclusion:** Chronic infection with *S. marcescens* offered significat protection against all doses of *P. sneebia* (p<0.001)

# Q4 Does the dose of the primary infection impact the strength of protection during secondary infection? {.tabset}

  + The infectious dose impacts the number of bacteria present in the fly during chronic infection (Chambers et al. 2019), therefore we hypothesized that this might influence the strength of protection during secondary infection.
  + Flies were injected with one of 5 doses of *S. marcescens* during primary infection (0.001, 0.01, 0.1, 1.0 and 2.0) or PBS. Then they were given a challenge dose of either *P. rettgeri* or *P. sneebia* (2.0 Abs600nM) as a secondary infection.

  *Study design:*
![](./Figure5Scheme.png)
  + Initially analyzed using Cox Proportional Hazards mixed effects model with date of injection, primary injection dose as fixed effects and random effect terms accounting for experimental structure (e.g. date of injection, housing of groups of flies in vials). However, this model violated the assumptions of Cox Proportional Hazards. 
    + Therefore we switched to using log-rank pairwise comparisons to determine whether dose used to induce chronic infection significantly impacted survival of secondary infection by comparing to the control flies given only a secondary infection.
      + LogRank comparisons were done on data from each date individually
      + If experiments on all dates showed higher survival in conditions with chronic infection, p-values were combined using Fisher's test and only the final p-value is reported in the text.
      + If there was a variable effect of chronic infection, the number of individual experiments with significant effects is reported. 
  + **Conclusions**
    + Moderate doses of *S. marcescens* (Abs600nm = 0.01, 0.1 & 1.0) all provided significant protection against secondary infection with both *P. rettgeri* ad *P. sneebia* (P<0.001)
    + The lowest dose of *S. marcescens* (Abs600nm = 0.01, 0.1 & 1.0) did not provide protection against either secondary infection.
    + The highest dose provided inconsistent protection, sometimes providing robust protection and other times dying as quickly as (or even faster than) control flies carrying only a secondary infection.


## *P. rettgeri* secondary infection {.tabset}
   + **Conclusion**: Moderate doses of the primary infection (Abs600nm = 0.01, 0.1 & 1.0) all provided significant protection against infection (P<0.001). 
   + The lowest dose (Abs600nm = 0.001) did not provide significant protection
   + The highest dose provided inconsistent protection with 8 out of the 9 blocks demonstrating better survival than controls and one with worse survival than controls. In Block 1, flies given a primary infection at the highest dose died more than controls with only the secondary infection.  

### Figure 5A
```{r, S.m-P.rett varied primary survival data}
Pr_varied_primary = subset(Pr_varied_primary, secondary == "P.rett")
Pr_varied_primary$primary_dose <- as.factor(Pr_varied_primary$primary_dose)
table(Pr_varied_primary$date, Pr_varied_primary$primary_dose)
table(Pr_varied_primary$primary_dose)

#png(file="Figure5A.png",  width = 1200, height = 900, res = 130)
par(mar=c(6,5,1,1)) #sets the margins around the graph so there is room for the labels
plot(survfit(Surv(Pr_varied_primary$day, Pr_varied_primary$status) ~ Pr_varied_primary$primary_dose), col=c("gray", "#B5E8FC", "#75D6FD", "#09B6FC", "#055df5", "#003694"), lty=c(1, 1, 1, 1, 1, 1), lwd=5, yaxt='n', xaxt='n', ylab="proportion alive", xlab="days post-secondary infection", cex.lab=2.5, xlim=c(0,7), xaxs='i', ylim=c(0, 1), yaxs='i')
axis(2, las=2, cex.axis=1.5, lwd=5)
axis(1, cex.axis=1.5, lwd=4.5)
box(lwd=5)

#legend("bottomleft", bty="n" , c("secondary infection only", "chronic infection (0.001)", "chronic infection (0.01)", "chronic infection (0.1)", "chronic infection (1.0)", "chronic infection (2.0)"),col=c("gray", "#B5E8FC", "#75D6FD", "#09B6FC", "#055df5", "#003694"),lty=c(1, 1, 1, 1, 1, 1),lwd=5, cex=1.5)
#dev.off()
```

### Individual blocks {.tabset}
#### Block 1
```{r, S.m-P.rett varied primary 10/18/2020}
Pr_varied_primary_block1 <- subset(Pr_varied_primary, date == "10/18/2020")
table(Pr_varied_primary_block1$primary_dose)

#subset by primary dose for pairwise comparison dose
Pr_varied_primary_0.001_1<-subset(Pr_varied_primary_block1, primary_dose == "0.001"|primary_dose=="0")
table(Pr_varied_primary_0.001_1$primary_dose)
Pr_varied_primary_0.01_1<-subset(Pr_varied_primary_block1, primary_dose=="0.01"|primary_dose=="0")
Pr_varied_primary_0.1_1<-subset(Pr_varied_primary_block1, primary_dose=="0.1"|primary_dose=="0")
Pr_varied_primary_1.0_1<-subset(Pr_varied_primary_block1, primary_dose=="1"|primary_dose=="0")
Pr_varied_primary_2.0_1<-subset(Pr_varied_primary_block1, primary_dose=="2"|primary_dose=="0")

surv_Pr_varied_primary_0.001_1<-survdiff(Surv(day, status) ~ primary, data=Pr_varied_primary_0.001_1)
surv_Pr_varied_primary_0.001_1

surv_Pr_varied_primary_0.01_1<-survdiff(Surv(day, status) ~ primary, data=Pr_varied_primary_0.01_1)
surv_Pr_varied_primary_0.01_1

surv_Pr_varied_primary_0.1_1<-survdiff(Surv(day, status) ~ primary, data=Pr_varied_primary_0.1_1)
surv_Pr_varied_primary_0.1_1

surv_Pr_varied_primary_1.0_1<-survdiff(Surv(day, status) ~ primary, data=Pr_varied_primary_1.0_1)
surv_Pr_varied_primary_1.0_1

surv_Pr_varied_primary_2.0_1<-survdiff(Surv(day, status) ~ primary, data=Pr_varied_primary_2.0_1)
surv_Pr_varied_primary_2.0_1

par(mar=c(4,4,0.1,0.1))
plot(survfit(Surv(Pr_varied_primary_block1$day, Pr_varied_primary_block1$status) ~ Pr_varied_primary_block1$primary_dose), col=c("gray", "#B5E8FC", "#75D6FD", "#09B6FC", "#055df5", "#003694"), lty=c(1, 1, 1, 1, 1, 1), lwd=3.4, yaxt='n', xaxt='n', ylab="Proportion Alive", xlab="Days Post-Secondary Infection", cex.lab=1.3, xlim=c(0,7), xaxs='i', ylim=c(0, 1.05), yaxs='i')
axis(2, las=2, cex.axis=1, lwd=4.5)
axis(1, cex.axis=1, lwd=4.5)
box(lwd=4.5)

legend("bottomleft", bty="n" , c("PBS-P.rett 2.0", "S.m 0.001-P.rett 2.0", "S.m 0.01-P.rett 2.0", "S.m 0.1-P.rett 2.0", "S.m 1.0-P.rett 2.0", "S.m 2.0-P.rett 2.0"),col=c("gray", "#B5E8FC", "#75D6FD", "#09B6FC", "#055df5", "#003694"),lty=c(1, 1, 1, 1, 1, 1),lwd=5, cex=1)
```

#### Block 2
```{r, S.m-P.rett varied primary 10/20/2020}
Pr_varied_primary_block2 <- subset(Pr_varied_primary, date == "10/20/2020")
table(Pr_varied_primary_block2$primary_dose)

#subset by primary dose for pairwise comparison dose
Pr_varied_primary_0.001_2<-subset(Pr_varied_primary_block2, primary_dose == "0.001"|primary_dose=="0")
Pr_varied_primary_0.01_2<-subset(Pr_varied_primary_block2, primary_dose=="0.01"|primary_dose=="0")
Pr_varied_primary_0.1_2<-subset(Pr_varied_primary_block2, primary_dose=="0.1"|primary_dose=="0")
Pr_varied_primary_1.0_2<-subset(Pr_varied_primary_block2, primary_dose=="1"|primary_dose=="0")
Pr_varied_primary_2.0_2<-subset(Pr_varied_primary_block2, primary_dose=="2"|primary_dose=="0")

surv_Pr_varied_primary_0.001_2<-survdiff(Surv(day, status) ~ primary, data=Pr_varied_primary_0.001_2)
surv_Pr_varied_primary_0.001_2

surv_Pr_varied_primary_0.01_2<-survdiff(Surv(day, status) ~ primary, data=Pr_varied_primary_0.01_2)
surv_Pr_varied_primary_0.01_2

surv_Pr_varied_primary_0.1_2<-survdiff(Surv(day, status) ~ primary, data=Pr_varied_primary_0.1_2)
surv_Pr_varied_primary_0.1_2

surv_Pr_varied_primary_1.0_2<-survdiff(Surv(day, status) ~ primary, data=Pr_varied_primary_1.0_2)
surv_Pr_varied_primary_1.0_2

surv_Pr_varied_primary_2.0_2<-survdiff(Surv(day, status) ~ primary, data=Pr_varied_primary_2.0_2)
surv_Pr_varied_primary_2.0_2

par(mar=c(4,4,0.1,0.1))
plot(survfit(Surv(Pr_varied_primary_block2$day, Pr_varied_primary_block2$status) ~ Pr_varied_primary_block2$primary_dose), col=c("gray", "#B5E8FC", "#75D6FD", "#09B6FC", "#055df5", "#003694"), lty=c(1, 1, 1, 1, 1, 1), lwd=3.4, yaxt='n', xaxt='n', ylab="Proportion Alive", xlab="Days Post-Secondary Infection", cex.lab=1.3, xlim=c(0,7), xaxs='i', ylim=c(0, 1.05), yaxs='i')
axis(2, las=2, cex.axis=1, lwd=4.5)
axis(1, cex.axis=1, lwd=4.5)
box(lwd=4.5)

legend("bottomleft", bty="n" , c("PBS-P.rett 2.0", "S.m 0.001-P.rett 2.0", "S.m 0.01-P.rett 2.0", "S.m 0.1-P.rett 2.0", "S.m 1.0-P.rett 2.0", "S.m 2.0-P.rett 2.0"),col=c("gray", "#B5E8FC", "#75D6FD", "#09B6FC", "#055df5", "#003694"),lty=c(1, 1, 1, 1, 1, 1),lwd=5, cex=1)
```

#### Block 3
```{r, S.m-P.rett varied primary 10/29/2020}
Pr_varied_primary_block3 <- subset(Pr_varied_primary, date == "10/29/2020")
table(Pr_varied_primary_block3$primary_dose)

#subset by primary dose for pairwise comparison dose
Pr_varied_primary_0.001_3<-subset(Pr_varied_primary_block3, primary_dose == "0.001"|primary_dose=="0")
Pr_varied_primary_0.01_3<-subset(Pr_varied_primary_block3, primary_dose=="0.01"|primary_dose=="0")
Pr_varied_primary_0.1_3<-subset(Pr_varied_primary_block3, primary_dose=="0.1"|primary_dose=="0")
Pr_varied_primary_1.0_3<-subset(Pr_varied_primary_block3, primary_dose=="1"|primary_dose=="0")
Pr_varied_primary_2.0_3<-subset(Pr_varied_primary_block3, primary_dose=="2"|primary_dose=="0")

surv_Pr_varied_primary_0.001_3<-survdiff(Surv(day, status) ~ primary, data=Pr_varied_primary_0.001_3)
surv_Pr_varied_primary_0.001_3

surv_Pr_varied_primary_0.01_3<-survdiff(Surv(day, status) ~ primary, data=Pr_varied_primary_0.01_3)
surv_Pr_varied_primary_0.01_3

surv_Pr_varied_primary_0.1_3<-survdiff(Surv(day, status) ~ primary, data=Pr_varied_primary_0.1_3)
surv_Pr_varied_primary_0.1_3

surv_Pr_varied_primary_1.0_3<-survdiff(Surv(day, status) ~ primary, data=Pr_varied_primary_1.0_3)
surv_Pr_varied_primary_1.0_3

surv_Pr_varied_primary_2.0_3<-survdiff(Surv(day, status) ~ primary, data=Pr_varied_primary_2.0_3)
surv_Pr_varied_primary_2.0_3

par(mar=c(4,4,0.1,0.1))
plot(survfit(Surv(Pr_varied_primary_block3$day, Pr_varied_primary_block3$status) ~ Pr_varied_primary_block3$primary_dose), col=c("gray", "#B5E8FC", "#75D6FD", "#09B6FC", "#055df5", "#003694"), lty=c(1, 1, 1, 1, 1, 1), lwd=3.4, yaxt='n', xaxt='n', ylab="Proportion Alive", xlab="Days Post-Secondary Infection", cex.lab=1.3, xlim=c(0,7), xaxs='i', ylim=c(0, 1.05), yaxs='i')
axis(2, las=2, cex.axis=1, lwd=4.5)
axis(1, cex.axis=1, lwd=4.5)
box(lwd=4.5)

legend("bottomleft", bty="n" , c("PBS-P.rett 2.0", "S.m 0.001-P.rett 2.0", "S.m 0.01-P.rett 2.0", "S.m 0.1-P.rett 2.0", "S.m 1.0-P.rett 2.0", "S.m 2.0-P.rett 2.0"),col=c("gray", "#B5E8FC", "#75D6FD", "#09B6FC", "#055df5", "#003694"),lty=c(1, 1, 1, 1, 1, 1),lwd=5, cex=1)
```

#### Block 4
```{r, S.m-P.rett varied primary 11/2/2020}
Pr_varied_primary_block4 <- subset(Pr_varied_primary, date == "11/2/2020")
table(Pr_varied_primary_block4$primary_dose)

#subset by primary dose for pairwise comparison dose
Pr_varied_primary_0.001_4<-subset(Pr_varied_primary_block4, primary_dose == "0.001"|primary_dose=="0")
Pr_varied_primary_0.01_4<-subset(Pr_varied_primary_block4, primary_dose=="0.01"|primary_dose=="0")
Pr_varied_primary_0.1_4<-subset(Pr_varied_primary_block4, primary_dose=="0.1"|primary_dose=="0")
Pr_varied_primary_1.0_4<-subset(Pr_varied_primary_block4, primary_dose=="1"|primary_dose=="0")
Pr_varied_primary_2.0_4<-subset(Pr_varied_primary_block4, primary_dose=="2"|primary_dose=="0")

surv_Pr_varied_primary_0.001_4<-survdiff(Surv(day, status) ~ primary, data=Pr_varied_primary_0.001_4)
surv_Pr_varied_primary_0.001_4

surv_Pr_varied_primary_0.01_4<-survdiff(Surv(day, status) ~ primary, data=Pr_varied_primary_0.01_4)
surv_Pr_varied_primary_0.01_4

surv_Pr_varied_primary_0.1_4<-survdiff(Surv(day, status) ~ primary, data=Pr_varied_primary_0.1_4)
surv_Pr_varied_primary_0.1_4

surv_Pr_varied_primary_1.0_4<-survdiff(Surv(day, status) ~ primary, data=Pr_varied_primary_1.0_4)
surv_Pr_varied_primary_1.0_4

surv_Pr_varied_primary_2.0_4<-survdiff(Surv(day, status) ~ primary, data=Pr_varied_primary_2.0_4)
surv_Pr_varied_primary_2.0_4

par(mar=c(4,4,0.1,0.1))
plot(survfit(Surv(Pr_varied_primary_block4$day, Pr_varied_primary_block4$status) ~ Pr_varied_primary_block4$primary_dose), col=c("gray", "#B5E8FC", "#75D6FD", "#09B6FC", "#055df5", "#003694"), lty=c(1, 1, 1, 1, 1, 1), lwd=3.4, yaxt='n', xaxt='n', ylab="Proportion Alive", xlab="Days Post-Secondary Infection", cex.lab=1.3, xlim=c(0,7), xaxs='i', ylim=c(0, 1.05), yaxs='i')
axis(2, las=2, cex.axis=1, lwd=4.5)
axis(1, cex.axis=1, lwd=4.5)
box(lwd=4.5)

legend("bottomleft", bty="n" , c("PBS-P.rett 2.0", "S.m 0.001-P.rett 2.0", "S.m 0.01-P.rett 2.0", "S.m 0.1-P.rett 2.0", "S.m 1.0-P.rett 2.0", "S.m 2.0-P.rett 2.0"),col=c("gray", "#B5E8FC", "#75D6FD", "#09B6FC", "#055df5", "#003694"),lty=c(1, 1, 1, 1, 1, 1),lwd=5, cex=1)
```

#### Block 5
```{r, S.m-P.rett varied primary 11/7/2020}
Pr_varied_primary_block5 <- subset(Pr_varied_primary, date == "11/7/2020")
table(Pr_varied_primary_block5$primary_dose)

#subset by primary dose for pairwise comparison dose
Pr_varied_primary_0.001_5<-subset(Pr_varied_primary_block5, primary_dose == "0.001"|primary_dose=="0")
Pr_varied_primary_0.01_5<-subset(Pr_varied_primary_block5, primary_dose=="0.01"|primary_dose=="0")
Pr_varied_primary_0.1_5<-subset(Pr_varied_primary_block5, primary_dose=="0.1"|primary_dose=="0")
Pr_varied_primary_1.0_5<-subset(Pr_varied_primary_block5, primary_dose=="1"|primary_dose=="0")
Pr_varied_primary_2.0_5<-subset(Pr_varied_primary_block5, primary_dose=="2"|primary_dose=="0")

surv_Pr_varied_primary_0.001_5<-survdiff(Surv(day, status) ~ primary, data=Pr_varied_primary_0.001_5)
surv_Pr_varied_primary_0.001_5

surv_Pr_varied_primary_0.01_5<-survdiff(Surv(day, status) ~ primary, data=Pr_varied_primary_0.01_5)
surv_Pr_varied_primary_0.01_5

surv_Pr_varied_primary_0.1_5<-survdiff(Surv(day, status) ~ primary, data=Pr_varied_primary_0.1_5)
surv_Pr_varied_primary_0.1_5

surv_Pr_varied_primary_1.0_5<-survdiff(Surv(day, status) ~ primary, data=Pr_varied_primary_1.0_5)
surv_Pr_varied_primary_1.0_5

surv_Pr_varied_primary_2.0_5<-survdiff(Surv(day, status) ~ primary, data=Pr_varied_primary_2.0_5)
surv_Pr_varied_primary_2.0_5

par(mar=c(4,4,0.1,0.1))
plot(survfit(Surv(Pr_varied_primary_block5$day, Pr_varied_primary_block5$status) ~ Pr_varied_primary_block5$primary_dose), col=c("gray", "#B5E8FC", "#75D6FD", "#09B6FC", "#055df5", "#003694"), lty=c(1, 1, 1, 1, 1, 1), lwd=3.4, yaxt='n', xaxt='n', ylab="Proportion Alive", xlab="Days Post-Secondary Infection", cex.lab=1.3, xlim=c(0,7), xaxs='i', ylim=c(0, 1.05), yaxs='i')
axis(2, las=2, cex.axis=1, lwd=4.5)
axis(1, cex.axis=1, lwd=4.5)
box(lwd=4.5)

legend("bottomleft", bty="n" , c("PBS-P.rett 2.0", "S.m 0.001-P.rett 2.0", "S.m 0.01-P.rett 2.0", "S.m 0.1-P.rett 2.0", "S.m 1.0-P.rett 2.0", "S.m 2.0-P.rett 2.0"),col=c("gray", "#B5E8FC", "#75D6FD", "#09B6FC", "#055df5", "#003694"),lty=c(1, 1, 1, 1, 1, 1),lwd=5, cex=1)
```

#### Block 6
```{r, S.m-P.rett varied primary 11/28/2020}
Pr_varied_primary_block6 <- subset(Pr_varied_primary, date == "11/28/2020")
table(Pr_varied_primary_block6$primary_dose)

#subset by primary dose for pairwise comparison dose
Pr_varied_primary_0.001_6<-subset(Pr_varied_primary_block6, primary_dose == "0.001"|primary_dose=="0")
Pr_varied_primary_0.01_6<-subset(Pr_varied_primary_block6, primary_dose=="0.01"|primary_dose=="0")
Pr_varied_primary_0.1_6<-subset(Pr_varied_primary_block6, primary_dose=="0.1"|primary_dose=="0")
Pr_varied_primary_1.0_6<-subset(Pr_varied_primary_block6, primary_dose=="1"|primary_dose=="0")
Pr_varied_primary_2.0_6<-subset(Pr_varied_primary_block6, primary_dose=="2"|primary_dose=="0")

surv_Pr_varied_primary_0.001_6<-survdiff(Surv(day, status) ~ primary, data=Pr_varied_primary_0.001_6)
surv_Pr_varied_primary_0.001_6

surv_Pr_varied_primary_0.01_6<-survdiff(Surv(day, status) ~ primary, data=Pr_varied_primary_0.01_6)
surv_Pr_varied_primary_0.01_6

surv_Pr_varied_primary_0.1_6<-survdiff(Surv(day, status) ~ primary, data=Pr_varied_primary_0.1_6)
surv_Pr_varied_primary_0.1_6

surv_Pr_varied_primary_1.0_6<-survdiff(Surv(day, status) ~ primary, data=Pr_varied_primary_1.0_6)
surv_Pr_varied_primary_1.0_6

surv_Pr_varied_primary_2.0_6<-survdiff(Surv(day, status) ~ primary, data=Pr_varied_primary_2.0_6)
surv_Pr_varied_primary_2.0_6

par(mar=c(4,4,0.1,0.1))
plot(survfit(Surv(Pr_varied_primary_block6$day, Pr_varied_primary_block6$status) ~ Pr_varied_primary_block6$primary_dose), col=c("gray", "#B5E8FC", "#75D6FD", "#09B6FC", "#055df5", "#003694"), lty=c(1, 1, 1, 1, 1, 1), lwd=3.4, yaxt='n', xaxt='n', ylab="Proportion Alive", xlab="Days Post-Secondary Infection", cex.lab=1.3, xlim=c(0,7), xaxs='i', ylim=c(0, 1.05), yaxs='i')
axis(2, las=2, cex.axis=1, lwd=4.5)
axis(1, cex.axis=1, lwd=4.5)
box(lwd=4.5)

legend("bottomleft", bty="n" , c("PBS-P.rett 2.0", "S.m 0.001-P.rett 2.0", "S.m 0.01-P.rett 2.0", "S.m 0.1-P.rett 2.0", "S.m 1.0-P.rett 2.0", "S.m 2.0-P.rett 2.0"),col=c("gray", "#B5E8FC", "#75D6FD", "#09B6FC", "#055df5", "#003694"),lty=c(1, 1, 1, 1, 1, 1),lwd=5, cex=1)
```

#### Block 7
```{r, S.m-P.rett varied primary 12/4/2020}
Pr_varied_primary_block7 <- subset(Pr_varied_primary, date == "12/4/2020")
table(Pr_varied_primary_block7$primary_dose)

#subset by primary dose for pairwise comparison dose
Pr_varied_primary_0.001_7<-subset(Pr_varied_primary_block7, primary_dose == "0.001"|primary_dose=="0")
Pr_varied_primary_0.01_7<-subset(Pr_varied_primary_block7, primary_dose=="0.01"|primary_dose=="0")
Pr_varied_primary_0.1_7<-subset(Pr_varied_primary_block7, primary_dose=="0.1"|primary_dose=="0")
Pr_varied_primary_1.0_7<-subset(Pr_varied_primary_block7, primary_dose=="1"|primary_dose=="0")
#Pr_varied_primary_2.0_7<-subset(Pr_varied_primary_block7, primary_dose=="2"|primary_dose=="0")

surv_Pr_varied_primary_0.001_7<-survdiff(Surv(day, status) ~ primary, data=Pr_varied_primary_0.001_7)
surv_Pr_varied_primary_0.001_7

surv_Pr_varied_primary_0.01_7<-survdiff(Surv(day, status) ~ primary, data=Pr_varied_primary_0.01_7)
surv_Pr_varied_primary_0.01_7

surv_Pr_varied_primary_0.1_7<-survdiff(Surv(day, status) ~ primary, data=Pr_varied_primary_0.1_7)
surv_Pr_varied_primary_0.1_7

surv_Pr_varied_primary_1.0_7<-survdiff(Surv(day, status) ~ primary, data=Pr_varied_primary_1.0_7)
surv_Pr_varied_primary_1.0_7

#surv_Pr_varied_primary_2.0_7<-survdiff(Surv(day, status) ~ primary, data=Pr_varied_primary_2.0_7)
#surv_Pr_varied_primary_2.0_7

par(mar=c(4,4,0.1,0.1))
plot(survfit(Surv(Pr_varied_primary_block7$day, Pr_varied_primary_block7$status) ~ Pr_varied_primary_block7$primary_dose), col=c("gray", "#B5E8FC", "#75D6FD", "#09B6FC", "#055df5", "#003694"), lty=c(1, 1, 1, 1, 1, 1), lwd=3.4, yaxt='n', xaxt='n', ylab="Proportion Alive", xlab="Days Post-Secondary Infection", cex.lab=1.3, xlim=c(0,7), xaxs='i', ylim=c(0, 1.05), yaxs='i')
axis(2, las=2, cex.axis=1, lwd=4.5)
axis(1, cex.axis=1, lwd=4.5)
box(lwd=4.5)

legend("bottomleft", bty="n" , c("PBS-P.rett 2.0", "S.m 0.001-P.rett 2.0", "S.m 0.01-P.rett 2.0", "S.m 0.1-P.rett 2.0", "S.m 1.0-P.rett 2.0", "S.m 2.0-P.rett 2.0"),col=c("gray", "#B5E8FC", "#75D6FD", "#09B6FC", "#055df5", "#003694"),lty=c(1, 1, 1, 1, 1, 1),lwd=5, cex=1)
```

#### Block 8
```{r, S.m-P.rett varied primary 6/17/2021}
Pr_varied_primary_block8 <- subset(Pr_varied_primary, date == "6/17/2021")
table(Pr_varied_primary_block8$primary_dose)

#subset by primary dose for pairwise comparison dose
Pr_varied_primary_0.001_8<-subset(Pr_varied_primary_block8, primary_dose == "0.001"|primary_dose=="0")
Pr_varied_primary_0.01_8<-subset(Pr_varied_primary_block8, primary_dose=="0.01"|primary_dose=="0")
Pr_varied_primary_0.1_8<-subset(Pr_varied_primary_block8, primary_dose=="0.1"|primary_dose=="0")
Pr_varied_primary_1.0_8<-subset(Pr_varied_primary_block8, primary_dose=="1"|primary_dose=="0")
Pr_varied_primary_2.0_8<-subset(Pr_varied_primary_block8, primary_dose=="2"|primary_dose=="0")

surv_Pr_varied_primary_0.001_8<-survdiff(Surv(day, status) ~ primary, data=Pr_varied_primary_0.001_8)
surv_Pr_varied_primary_0.001_8

surv_Pr_varied_primary_0.01_8<-survdiff(Surv(day, status) ~ primary, data=Pr_varied_primary_0.01_8)
surv_Pr_varied_primary_0.01_8

surv_Pr_varied_primary_0.1_8<-survdiff(Surv(day, status) ~ primary, data=Pr_varied_primary_0.1_8)
surv_Pr_varied_primary_0.1_8

surv_Pr_varied_primary_1.0_8<-survdiff(Surv(day, status) ~ primary, data=Pr_varied_primary_1.0_8)
surv_Pr_varied_primary_1.0_8

surv_Pr_varied_primary_2.0_8<-survdiff(Surv(day, status) ~ primary, data=Pr_varied_primary_2.0_8)
surv_Pr_varied_primary_2.0_8

par(mar=c(4,4,0.1,0.1))
plot(survfit(Surv(Pr_varied_primary_block8$day, Pr_varied_primary_block8$status) ~ Pr_varied_primary_block8$primary_dose), col=c("gray", "#B5E8FC", "#75D6FD", "#09B6FC", "#055df5", "#003694"), lty=c(1, 1, 1, 1, 1, 1), lwd=3.4, yaxt='n', xaxt='n', ylab="Proportion Alive", xlab="Days Post-Secondary Infection", cex.lab=1.3, xlim=c(0,7), xaxs='i', ylim=c(0, 1.05), yaxs='i')
axis(2, las=2, cex.axis=1, lwd=4.5)
axis(1, cex.axis=1, lwd=4.5)
box(lwd=4.5)

legend("bottomleft", bty="n" , c("PBS-P.rett 2.0", "S.m 0.001-P.rett 2.0", "S.m 0.01-P.rett 2.0", "S.m 0.1-P.rett 2.0", "S.m 1.0-P.rett 2.0", "S.m 2.0-P.rett 2.0"),col=c("gray", "#B5E8FC", "#75D6FD", "#09B6FC", "#055df5", "#003694"),lty=c(1, 1, 1, 1, 1, 1),lwd=5, cex=1)
```

#### Block 9
```{r, S.m-P.rett varied primary 6/18/2021}
Pr_varied_primary_block9<- subset(Pr_varied_primary, date == "6/18/2021")
table(Pr_varied_primary_block9$primary_dose)

#subset by primary dose for pairwise comparison dose
Pr_varied_primary_0.001_9<-subset(Pr_varied_primary_block9, primary_dose == "0.001"|primary_dose=="0")
Pr_varied_primary_0.01_9<-subset(Pr_varied_primary_block9, primary_dose=="0.01"|primary_dose=="0")
Pr_varied_primary_0.1_9<-subset(Pr_varied_primary_block9, primary_dose=="0.1"|primary_dose=="0")
Pr_varied_primary_1.0_9<-subset(Pr_varied_primary_block9, primary_dose=="1"|primary_dose=="0")
Pr_varied_primary_2.0_9<-subset(Pr_varied_primary_block9, primary_dose=="2"|primary_dose=="0")

surv_Pr_varied_primary_0.001_9<-survdiff(Surv(day, status) ~ primary, data=Pr_varied_primary_0.001_9)
surv_Pr_varied_primary_0.001_9

surv_Pr_varied_primary_0.01_9<-survdiff(Surv(day, status) ~ primary, data=Pr_varied_primary_0.01_9)
surv_Pr_varied_primary_0.01_9

surv_Pr_varied_primary_0.1_9<-survdiff(Surv(day, status) ~ primary, data=Pr_varied_primary_0.1_9)
surv_Pr_varied_primary_0.1_9

surv_Pr_varied_primary_1.0_9<-survdiff(Surv(day, status) ~ primary, data=Pr_varied_primary_1.0_9)
surv_Pr_varied_primary_1.0_9

surv_Pr_varied_primary_2.0_9<-survdiff(Surv(day, status) ~ primary, data=Pr_varied_primary_2.0_9)
surv_Pr_varied_primary_2.0_9

par(mar=c(4,4,0.1,0.1))
plot(survfit(Surv(Pr_varied_primary_block9$day, Pr_varied_primary_block9$status) ~ Pr_varied_primary_block9$primary_dose), col=c("gray", "#B5E8FC", "#75D6FD", "#09B6FC", "#055df5", "#003694"), lty=c(1, 1, 1, 1, 1, 1), lwd=3.4, yaxt='n', xaxt='n', ylab="Proportion Alive", xlab="Days Post-Secondary Infection", cex.lab=1.3, xlim=c(0,7), xaxs='i', ylim=c(0, 1.05), yaxs='i')
axis(2, las=2, cex.axis=1, lwd=4.5)
axis(1, cex.axis=1, lwd=4.5)
box(lwd=4.5)

legend("bottomleft", bty="n" , c("PBS-P.rett 2.0", "S.m 0.001-P.rett 2.0", "S.m 0.01-P.rett 2.0", "S.m 0.1-P.rett 2.0", "S.m 1.0-P.rett 2.0", "S.m 2.0-P.rett 2.0"),col=c("gray", "#B5E8FC", "#75D6FD", "#09B6FC", "#055df5", "#003694"),lty=c(1, 1, 1, 1, 1, 1),lwd=5, cex=1)
```

### Statistical Tests

  + In order test whether there was protection provided by chronic infection for each secondary infectious dose, p-values from the log rank test for each date was combined using the Fisher’s test (experiments on all dates showed higher survival in conditions with chronic infection). Final p-value is reported in the text.


```{r}

# Grab p-values from each individual logrank test (results shown above in each block)
pvalue_Pr_varied_primary_0.001_1<-pchisq(surv_Pr_varied_primary_0.001_1$chisq, df=1, lower.tail=F)
pvalue_Pr_varied_primary_0.01_1<-pchisq(surv_Pr_varied_primary_0.01_1$chisq, df=1, lower.tail=F)
pvalue_Pr_varied_primary_0.1_1<-pchisq(surv_Pr_varied_primary_0.1_1$chisq, df=1, lower.tail=F)
pvalue_Pr_varied_primary_1.0_1<-pchisq(surv_Pr_varied_primary_1.0_1$chisq, df=1, lower.tail=F)
pvalue_Pr_varied_primary_2.0_1<-pchisq(surv_Pr_varied_primary_2.0_1$chisq, df=1, lower.tail=F)

pvalue_Pr_varied_primary_0.001_2<-pchisq(surv_Pr_varied_primary_0.001_2$chisq, df=1, lower.tail=F)
pvalue_Pr_varied_primary_0.01_2<-pchisq(surv_Pr_varied_primary_0.01_2$chisq, df=1, lower.tail=F)
pvalue_Pr_varied_primary_0.1_2<-pchisq(surv_Pr_varied_primary_0.1_2$chisq, df=1, lower.tail=F)
pvalue_Pr_varied_primary_1.0_2<-pchisq(surv_Pr_varied_primary_1.0_2$chisq, df=1, lower.tail=F)
pvalue_Pr_varied_primary_2.0_2<-pchisq(surv_Pr_varied_primary_2.0_2$chisq, df=1, lower.tail=F)

pvalue_Pr_varied_primary_0.001_3<-pchisq(surv_Pr_varied_primary_0.001_3$chisq, df=1, lower.tail=F)
pvalue_Pr_varied_primary_0.01_3<-pchisq(surv_Pr_varied_primary_0.01_3$chisq, df=1, lower.tail=F)
pvalue_Pr_varied_primary_0.1_3<-pchisq(surv_Pr_varied_primary_0.1_3$chisq, df=1, lower.tail=F)
pvalue_Pr_varied_primary_1.0_3<-pchisq(surv_Pr_varied_primary_1.0_3$chisq, df=1, lower.tail=F)
pvalue_Pr_varied_primary_2.0_3<-pchisq(surv_Pr_varied_primary_2.0_3$chisq, df=1, lower.tail=F)

pvalue_Pr_varied_primary_0.001_4<-pchisq(surv_Pr_varied_primary_0.001_4$chisq, df=1, lower.tail=F)
pvalue_Pr_varied_primary_0.01_4<-pchisq(surv_Pr_varied_primary_0.01_4$chisq, df=1, lower.tail=F)
pvalue_Pr_varied_primary_0.1_4<-pchisq(surv_Pr_varied_primary_0.1_4$chisq, df=1, lower.tail=F)
pvalue_Pr_varied_primary_1.0_4<-pchisq(surv_Pr_varied_primary_1.0_4$chisq, df=1, lower.tail=F)
pvalue_Pr_varied_primary_2.0_4<-pchisq(surv_Pr_varied_primary_2.0_4$chisq, df=1, lower.tail=F)

pvalue_Pr_varied_primary_0.001_5<-pchisq(surv_Pr_varied_primary_0.001_5$chisq, df=1, lower.tail=F)
pvalue_Pr_varied_primary_0.01_5<-pchisq(surv_Pr_varied_primary_0.01_5$chisq, df=1, lower.tail=F)
pvalue_Pr_varied_primary_0.1_5<-pchisq(surv_Pr_varied_primary_0.1_5$chisq, df=1, lower.tail=F)
pvalue_Pr_varied_primary_1.0_5<-pchisq(surv_Pr_varied_primary_1.0_5$chisq, df=1, lower.tail=F)
pvalue_Pr_varied_primary_2.0_5<-pchisq(surv_Pr_varied_primary_2.0_5$chisq, df=1, lower.tail=F)

pvalue_Pr_varied_primary_0.001_6<-pchisq(surv_Pr_varied_primary_0.001_6$chisq, df=1, lower.tail=F)
pvalue_Pr_varied_primary_0.01_6<-pchisq(surv_Pr_varied_primary_0.01_6$chisq, df=1, lower.tail=F)
pvalue_Pr_varied_primary_0.1_6<-pchisq(surv_Pr_varied_primary_0.1_6$chisq, df=1, lower.tail=F)
pvalue_Pr_varied_primary_1.0_6<-pchisq(surv_Pr_varied_primary_1.0_6$chisq, df=1, lower.tail=F)
pvalue_Pr_varied_primary_2.0_6<-pchisq(surv_Pr_varied_primary_2.0_6$chisq, df=1, lower.tail=F)

pvalue_Pr_varied_primary_0.001_7<-pchisq(surv_Pr_varied_primary_0.001_7$chisq, df=1, lower.tail=F)
pvalue_Pr_varied_primary_0.01_7<-pchisq(surv_Pr_varied_primary_0.01_7$chisq, df=1, lower.tail=F)
pvalue_Pr_varied_primary_0.1_7<-pchisq(surv_Pr_varied_primary_0.1_7$chisq, df=1, lower.tail=F)
pvalue_Pr_varied_primary_1.0_7<-pchisq(surv_Pr_varied_primary_1.0_7$chisq, df=1, lower.tail=F)
#pvalue_Pr_varied_primary_2.0_7<-pchisq(surv_Pr_varied_primary_2.0_7$chisq, df=1, lower.tail=F)

pvalue_Pr_varied_primary_0.001_8<-pchisq(surv_Pr_varied_primary_0.001_8$chisq, df=1, lower.tail=F)
pvalue_Pr_varied_primary_0.01_8<-pchisq(surv_Pr_varied_primary_0.01_8$chisq, df=1, lower.tail=F)
pvalue_Pr_varied_primary_0.1_8<-pchisq(surv_Pr_varied_primary_0.1_8$chisq, df=1, lower.tail=F)
pvalue_Pr_varied_primary_1.0_8<-pchisq(surv_Pr_varied_primary_1.0_8$chisq, df=1, lower.tail=F)
pvalue_Pr_varied_primary_2.0_8<-pchisq(surv_Pr_varied_primary_2.0_8$chisq, df=1, lower.tail=F)

pvalue_Pr_varied_primary_0.001_9<-pchisq(surv_Pr_varied_primary_0.001_9$chisq, df=1, lower.tail=F)
pvalue_Pr_varied_primary_0.01_9<-pchisq(surv_Pr_varied_primary_0.01_9$chisq, df=1, lower.tail=F)
pvalue_Pr_varied_primary_0.1_9<-pchisq(surv_Pr_varied_primary_0.1_9$chisq, df=1, lower.tail=F)
pvalue_Pr_varied_primary_1.0_9<-pchisq(surv_Pr_varied_primary_1.0_9$chisq, df=1, lower.tail=F)
pvalue_Pr_varied_primary_2.0_9<-pchisq(surv_Pr_varied_primary_2.0_9$chisq, df=1, lower.tail=F)
```


```{r}
# Use all p-values from a given condition to get Fisher's combined test p-value
pvalues_Pr_varied_primary_0.001 <- c(pvalue_Pr_varied_primary_0.001_2 ,pvalue_Pr_varied_primary_0.001_3, pvalue_Pr_varied_primary_0.001_4, pvalue_Pr_varied_primary_0.001_5, pvalue_Pr_varied_primary_0.001_6, pvalue_Pr_varied_primary_0.001_7, pvalue_Pr_varied_primary_0.001_8, pvalue_Pr_varied_primary_0.001_9)
test.stat_Pr_varied_primary_0.001 <- -2*sum(log(pvalues_Pr_varied_primary_0.001))
pfinal_Pr_varied_primary_0.001<-pchisq(test.stat_Pr_varied_primary_0.001, df=2*length(pvalues_Pr_varied_primary_0.001), lower.tail=F)

pvalues_Pr_varied_primary_0.01 <- c(pvalue_Pr_varied_primary_0.01_1,pvalue_Pr_varied_primary_0.01_2,pvalue_Pr_varied_primary_0.01_3,pvalue_Pr_varied_primary_0.01_4,pvalue_Pr_varied_primary_0.01_5,pvalue_Pr_varied_primary_0.01_6,pvalue_Pr_varied_primary_0.01_7,pvalue_Pr_varied_primary_0.01_8,pvalue_Pr_varied_primary_0.01_9)
test.stat_Pr_varied_primary_0.01 <- -2*sum(log(pvalues_Pr_varied_primary_0.01))
pfinal_Pr_varied_primary_0.01<-pchisq(test.stat_Pr_varied_primary_0.01, df=2*length(pvalues_Pr_varied_primary_0.01), lower.tail=F)


pvalues_Pr_varied_primary_0.1 <- c(pvalue_Pr_varied_primary_0.1_1,pvalue_Pr_varied_primary_0.1_2,pvalue_Pr_varied_primary_0.1_3,pvalue_Pr_varied_primary_0.1_4,pvalue_Pr_varied_primary_0.1_5,pvalue_Pr_varied_primary_0.1_6,pvalue_Pr_varied_primary_0.1_7,pvalue_Pr_varied_primary_0.1_8,pvalue_Pr_varied_primary_0.1_9)
test.stat_Pr_varied_primary_0.1 <- -2*sum(log(pvalues_Pr_varied_primary_0.1))
pfinal_Pr_varied_primary_0.1<-pchisq(test.stat_Pr_varied_primary_0.1, df=2*length(pvalues_Pr_varied_primary_0.1), lower.tail=F)

pvalues_Pr_varied_primary_1.0 <- c(pvalue_Pr_varied_primary_1.0_1,pvalue_Pr_varied_primary_1.0_2,pvalue_Pr_varied_primary_1.0_3,pvalue_Pr_varied_primary_1.0_4,pvalue_Pr_varied_primary_1.0_5,pvalue_Pr_varied_primary_1.0_6,pvalue_Pr_varied_primary_1.0_7,pvalue_Pr_varied_primary_1.0_8,pvalue_Pr_varied_primary_1.0_9)
test.stat_Pr_varied_primary_1.0 <- -2*sum(log(pvalues_Pr_varied_primary_1.0))
pfinal_Pr_varied_primary_1.0<-pchisq(test.stat_Pr_varied_primary_1.0, df=2*length(pvalues_Pr_varied_primary_1.0), lower.tail=F)

pvalues_Pr_varied_primary_2.0 <- c(pvalue_Pr_varied_primary_2.0_1,pvalue_Pr_varied_primary_2.0_2,pvalue_Pr_varied_primary_2.0_3,pvalue_Pr_varied_primary_2.0_4,pvalue_Pr_varied_primary_2.0_5,pvalue_Pr_varied_primary_2.0_6,pvalue_Pr_varied_primary_2.0_8,pvalue_Pr_varied_primary_2.0_9)
test.stat_Pr_varied_primary_2.0 <- -2*sum(log(pvalues_Pr_varied_primary_2.0))
pfinal_Pr_varied_primary_2.0<-pchisq(test.stat_Pr_varied_primary_2.0, df=2*length(pvalues_Pr_varied_primary_2.0), lower.tail=F)


```


```{r}
pvalues_Pr_varied_primary_0.001_table <- c(pvalue_Pr_varied_primary_0.001_1, pvalue_Pr_varied_primary_0.001_2, pvalue_Pr_varied_primary_0.001_3, pvalue_Pr_varied_primary_0.001_4, pvalue_Pr_varied_primary_0.001_5, pvalue_Pr_varied_primary_0.001_6, pvalue_Pr_varied_primary_0.001_7, pvalue_Pr_varied_primary_0.001_8, pvalue_Pr_varied_primary_0.001_9)
p_Pr_varied_primary_0.001<-scales::pvalue(pvalues_Pr_varied_primary_0.001_table)

pvalues_Pr_varied_primary_0.01_table <- c(pvalue_Pr_varied_primary_0.01_1,pvalue_Pr_varied_primary_0.01_2,pvalue_Pr_varied_primary_0.01_3,pvalue_Pr_varied_primary_0.01_4,pvalue_Pr_varied_primary_0.01_5,pvalue_Pr_varied_primary_0.01_6,pvalue_Pr_varied_primary_0.01_7,pvalue_Pr_varied_primary_0.01_8,pvalue_Pr_varied_primary_0.01_9)
p_Pr_varied_primary_0.01<-scales::pvalue(pvalues_Pr_varied_primary_0.01_table)

pvalues_Pr_varied_primary_0.1_table <- c(pvalue_Pr_varied_primary_0.1_1,pvalue_Pr_varied_primary_0.1_2, pvalue_Pr_varied_primary_0.1_3, pvalue_Pr_varied_primary_0.1_4, pvalue_Pr_varied_primary_0.1_5, pvalue_Pr_varied_primary_0.1_6, pvalue_Pr_varied_primary_0.1_7, pvalue_Pr_varied_primary_0.1_8, pvalue_Pr_varied_primary_0.1_9)
p_Pr_varied_primary_0.1<-scales::pvalue(pvalues_Pr_varied_primary_0.1_table)

pvalues_Pr_varied_primary_1.0_table <- c(pvalue_Pr_varied_primary_1.0_1,pvalue_Pr_varied_primary_1.0_2, pvalue_Pr_varied_primary_1.0_3, pvalue_Pr_varied_primary_1.0_4, pvalue_Pr_varied_primary_1.0_5, pvalue_Pr_varied_primary_1.0_6, pvalue_Pr_varied_primary_1.0_7, pvalue_Pr_varied_primary_1.0_8, pvalue_Pr_varied_primary_1.0_9)
p_Pr_varied_primary_1.0<-scales::pvalue(pvalues_Pr_varied_primary_1.0_table)

pvalues_Pr_varied_primary_2.0_table <- c(pvalue_Pr_varied_primary_2.0_1,pvalue_Pr_varied_primary_2.0_2, pvalue_Pr_varied_primary_2.0_3, pvalue_Pr_varied_primary_2.0_4, pvalue_Pr_varied_primary_2.0_5, pvalue_Pr_varied_primary_2.0_6, NA, pvalue_Pr_varied_primary_2.0_8, pvalue_Pr_varied_primary_2.0_9)
p_Pr_varied_primary_2.0<-scales::pvalue(pvalues_Pr_varied_primary_2.0_table)
p_Pr_varied_primary_2.0 <- p_Pr_varied_primary_2.0 %>% replace_na("--")


pvalue_table_Pr_varied_primary <- data.frame("0.001" = p_Pr_varied_primary_0.001, "0.01" = p_Pr_varied_primary_0.01, "0.1" = p_Pr_varied_primary_0.1, "1.0" = p_Pr_varied_primary_1.0, "2.0" = p_Pr_varied_primary_2.0)
colnames(pvalue_table_Pr_varied_primary) <- c(0.001,0.01, 0.1, 1.0,2.0)

pfisher_Pr_varied_primary<- c(pfinal_Pr_varied_primary_0.001, pfinal_Pr_varied_primary_0.01, pfinal_Pr_varied_primary_0.1, pfinal_Pr_varied_primary_1.0, NA)
pfisher_Pr_varied_primary<-scales::pvalue(pfisher_Pr_varied_primary)
pfisher_Pr_varied_primary<- pfisher_Pr_varied_primary%>% replace_na("N.C.")
pvalue_table_Pr_varied_primary[nrow(pvalue_table_Pr_varied_primary) + 1,]<-pfisher_Pr_varied_primary

row.names(pvalue_table_Pr_varied_primary) <- c("Block 1 - October 18th, 2020", "Block 2 - October 20th, 2020", "Block 3 - October 29th, 2020","Block 4 - November 2nd, 2020", "Block 5 - November 7th, 2020", "Block 6 - November 28th, 2020","Block 7 - December 4th, 2020", "Block 8 - June 17th, 2021", "Block 9 - June 18th, 2021", " Final P-value ")

pvalue_table_Pr_varied_primary %>%
  kbl(caption = "<center><strong>P-values for log-rank tests on individual doses within each experiment<center><strong>") %>%
   kable_classic(full_width = F, html_font = "Cambria", position = "center")%>%
    add_header_above(c(" "=1, "Primary Infectious Dose (Abs600nm)" = 5)) %>%
    pack_rows("Individual Blocks", 1, 9) %>%
    pack_rows("Fisher's Combined", 10, 10)



```
  + **Conclusion**: Moderate doses of the primary infection (Abs600nm = 0.01, 0.1 & 1.0) all provided significant protection against infection (P<0.001). The lowest dose (Abs600nm = 0.001) did not provide significant protection (p=0.76). The highest dose provided inconsistent protection with 8 out of the 9 replicates demonstrating better survival than controls and one with worse survival than controls therefore we could not calculate a combine p-value. 

## *P. sneebia* secondary infection {.tabset}
   + **Conclusion**: All doses used to induce primary infection provided significant protection (P < 0.001), except for the lowest dose (Abs600nm = 0.261). Note: the highest primary dose provided inconsistent protection (4 out of 5 blocks had significant protection for all others, for Block 1 the mortality was the same as flies carrying only secondary infection) 


### Figure 5B
```{r, S.m-P.snee varied primary survival data}
Ps_varied_primary <- subset(Ps_varied_primary, secondary == "P.snee")
table(Ps_varied_primary$date, Ps_varied_primary$primary_dose)
table(Ps_varied_primary$primary_dose)

#png(file="Figure5B.png",  width = 1200, height = 900, res = 130)
par(mar=c(6,5,1,1)) #sets the margins around the graph so there is room for the labels
plot(survfit(Surv(Ps_varied_primary$hour, Ps_varied_primary$status) ~ Ps_varied_primary$condition), col=c("gray", "#B5E8FC", "#75D6FD", "#09B6FC", "#055df5", "#003694"), lty=c(1, 1, 1, 1, 1, 1), lwd=5, yaxt='n', xaxt='n', ylab="proportion alive", xlab="hours post-secondary infection", cex.lab=2.5, xlim=c(0,48), xaxs='i', ylim=c(0, 1), yaxs='i')
axis(2, las=2, cex.axis=1.5, lwd=5)
axis(1, cex.axis=1.5, lwd=5)
box(lwd=5)

legend("bottomleft", bty="n" , c("secondary infection only", "chronic (0.001) & secondary infection", "chronic (0.01) & secondary infection", "chronic (0.1) & secondary infection", "chronic (1.0) & secondary infection", "chronic (2.0) & secondary infection"),col=c("gray", "#B5E8FC", "#75D6FD", "#09B6FC", "#055df5", "#003694"),lty=c(1, 1, 1, 1, 1, 1),lwd=5, cex=1.5)
#dev.off()
```

### Individual Blocks {.tabset}
#### Block 1
```{r, P.snee varied primary 3/10/2021}
Ps_varied_primary_block_1 <- subset(Ps_varied_primary, date == "3/10/2021")
table(Ps_varied_primary_block_1$primary_dose)

#subset by primary dose for pairwise comparison dose
Ps_varied_primary_0.001_1<-subset(Ps_varied_primary_block_1, primary_dose == "0.001"|primary_dose=="0")
table(Ps_varied_primary_0.001_1$primary_dose)
Ps_varied_primary_0.01_1<-subset(Ps_varied_primary_block_1, primary_dose=="0.01"|primary_dose=="0")
Ps_varied_primary_0.1_1<-subset(Ps_varied_primary_block_1, primary_dose=="0.1"|primary_dose=="0")
Ps_varied_primary_1.0_1<-subset(Ps_varied_primary_block_1, primary_dose=="1"|primary_dose=="0")
Ps_varied_primary_2.0_1<-subset(Ps_varied_primary_block_1, primary_dose=="2"|primary_dose=="0")

surv_Ps_varied_primary_0.001_1<-survdiff(Surv(day, status) ~ primary, data=Ps_varied_primary_0.001_1)
surv_Ps_varied_primary_0.001_1

surv_Ps_varied_primary_0.01_1<-survdiff(Surv(day, status) ~ primary, data=Ps_varied_primary_0.01_1)
surv_Ps_varied_primary_0.01_1

surv_Ps_varied_primary_0.1_1<-survdiff(Surv(day, status) ~ primary, data=Ps_varied_primary_0.1_1)
surv_Ps_varied_primary_0.1_1

surv_Ps_varied_primary_1.0_1<-survdiff(Surv(day, status) ~ primary, data=Ps_varied_primary_1.0_1)
surv_Ps_varied_primary_1.0_1

surv_Ps_varied_primary_2.0_1<-survdiff(Surv(day, status) ~ primary, data=Ps_varied_primary_2.0_1)
surv_Ps_varied_primary_2.0_1


plot(survfit(Surv(Ps_varied_primary_block_1$hour, Ps_varied_primary_block_1$status) ~ Ps_varied_primary_block_1$condition), col=c("gray", "#B5E8FC", "#75D6FD", "#09B6FC", "#055df5", "#003694"), lty=c(1, 1, 1, 1, 1, 1), lwd=3.4, yaxt='n', xaxt='n', ylab="Proportion Alive", xlab="Hours Post-Secondary Infection", cex.lab=1.3, xlim=c(10,48), xaxs='i', ylim=c(0, 1.05), yaxs='i')
axis(2, las=2, cex.axis=1, lwd=4.5)
axis(1, cex.axis=1, lwd=4.5)
box(lwd=4.5)

legend("bottomleft", bty="n" , c("PBS-P.snee 2.0", "S.m 0.001-P.snee 2.0", "S.m 0.01-P.snee 2.0", "S.m 0.1-P.snee 2.0", "S.m 1.0-P.snee 2.0", "S.m 2.0-P.snee 2.0"),col=c("gray", "#B5E8FC", "#75D6FD", "#09B6FC", "#055df5", "#003694"),lty=c(1, 1, 1, 1, 1, 1),lwd=5, cex=1)
```

#### Block 2
```{r, P.snee varied primary 3/17/2021}
Ps_varied_primary_block_2 <- subset(Ps_varied_primary, date == "3/17/2021")
table(Ps_varied_primary_block_2$primary_dose)

#subset by primary dose for pairwise comparison dose
Ps_varied_primary_0.001_2<-subset(Ps_varied_primary_block_2, primary_dose == "0.001"|primary_dose=="0")
table(Ps_varied_primary_0.001_2$primary_dose)
Ps_varied_primary_0.01_2<-subset(Ps_varied_primary_block_2, primary_dose=="0.01"|primary_dose=="0")
Ps_varied_primary_0.1_2<-subset(Ps_varied_primary_block_2, primary_dose=="0.1"|primary_dose=="0")
Ps_varied_primary_1.0_2<-subset(Ps_varied_primary_block_2, primary_dose=="1"|primary_dose=="0")
#Ps_varied_primary_2.0_2<-subset(Ps_varied_primary_block_2, primary_dose=="2"|primary_dose=="0")

surv_Ps_varied_primary_0.001_2<-survdiff(Surv(day, status) ~ primary, data=Ps_varied_primary_0.001_2)
surv_Ps_varied_primary_0.001_2

surv_Ps_varied_primary_0.01_2<-survdiff(Surv(day, status) ~ primary, data=Ps_varied_primary_0.01_2)
surv_Ps_varied_primary_0.01_2

surv_Ps_varied_primary_0.1_2<-survdiff(Surv(day, status) ~ primary, data=Ps_varied_primary_0.1_2)
surv_Ps_varied_primary_0.1_2

surv_Ps_varied_primary_1.0_2<-survdiff(Surv(day, status) ~ primary, data=Ps_varied_primary_1.0_2)
surv_Ps_varied_primary_1.0_2

#surv_Ps_varied_primary_2.0_2<-survdiff(Surv(day, status) ~ primary, data=Ps_varied_primary_2.0_2)
#surv_Ps_varied_primary_2.0_2

plot(survfit(Surv(Ps_varied_primary_block_2$hour, Ps_varied_primary_block_2$status) ~ Ps_varied_primary_block_2$condition), col=c("gray", "#B5E8FC", "#75D6FD", "#09B6FC", "#055df5", "#003694"), lty=c(1, 1, 1, 1, 1, 1), lwd=3.4, yaxt='n', xaxt='n', ylab="Proportion Alive", xlab="Hours Post-Secondary Infection", cex.lab=1.3, xlim=c(10,48), xaxs='i', ylim=c(0, 1.05), yaxs='i')
axis(2, las=2, cex.axis=1, lwd=4.5)
axis(1, cex.axis=1, lwd=4.5)
box(lwd=4.5)

legend("bottomleft", bty="n" , c("PBS-P.snee 2.0", "S.m 0.001-P.snee 2.0", "S.m 0.01-P.snee 2.0", "S.m 0.1-P.snee 2.0", "S.m 1.0-P.snee 2.0", "S.m 2.0-P.snee 2.0"),col=c("gray", "#B5E8FC", "#75D6FD", "#09B6FC", "#055df5", "#003694"),lty=c(1, 1, 1, 1, 1, 1),lwd=5, cex=1)
```

#### Block 3
```{r, P.snee varied primary 3/31/2021}
Ps_varied_primary_block_3 <- subset(Ps_varied_primary, date == "3/31/2021")
table(Ps_varied_primary_block_3$primary_dose)

#subset by primary dose for pairwise comparison dose
Ps_varied_primary_0.001_3<-subset(Ps_varied_primary_block_3, primary_dose == "0.001"|primary_dose=="0")
table(Ps_varied_primary_0.001_3$primary_dose)
Ps_varied_primary_0.01_3<-subset(Ps_varied_primary_block_3, primary_dose=="0.01"|primary_dose=="0")
Ps_varied_primary_0.1_3<-subset(Ps_varied_primary_block_3, primary_dose=="0.1"|primary_dose=="0")
Ps_varied_primary_1.0_3<-subset(Ps_varied_primary_block_3, primary_dose=="1"|primary_dose=="0")
Ps_varied_primary_2.0_3<-subset(Ps_varied_primary_block_3, primary_dose=="2"|primary_dose=="0")

surv_Ps_varied_primary_0.001_3<-survdiff(Surv(day, status) ~ primary, data=Ps_varied_primary_0.001_3)
surv_Ps_varied_primary_0.001_3

surv_Ps_varied_primary_0.01_3<-survdiff(Surv(day, status) ~ primary, data=Ps_varied_primary_0.01_3)
surv_Ps_varied_primary_0.01_3

surv_Ps_varied_primary_0.1_3<-survdiff(Surv(day, status) ~ primary, data=Ps_varied_primary_0.1_3)
surv_Ps_varied_primary_0.1_3

surv_Ps_varied_primary_1.0_3<-survdiff(Surv(day, status) ~ primary, data=Ps_varied_primary_1.0_3)
surv_Ps_varied_primary_1.0_3

surv_Ps_varied_primary_2.0_3<-survdiff(Surv(day, status) ~ primary, data=Ps_varied_primary_2.0_3)
surv_Ps_varied_primary_2.0_3

plot(survfit(Surv(Ps_varied_primary_block_3$hour, Ps_varied_primary_block_3$status) ~ Ps_varied_primary_block_3$condition), col=c("gray", "#B5E8FC", "#75D6FD", "#09B6FC", "#055df5", "#003694"), lty=c(1, 1, 1, 1, 1, 1), lwd=3.4, yaxt='n', xaxt='n', ylab="Proportion Alive", xlab="Hours Post-Secondary Infection", cex.lab=1.3, xlim=c(10,48), xaxs='i', ylim=c(0, 1.05), yaxs='i')
axis(2, las=2, cex.axis=1, lwd=4.5)
axis(1, cex.axis=1, lwd=4.5)
box(lwd=4.5)

legend("bottomleft", bty="n" , c("PBS-P.snee 2.0", "S.m 0.001-P.snee 2.0", "S.m 0.01-P.snee 2.0", "S.m 0.1-P.snee 2.0", "S.m 1.0-P.snee 2.0", "S.m 2.0-P.snee 2.0"),col=c("gray", "#B5E8FC", "#75D6FD", "#09B6FC", "#055df5", "#003694"),lty=c(1, 1, 1, 1, 1, 1),lwd=5, cex=1)
```

#### Block 4
```{r, P.snee varied primary 4/21/2021}
Ps_varied_primary_block_4 <- subset(Ps_varied_primary, date == "4/21/2021")
table(Ps_varied_primary_block_4$primary_dose)

#subset by primary dose for pairwise comparison dose
Ps_varied_primary_0.001_4<-subset(Ps_varied_primary_block_4, primary_dose == "0.001"|primary_dose=="0")
table(Ps_varied_primary_0.001_4$primary_dose)
Ps_varied_primary_0.01_4<-subset(Ps_varied_primary_block_4, primary_dose=="0.01"|primary_dose=="0")
Ps_varied_primary_0.1_4<-subset(Ps_varied_primary_block_4, primary_dose=="0.1"|primary_dose=="0")
Ps_varied_primary_1.0_4<-subset(Ps_varied_primary_block_4, primary_dose=="1"|primary_dose=="0")
Ps_varied_primary_2.0_4<-subset(Ps_varied_primary_block_4, primary_dose=="2"|primary_dose=="0")

surv_Ps_varied_primary_0.001_4<-survdiff(Surv(day, status) ~ primary, data=Ps_varied_primary_0.001_4)
surv_Ps_varied_primary_0.001_4

surv_Ps_varied_primary_0.01_4<-survdiff(Surv(day, status) ~ primary, data=Ps_varied_primary_0.01_4)
surv_Ps_varied_primary_0.01_4

surv_Ps_varied_primary_0.1_4<-survdiff(Surv(day, status) ~ primary, data=Ps_varied_primary_0.1_4)
surv_Ps_varied_primary_0.1_4

surv_Ps_varied_primary_1.0_4<-survdiff(Surv(day, status) ~ primary, data=Ps_varied_primary_1.0_4)
surv_Ps_varied_primary_1.0_4

surv_Ps_varied_primary_2.0_4<-survdiff(Surv(day, status) ~ primary, data=Ps_varied_primary_2.0_4)
surv_Ps_varied_primary_2.0_4

plot(survfit(Surv(Ps_varied_primary_block_4$hour, Ps_varied_primary_block_4$status) ~ Ps_varied_primary_block_4$condition), col=c("gray", "#B5E8FC", "#75D6FD", "#09B6FC", "#055df5", "#003694"), lty=c(1, 1, 1, 1, 1, 1), lwd=3.4, yaxt='n', xaxt='n', ylab="Proportion Alive", xlab="Hours Post-Secondary Infection", cex.lab=1.3, xlim=c(10,48), xaxs='i', ylim=c(0, 1.05), yaxs='i')
axis(2, las=2, cex.axis=1, lwd=4.5)
axis(1, cex.axis=1, lwd=4.5)
box(lwd=4.5)

legend("bottomleft", bty="n" , c("PBS-P.snee 2.0", "S.m 0.001-P.snee 2.0", "S.m 0.01-P.snee 2.0", "S.m 0.1-P.snee 2.0", "S.m 1.0-P.snee 2.0", "S.m 2.0-P.snee 2.0"),col=c("gray", "#B5E8FC", "#75D6FD", "#09B6FC", "#055df5", "#003694"),lty=c(1, 1, 1, 1, 1, 1),lwd=5, cex=1)
```

#### Block 5
```{r, P.snee varied primary 4/28/2021}
Ps_varied_primary_block_5 <- subset(Ps_varied_primary, date == "4/28/2021")
table(Ps_varied_primary_block_5$primary_dose)

#subset by primary dose for pairwise comparison dose
Ps_varied_primary_0.001_5<-subset(Ps_varied_primary_block_5, primary_dose == "0.001"|primary_dose=="0")
table(Ps_varied_primary_0.001_5$primary_dose)
Ps_varied_primary_0.01_5<-subset(Ps_varied_primary_block_5, primary_dose=="0.01"|primary_dose=="0")
Ps_varied_primary_0.1_5<-subset(Ps_varied_primary_block_5, primary_dose=="0.1"|primary_dose=="0")
Ps_varied_primary_1.0_5<-subset(Ps_varied_primary_block_5, primary_dose=="1"|primary_dose=="0")
Ps_varied_primary_2.0_5<-subset(Ps_varied_primary_block_5, primary_dose=="2"|primary_dose=="0")

surv_Ps_varied_primary_0.001_5<-survdiff(Surv(day, status) ~ primary, data=Ps_varied_primary_0.001_5)
surv_Ps_varied_primary_0.001_5

surv_Ps_varied_primary_0.01_5<-survdiff(Surv(day, status) ~ primary, data=Ps_varied_primary_0.01_5)
surv_Ps_varied_primary_0.01_5

surv_Ps_varied_primary_0.1_5<-survdiff(Surv(day, status) ~ primary, data=Ps_varied_primary_0.1_5)
surv_Ps_varied_primary_0.1_5

surv_Ps_varied_primary_1.0_5<-survdiff(Surv(day, status) ~ primary, data=Ps_varied_primary_1.0_5)
surv_Ps_varied_primary_1.0_5

surv_Ps_varied_primary_2.0_5<-survdiff(Surv(day, status) ~ primary, data=Ps_varied_primary_2.0_5)
surv_Ps_varied_primary_2.0_5

plot(survfit(Surv(Ps_varied_primary_block_5$hour, Ps_varied_primary_block_5$status) ~ Ps_varied_primary_block_5$condition), col=c("gray", "#B5E8FC", "#75D6FD", "#09B6FC", "#055df5", "#003694"), lty=c(1, 1, 1, 1, 1, 1), lwd=3.4, yaxt='n', xaxt='n', ylab="Proportion Alive", xlab="Hours Post-Secondary Infection", cex.lab=1.3, xlim=c(10,48), xaxs='i', ylim=c(0, 1.05), yaxs='i')
axis(2, las=2, cex.axis=1, lwd=4.5)
axis(1, cex.axis=1, lwd=4.5)
box(lwd=4.5)

legend("bottomleft", bty="n" , c("PBS-P.snee 2.0", "S.m 0.001-P.snee 2.0", "S.m 0.01-P.snee 2.0", "S.m 0.1-P.snee 2.0", "S.m 1.0-P.snee 2.0", "S.m 2.0-P.snee 2.0"),col=c("gray", "#B5E8FC", "#75D6FD", "#09B6FC", "#055df5", "#003694"),lty=c(1, 1, 1, 1, 1, 1),lwd=5, cex=1)
```

#### Block 6
```{r, P.snee varied primary 6/20/2021}
Ps_varied_primary_block_6 <- subset(Ps_varied_primary, date == "6/20/2021")
table(Ps_varied_primary_block_6$primary_dose)

#subset by primary dose for pairwise comparison dose
Ps_varied_primary_0.001_6<-subset(Ps_varied_primary_block_6, primary_dose == "0.001"|primary_dose=="0")
table(Ps_varied_primary_0.001_6$primary_dose)
Ps_varied_primary_0.01_6<-subset(Ps_varied_primary_block_6, primary_dose=="0.01"|primary_dose=="0")
Ps_varied_primary_0.1_6<-subset(Ps_varied_primary_block_6, primary_dose=="0.1"|primary_dose=="0")
Ps_varied_primary_1.0_6<-subset(Ps_varied_primary_block_6, primary_dose=="1"|primary_dose=="0")
Ps_varied_primary_2.0_6<-subset(Ps_varied_primary_block_6, primary_dose=="2"|primary_dose=="0")

surv_Ps_varied_primary_0.001_6<-survdiff(Surv(day, status) ~ primary, data=Ps_varied_primary_0.001_6)
surv_Ps_varied_primary_0.001_6

surv_Ps_varied_primary_0.01_6<-survdiff(Surv(day, status) ~ primary, data=Ps_varied_primary_0.01_6)
surv_Ps_varied_primary_0.01_6

surv_Ps_varied_primary_0.1_6<-survdiff(Surv(day, status) ~ primary, data=Ps_varied_primary_0.1_6)
surv_Ps_varied_primary_0.1_6

surv_Ps_varied_primary_1.0_6<-survdiff(Surv(day, status) ~ primary, data=Ps_varied_primary_1.0_6)
surv_Ps_varied_primary_1.0_6

surv_Ps_varied_primary_2.0_6<-survdiff(Surv(day, status) ~ primary, data=Ps_varied_primary_2.0_6)
surv_Ps_varied_primary_2.0_6

plot(survfit(Surv(Ps_varied_primary_block_6$hour, Ps_varied_primary_block_6$status) ~ Ps_varied_primary_block_6$condition), col=c("gray", "#B5E8FC", "#75D6FD", "#09B6FC", "#055df5", "#003694"), lty=c(1, 1, 1, 1, 1, 1), lwd=3.4, yaxt='n', xaxt='n', ylab="Proportion Alive", xlab="Hours Post-Secondary Infection", cex.lab=1.3, xlim=c(10,48), xaxs='i', ylim=c(0, 1.05), yaxs='i')
axis(2, las=2, cex.axis=1, lwd=4.5)
axis(1, cex.axis=1, lwd=4.5)
box(lwd=4.5)

legend("bottomleft", bty="n" , c("PBS-P.snee 2.0", "S.m 0.001-P.snee 2.0", "S.m 0.01-P.snee 2.0", "S.m 0.1-P.snee 2.0", "S.m 1.0-P.snee 2.0", "S.m 2.0-P.snee 2.0"),col=c("gray", "#B5E8FC", "#75D6FD", "#09B6FC", "#055df5", "#003694"),lty=c(1, 1, 1, 1, 1, 1),lwd=5, cex=1)
```


### Statistical Tests

  + In order test whether there was protection provided by chronic infection for each secondary infectious dose, p-values from the log rank test for each date was combined using the Fisher’s test (experiments on all dates showed higher survival in conditions with chronic infection). Final p-value is reported in the text.


```{r}

# Grab p-values from each individual logrank test (results shown above in each block)
pvalue_Ps_varied_primary_0.001_1<-pchisq(surv_Ps_varied_primary_0.001_1$chisq, df=1, lower.tail=F)
pvalue_Ps_varied_primary_0.01_1<-pchisq(surv_Ps_varied_primary_0.01_1$chisq, df=1, lower.tail=F)
pvalue_Ps_varied_primary_0.1_1<-pchisq(surv_Ps_varied_primary_0.1_1$chisq, df=1, lower.tail=F)
pvalue_Ps_varied_primary_1.0_1<-pchisq(surv_Ps_varied_primary_1.0_1$chisq, df=1, lower.tail=F)
pvalue_Ps_varied_primary_2.0_1<-pchisq(surv_Ps_varied_primary_2.0_1$chisq, df=1, lower.tail=F)

pvalue_Ps_varied_primary_0.001_2<-pchisq(surv_Ps_varied_primary_0.001_2$chisq, df=1, lower.tail=F)
pvalue_Ps_varied_primary_0.01_2<-pchisq(surv_Ps_varied_primary_0.01_2$chisq, df=1, lower.tail=F)
pvalue_Ps_varied_primary_0.1_2<-pchisq(surv_Ps_varied_primary_0.1_2$chisq, df=1, lower.tail=F)
pvalue_Ps_varied_primary_1.0_2<-pchisq(surv_Ps_varied_primary_1.0_2$chisq, df=1, lower.tail=F)
#pvalue_Ps_varied_primary_2.0_2<-pchisq(surv_Ps_varied_primary_2.0_2$chisq, df=1, lower.tail=F)

pvalue_Ps_varied_primary_0.001_3<-pchisq(surv_Ps_varied_primary_0.001_3$chisq, df=1, lower.tail=F)
pvalue_Ps_varied_primary_0.01_3<-pchisq(surv_Ps_varied_primary_0.01_3$chisq, df=1, lower.tail=F)
pvalue_Ps_varied_primary_0.1_3<-pchisq(surv_Ps_varied_primary_0.1_3$chisq, df=1, lower.tail=F)
pvalue_Ps_varied_primary_1.0_3<-pchisq(surv_Ps_varied_primary_1.0_3$chisq, df=1, lower.tail=F)
pvalue_Ps_varied_primary_2.0_3<-pchisq(surv_Ps_varied_primary_2.0_3$chisq, df=1, lower.tail=F)

pvalue_Ps_varied_primary_0.001_4<-pchisq(surv_Ps_varied_primary_0.001_4$chisq, df=1, lower.tail=F)
pvalue_Ps_varied_primary_0.01_4<-pchisq(surv_Ps_varied_primary_0.01_4$chisq, df=1, lower.tail=F)
pvalue_Ps_varied_primary_0.1_4<-pchisq(surv_Ps_varied_primary_0.1_4$chisq, df=1, lower.tail=F)
pvalue_Ps_varied_primary_1.0_4<-pchisq(surv_Ps_varied_primary_1.0_4$chisq, df=1, lower.tail=F)
pvalue_Ps_varied_primary_2.0_4<-pchisq(surv_Ps_varied_primary_2.0_4$chisq, df=1, lower.tail=F)

pvalue_Ps_varied_primary_0.001_5<-pchisq(surv_Ps_varied_primary_0.001_5$chisq, df=1, lower.tail=F)
pvalue_Ps_varied_primary_0.01_5<-pchisq(surv_Ps_varied_primary_0.01_5$chisq, df=1, lower.tail=F)
pvalue_Ps_varied_primary_0.1_5<-pchisq(surv_Ps_varied_primary_0.1_5$chisq, df=1, lower.tail=F)
pvalue_Ps_varied_primary_1.0_5<-pchisq(surv_Ps_varied_primary_1.0_5$chisq, df=1, lower.tail=F)
pvalue_Ps_varied_primary_2.0_5<-pchisq(surv_Ps_varied_primary_2.0_5$chisq, df=1, lower.tail=F)

pvalue_Ps_varied_primary_0.001_6<-pchisq(surv_Ps_varied_primary_0.001_6$chisq, df=1, lower.tail=F)
pvalue_Ps_varied_primary_0.01_6<-pchisq(surv_Ps_varied_primary_0.01_6$chisq, df=1, lower.tail=F)
pvalue_Ps_varied_primary_0.1_6<-pchisq(surv_Ps_varied_primary_0.1_6$chisq, df=1, lower.tail=F)
pvalue_Ps_varied_primary_1.0_6<-pchisq(surv_Ps_varied_primary_1.0_6$chisq, df=1, lower.tail=F)
pvalue_Ps_varied_primary_2.0_6<-pchisq(surv_Ps_varied_primary_2.0_6$chisq, df=1, lower.tail=F)

```


```{r}
# Use all p-values from a given condition to get Fisher's combined test p-value
pvalues_Ps_varied_primary_0.001 <- c(pvalue_Ps_varied_primary_0.001_2 ,pvalue_Ps_varied_primary_0.001_3, pvalue_Ps_varied_primary_0.001_4, pvalue_Ps_varied_primary_0.001_5, pvalue_Ps_varied_primary_0.001_6)
test.stat_Ps_varied_primary_0.001 <- -2*sum(log(pvalues_Ps_varied_primary_0.001))
pfinal_Ps_varied_primary_0.001<-pchisq(test.stat_Ps_varied_primary_0.001, df=2*length(pvalues_Ps_varied_primary_0.001), lower.tail=F)

pvalues_Ps_varied_primary_0.01 <- c(pvalue_Ps_varied_primary_0.01_1,pvalue_Ps_varied_primary_0.01_2,pvalue_Ps_varied_primary_0.01_3,pvalue_Ps_varied_primary_0.01_4,pvalue_Ps_varied_primary_0.01_5,pvalue_Ps_varied_primary_0.01_6)
test.stat_Ps_varied_primary_0.01 <- -2*sum(log(pvalues_Ps_varied_primary_0.01))
pfinal_Ps_varied_primary_0.01<-pchisq(test.stat_Ps_varied_primary_0.01, df=2*length(pvalues_Ps_varied_primary_0.01), lower.tail=F)


pvalues_Ps_varied_primary_0.1 <- c(pvalue_Ps_varied_primary_0.1_1,pvalue_Ps_varied_primary_0.1_2,pvalue_Ps_varied_primary_0.1_3,pvalue_Ps_varied_primary_0.1_4,pvalue_Ps_varied_primary_0.1_5,pvalue_Ps_varied_primary_0.1_6)
test.stat_Ps_varied_primary_0.1 <- -2*sum(log(pvalues_Ps_varied_primary_0.1))
pfinal_Ps_varied_primary_0.1<-pchisq(test.stat_Ps_varied_primary_0.1, df=2*length(pvalues_Ps_varied_primary_0.1), lower.tail=F)

pvalues_Ps_varied_primary_1.0 <- c(pvalue_Ps_varied_primary_1.0_1,pvalue_Ps_varied_primary_1.0_2,pvalue_Ps_varied_primary_1.0_3,pvalue_Ps_varied_primary_1.0_4,pvalue_Ps_varied_primary_1.0_5,pvalue_Ps_varied_primary_1.0_6)
test.stat_Ps_varied_primary_1.0 <- -2*sum(log(pvalues_Ps_varied_primary_1.0))
pfinal_Ps_varied_primary_1.0<-pchisq(test.stat_Ps_varied_primary_1.0, df=2*length(pvalues_Ps_varied_primary_1.0), lower.tail=F)

pvalues_Ps_varied_primary_2.0 <- c(pvalue_Ps_varied_primary_2.0_1,pvalue_Ps_varied_primary_2.0_3,pvalue_Ps_varied_primary_2.0_4,pvalue_Ps_varied_primary_2.0_5,pvalue_Ps_varied_primary_2.0_6)
test.stat_Ps_varied_primary_2.0 <- -2*sum(log(pvalues_Ps_varied_primary_2.0))
pfinal_Ps_varied_primary_2.0<-pchisq(test.stat_Ps_varied_primary_2.0, df=2*length(pvalues_Ps_varied_primary_2.0), lower.tail=F)


```


```{r}
pvalues_Ps_varied_primary_0.001_table <- c(pvalue_Ps_varied_primary_0.001_1, pvalue_Ps_varied_primary_0.001_2, pvalue_Ps_varied_primary_0.001_3, pvalue_Ps_varied_primary_0.001_4, pvalue_Ps_varied_primary_0.001_5, pvalue_Ps_varied_primary_0.001_6)
p_Ps_varied_primary_0.001<-scales::pvalue(pvalues_Ps_varied_primary_0.001_table)

pvalues_Ps_varied_primary_0.01_table <- c(pvalue_Ps_varied_primary_0.01_1,pvalue_Ps_varied_primary_0.01_2,pvalue_Ps_varied_primary_0.01_3,pvalue_Ps_varied_primary_0.01_4,pvalue_Ps_varied_primary_0.01_5,pvalue_Ps_varied_primary_0.01_6)
p_Ps_varied_primary_0.01<-scales::pvalue(pvalues_Ps_varied_primary_0.01_table)

pvalues_Ps_varied_primary_0.1_table <- c(pvalue_Ps_varied_primary_0.1_1,pvalue_Ps_varied_primary_0.1_2, pvalue_Ps_varied_primary_0.1_3, pvalue_Ps_varied_primary_0.1_4, pvalue_Ps_varied_primary_0.1_5, pvalue_Ps_varied_primary_0.1_6)
p_Ps_varied_primary_0.1<-scales::pvalue(pvalues_Ps_varied_primary_0.1_table)

pvalues_Ps_varied_primary_1.0_table <- c(pvalue_Ps_varied_primary_1.0_1,pvalue_Ps_varied_primary_1.0_2, pvalue_Ps_varied_primary_1.0_3, pvalue_Ps_varied_primary_1.0_4, pvalue_Ps_varied_primary_1.0_5, pvalue_Ps_varied_primary_1.0_6)
p_Ps_varied_primary_1.0<-scales::pvalue(pvalues_Ps_varied_primary_1.0_table)

pvalues_Ps_varied_primary_2.0_table <- c(pvalue_Ps_varied_primary_2.0_1,NA, pvalue_Ps_varied_primary_2.0_3, pvalue_Ps_varied_primary_2.0_4, pvalue_Ps_varied_primary_2.0_5, pvalue_Ps_varied_primary_2.0_6)
p_Ps_varied_primary_2.0<-scales::pvalue(pvalues_Ps_varied_primary_2.0_table)
p_Ps_varied_primary_2.0 <- p_Ps_varied_primary_2.0 %>% replace_na("--")




pvalue_table_Ps_varied_primary <- data.frame("0.001" = p_Ps_varied_primary_0.001, "0.01" = p_Ps_varied_primary_0.01, "0.1" = p_Ps_varied_primary_0.1, "1.0" = p_Ps_varied_primary_1.0, "2.0" = p_Ps_varied_primary_2.0)
colnames(pvalue_table_Ps_varied_primary) <- c(0.001,0.01, 0.1, 1.0,2.0)

pfisher_Ps_varied_primary<- c(pfinal_Ps_varied_primary_0.001, pfinal_Ps_varied_primary_0.01, pfinal_Ps_varied_primary_0.1, pfinal_Ps_varied_primary_1.0, pfinal_Ps_varied_primary_2.0)
pfisher_Ps_varied_primary<-scales::pvalue(pfisher_Ps_varied_primary)
pvalue_table_Ps_varied_primary[nrow(pvalue_table_Ps_varied_primary) + 1,]<-pfisher_Ps_varied_primary

row.names(pvalue_table_Ps_varied_primary) <- c("Block 1 - March 10th, 2021", "Block 2 - March 17th, 2021", "Block 3 - March 31st, 2021","Block 4 - April 21t, 2021", "Block 5 - April 28th, 2021", "Block 6 - June 20th, 2021", " Final P-value ")

pvalue_table_Ps_varied_primary %>%
  kbl(caption = "<center><strong>P-values for log-rank tests on individual doses within each experiment<center><strong>") %>%
   kable_classic(full_width = F, html_font = "Cambria", position = "center")%>%
    add_header_above(c(" "=1, "Primary Infectious Dose (Abs600nm)" = 5)) %>%
    pack_rows("Individual Blocks", 1, 6) %>%
    pack_rows("Fisher's Combined", 7, 7)

```
  + **Conclusion**: All doses used to induce primary infection provided significant protection (P < 0.001), except for the lowest dose (Abs600nm = 0.01)

## Figure 5
```{r Figure 5, message = FALSE}
q <- ggdraw() +
  draw_image("Figure5A.png")

r <- ggdraw() +
  draw_image("Figure5B.png")


multiplot5 <- q/r

v<-multiplot5 
 
  #plot_annotation(tag_levels = 'A')
 
ggsave("Fig.5.Primary.pdf", v, device = "pdf")
v
 

```